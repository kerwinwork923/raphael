<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºå¹³è¡¡ï½œå—…è¦º Ã— æ­£å¿µå‘¼å¸ Ã— ç¥ç¶“ä¿®å¾©ç·´ç¿’</title>
  <style>
    :root {
      --deep:#0f3b3b;
      --gold:#c9a14a;
      --muted:#6b7280;
      --ink:#1f2a37;
      --bg:#ffffff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body {
      font-family:"PingFang TC","Microsoft JhengHei",system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.8;
    }
    header {
      text-align:center;
      padding:32px 16px 10px;
    }
    header h1 {
      font-size:clamp(26px,4vw,38px);
      font-weight:800;
      color:var(--deep);
      letter-spacing:1px;
    }
    header p {
      max-width:800px;
      margin:10px auto 0;
      color:var(--muted);
      font-size:15px;
    }
    header .accent {
      width:140px;
      height:3px;
      background:var(--gold);
      margin:18px auto 0;
      border-radius:2px;
    }

    .page-wrap {
      max-width:1080px;
      margin:0 auto 60px;
      padding:0 16px;
    }

    .intro-card {
      margin-top:24px;
      padding:20px 22px;
      border-radius:18px;
      border:1px solid rgba(201,161,74,.35);
      box-shadow:0 10px 30px rgba(15,59,59,0.08);
      background:#fff;
    }
    .intro-card h2 {
      font-size:20px;
      color:var(--deep);
      margin-bottom:6px;
      font-weight:800;
    }
    .intro-card p {
      font-size:15px;
      color:var(--muted);
      margin-bottom:4px;
    }
    .intro-card ul {
      margin:8px 0 0 18px;
      color:var(--muted);
      font-size:14px;
    }
    .intro-card li { margin-bottom:4px; }

    .mode-switch {
      margin-top:26px;
      display:flex;
      justify-content:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .mode-btn {
      padding:10px 22px;
      border-radius:999px;
      border:1px solid rgba(201,161,74,.6);
      background:#fff;
      color:var(--deep);
      font-weight:800;
      font-size:14px;
      cursor:pointer;
      transition:.2s;
    }
    .mode-btn.active {
      background:var(--gold);
      color:#fff;
      box-shadow:0 8px 22px rgba(201,161,74,.45);
    }
    .mode-btn:hover { transform:translateY(-1px); }

    .panel {
      margin-top:24px;
      border-radius:18px;
      border:1px solid rgba(201,161,74,.35);
      box-shadow:0 12px 34px rgba(17,24,39,.06);
      background:#fff;
      padding:22px 22px 26px;
      display:none;
    }
    .panel.active { display:block; }

    .panel-header h3 {
      font-size:20px;
      color:var(--deep);
      font-weight:800;
      margin-bottom:4px;
    }
    .panel-header p {
      font-size:14px;
      color:var(--muted);
      margin-bottom:10px;
    }

    .video-wrap {
      margin-top:10px;
      border-radius:16px;
      overflow:hidden;
      box-shadow:0 8px 28px rgba(0,0,0,0.14);
    }
    .video-wrap iframe {
      width:100%;
      aspect-ratio:16/9;
      border:0;
      display:block;
    }

    .two-col {
      margin-top:18px;
      display:grid;
      grid-template-columns:minmax(0,1.6fr) minmax(0,1.2fr);
      gap:18px;
    }
    @media (max-width:768px){
      .two-col { grid-template-columns:1fr; }
    }

    .bullet-box {
      padding:14px 16px;
      border-radius:14px;
      border:1px dashed rgba(201,161,74,.6);
      background:rgba(201,161,74,.03);
      font-size:14px;
      color:var(--muted);
    }
    .bullet-box h4 {
      font-size:15px;
      color:var(--deep);
      font-weight:800;
      margin-bottom:6px;
    }
    .bullet-box ul {
      margin-left:18px;
    }
    .bullet-box li { margin-bottom:4px; }

    .practice-controls {
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(201,161,74,.35);
      background:linear-gradient(135deg,rgba(201,161,74,.08),#fff);
    }
    .practice-controls h4 {
      font-size:15px;
      font-weight:800;
      color:var(--deep);
      margin-bottom:6px;
    }
    .practice-controls p {
      font-size:13px;
      color:var(--muted);
      margin-bottom:10px;
    }
    .btn-primary, .btn-ghost {
      display:inline-block;
      padding:9px 18px;
      border-radius:999px;
      font-size:14px;
      font-weight:800;
      cursor:pointer;
      border:2px solid var(--gold);
      transition:.2s;
    }
    .btn-primary {
      background:var(--gold);
      color:#fff;
      margin-right:6px;
    }
    .btn-primary:disabled {
      opacity:.4;
      cursor:not-allowed;
    }
    .btn-primary:not(:disabled):hover {
      background:transparent;
      color:var(--gold);
    }
    .btn-ghost {
      background:transparent;
      color:var(--gold);
    }
    .btn-ghost:hover {
      background:rgba(201,161,74,.08);
    }

    .practice-stats {
      padding:14px 16px;
      border-radius:14px;
      border:1px solid rgba(148,163,184,0.4);
      font-size:14px;
      color:var(--muted);
      background:#fafafa;
    }
    .practice-stats h4 {
      font-size:15px;
      color:var(--deep);
      font-weight:800;
      margin-bottom:6px;
    }
    .practice-stats strong { color:var(--gold); }
    .stat-row { margin-bottom:4px; }

    .session-list {
      margin-top:8px;
      max-height:220px;
      overflow:auto;
      padding-left:16px;
    }
    .session-list li {
      margin-bottom:4px;
      font-size:13px;
    }

    .toast {
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%);
      background:#111827;
      color:#fff;
      padding:10px 16px;
      border-radius:999px;
      font-size:13px;
      display:none;
      z-index:999;
    }

    footer {
      margin-top:40px;
      text-align:center;
      padding:26px 10px 32px;
      border-top:1px solid rgba(201,161,74,.28);
      color:var(--muted);
      font-size:13px;
      background:linear-gradient(135deg,rgba(201,161,74,.05),rgba(255,255,255,0));
    }

     /* ====== å¼·åŒ–ï¼šâ‘  æ¯æ—¥ç·´ç¿’æŒ‰éˆ•æ›´é¡¯çœ¼ ====== */
.mode-btn-practice{
  border-width:2px;
  padding:12px 26px;
  font-size:15px;
  position:relative;
  box-shadow:0 10px 26px rgba(15,59,59,0.12);
}
.mode-btn-practice.active{
  box-shadow:0 14px 34px rgba(201,161,74,.55);
  transform:translateY(-1px);
}

/* å°æ¨™ç±¤ */
.pill{
  display:inline-block;
  margin-left:8px;
  padding:3px 10px;
  border-radius:999px;
  font-size:12px;
  font-weight:900;
  background:rgba(15,59,59,0.08);
  color:var(--deep);
}
.mode-btn-practice.active .pill{
  background:rgba(255,255,255,0.22);
  color:#fff;
}

/* è¼•å¾®å‘¼å¸å‹•ç•«ï¼ˆåªåœ¨ active æ™‚ï¼‰ */
@keyframes breathe {
  0%, 100% { transform:translateY(-1px) scale(1); }
  50%      { transform:translateY(-2px) scale(1.02); }
}
.mode-btn-practice.active{
  animation:breathe 1.8s ease-in-out infinite;
}



  </style>
</head>
<body>

<header>
  <h1>æ¯æ—¥30åˆ†é˜å˜†æ¯å‘¼å¸ç·´ç¿’</h1>
  <div class="accent"></div>
  <p>é€éã€Œå—…è¦º Ã— å˜†æ¯å‘¼å¸ Ã— ç¥ç¶“ä¿®å¾©ã€ï¼Œè®“è‡ªå¾‹ç¥ç¶“å¾ç·Šç¹ƒæ¨¡å¼ï¼Œå›åˆ°ä¿®å¾©èˆ‡ç©©å®šã€‚å»ºè­°æ¯å¤©å›ºå®šä¸€å€‹æ™‚é–“ï¼Œçµ¦è‡ªå·± 30 åˆ†é˜ï¼Œåªå°ˆå¿ƒç…§é¡§è‡ªå·±ã€‚</p>
</header>

<main class="page-wrap">
  <section class="intro-card">
    <ul>
      <li>0-5 åˆ†é˜ï¼šé›™é¼»å¾ªç’°å˜†æ¯å‘¼å¸æ³• - ç·©æ…¢å¸æ°£ç·©æ…¢åæ°£</li>
      <li>5-15 åˆ†é˜ï¼šå³å´å–®é¼»æ­£å¿µå‘¼å¸(å¡ä½å·¦é¼»)- æé«˜äº¤æ„Ÿç¥ç¶“æ´»æ€§</li>
      <li>15-20 åˆ†é˜: é›™é¼»å¾ªç’°å˜†æ¯å‘¼å¸æ³• - ç·©æ…¢å¸æ°£ç·©æ…¢åæ°£ </li>
      <li>20-30 åˆ†é˜: å·¦å´å–®é¼»æ­£å¿µå‘¼å¸(å¡ä½å³é¼»)- æé«˜å‰¯äº¤æ„Ÿç¥ç¶“æ´»æ€§</li>
    </ul>
  </section>

  <div class="mode-switch" aria-label="ç·´ç¿’æ¨¡å¼é¸æ“‡">
    <button class="mode-btn active" data-target="panel-practice">â‘  æ¯æ—¥ç·´ç¿’ç´€éŒ„</button>
    <button class="mode-btn" data-target="panel-learn">â‘¡ æ•™å­¸å½±ç‰‡è¤‡ç¿’</button>
  </div>

  <section id="panel-learn" class="panel" aria-labelledby="learn-title">
    <div class="panel-header">
      <h3 id="learn-title">äº†è§£åŸç†èˆ‡æ“ä½œï½œæ•™å­¸å½±ç‰‡</h3>
      <p>å»ºè­°å…ˆå®Œæ•´çœ‹å®Œä¸€æ¬¡æ•™å­¸å½±ç‰‡ï¼Œç¢ºèªä½ æ¸…æ¥šä»¥ä¸‹å¹¾ä»¶äº‹ï¼šæ“´é¦™å„€æ€éº¼åˆ‡æ›å·¦å³ã€å°æ¯å™¨æ€éº¼ä½¿ç”¨ã€å››å€‹æ®µè½å„åœ¨åšä»€éº¼ã€‚</p>
    </div>

    <div class="two-col">
      <div>
        <div class="video-wrap">
          <iframe
            src="https://www.youtube.com/embed/nWhNM32nYfk?rel=0&modestbranding=1"
            title="å–®å´èŠ³é¦™ Ã— æ­£å¿µå‘¼å¸ æ•™å­¸å½±ç‰‡"
            data-video-id="videobreath001"
            allowfullscreen
          ></iframe>
        </div>
      </div>

      <div class="bullet-box">
        <h4>é€™æ”¯æ•™å­¸å½±ç‰‡ï¼Œæœƒå¸¶ä½ çœ‹æ‡‚ï¼š</h4>
        <ul>
          <li>å¦‚ä½•æ­£ç¢ºæ“ä½œæ™ºå¹³è¡¡é›™å™´é ­æ“´é¦™å„€ï¼ˆå·¦ã€å³ç²¾æ²¹åˆ‡æ›ï¼‰</li>
          <li>30 åˆ†é˜çš„ 4 å€‹æ®µè½ï¼šå˜†æ¯å‘¼å¸ Ã— å³é¼»æ­£å¿µ Ã— å˜†æ¯å‘¼å¸ Ã— å·¦é¼»æ­£å¿µ</li>
          <li>å°æ¯å™¨è¦å¡å“ªä¸€é‚Šï¼Ÿä»€éº¼æ™‚å€™æ‹”æ‰ã€ä»€éº¼æ™‚å€™æ›é¦™æ°£ã€‚</li>
          <li>æ¯ä¸€æ®µç·´ç¿’æ™‚ï¼Œèº«é«”èˆ‡æƒ…ç·’å¯èƒ½å‡ºç¾çš„è®ŠåŒ–ï¼Œä»¥åŠå¦‚ä½•æº«æŸ”åœ°å¸¶è‡ªå·±å›ä¾†ã€‚</li>
        </ul>
        <p style="margin-top:6px;">ç•¶ä½ å·²ç¶“ç†Ÿæ‚‰æ•´å€‹ 30 åˆ†é˜çš„ç¯€å¥ï¼Œå°±å¯ä»¥åˆ‡æ›åˆ°ç¬¬äºŒå€‹æ¨¡å¼ï¼šæ¯å¤©è·Ÿè‘—å¯¦ä½œå½±ç‰‡ç·´ç¿’ï¼Œä¸¦é–‹å§‹ç´¯ç©è‡ªå·±çš„ç´€éŒ„ã€‚</p>
      </div>
    </div>
  </section>

  <section id="panel-practice" class="panel active" aria-labelledby="practice-title">
    <div class="panel-header">
      <h3 id="practice-title">æ¯æ—¥å¯¦ä½œï½œ30 åˆ†é˜èŠ³é¦™ Ã— å¾ªç’°å˜†æ¯å‘¼å¸</h3>
      <p>è«‹å…ˆæº–å‚™å¥½ï¼šæ“´é¦™å„€ã€å·¦å³å…©ç“¶ç²¾æ²¹ã€å°æ¯å™¨èˆ‡ä¸€å€‹ä¸è¢«æ‰“æ“¾çš„è§’è½ã€‚<br>
      æ¯æ¬¡éƒ½å¾é€™è£¡é–‹å§‹ï¼ŒæŒ‰ä¸‹ã€Œé–‹å§‹æœ¬æ¬¡ç·´ç¿’ã€ï¼Œå½±ç‰‡æœƒå•Ÿå‹•ï¼ŒåŒæ™‚å¹«æ‚¨ç•™ä¸‹ä»Šå¤©çš„ä¸€ç­†ç´€éŒ„ã€‚</p>
    </div>
    <div class="two-col">
      <div>
        <div class="video-wrap"> 
          <iframe
            id="practiceVideo"
            
            src="https://www.youtube.com/embed/LQWKNEmk58U?enablejsapi=1&rel=0&modestbranding=1"
            title="å–®å´èŠ³é¦™ Ã— æ­£å¿µå‘¼å¸ å¯¦ä½œå¼•å°"
            allow="autoplay; encrypted-media"
            data-video-id="videobreath002"
            allowfullscreen
          ></iframe>
        </div>
        <div class="practice-controls" style="margin-top:14px;">
          <h4>å¯¦ä½œå‰è«‹å…ˆç¢ºèªï¼š</h4>
          <p>æ“´é¦™å„€ä¸­å·¦å³ç²¾æ²¹åˆ†åˆ¥æ”¾å¥½ï¼›å°æ¯å™¨åœ¨æ‰‹é‚Šã€‚æ‰¾å°‹ä¸€å€‹å®‰éœçš„è§’è½ï¼Œè®“é€™30 åˆ†é˜åªå±¬æ–¼æ‚¨ã€‚</p>
          <button id="btnStart" class="btn-primary">é–‹å§‹æœ¬æ¬¡ç·´ç¿’</button>
          <button id="btnFinish" class="btn-ghost" disabled>æˆ‘å·²å®Œæˆ</button>
          <p style="font-size:12px;margin-top:6px;color:var(--muted);">
            âœ… æŒ‰ä¸‹ã€Œé–‹å§‹ã€å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•è¨˜éŒ„é–‹å§‹æ™‚é–“ã€‚<br>
            âœ… ç·´ç¿’çµæŸæ™‚ï¼Œè«‹è¨˜å¾—æŒ‰ã€Œæˆ‘å·²å®Œæˆã€ï¼Œæˆ–ç­‰å½±ç‰‡æ’­å®Œè‡ªå‹•ç´€éŒ„å®Œæˆã€‚
          </p>
        </div>
      </div>

      <div class="practice-stats">
        <h4>æˆ‘çš„ç·´ç¿’æˆé•·ç´€éŒ„ </h4>
        <p class="stat-row">ç´¯ç©å®Œæˆæ¬¡æ•¸ï¼š<strong id="statTotal">0</strong> æ¬¡</p>
        <p class="stat-row">æœ€è¿‘ä¸€æ¬¡å®Œæˆæ™‚é–“ï¼š<strong id="statLast">å°šæœªé–‹å§‹</strong></p>
        <p class="stat-row">æŒçºŒç·´ç¿’å¤©æ•¸ï¼ˆè‡³å°‘ä¸€å¤©ä¸€æ¬¡ï¼‰ï¼š<strong id="statStreak">0</strong> å¤©</p>

        <ul id="sessionList" class="session-list"></ul>
      </div>
    </div>
  </section>
</main>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<footer>Â© 2025 æ™ºå¹³è¡¡å¥åº·é›†åœ˜ â€” æ„Ÿè¬æ‚¨é¡˜æ„èŠ±æ™‚é–“å¥½å¥½ç…§é¡§è‡ªå·±ã€‚</footer>

<script src="https://www.youtube.com/iframe_api"></script>
<script>
  /* ====== API è¨­å®š ====== */
  const Save_Breath_Record_URL = "https://23700999.com:8081/HMA/000TTEUPDATE_BREATH_RECORD.jsp";
  const Get_Breath_Record_URL  = "https://23700999.com:8081/HMA/000TTEGET_BREATH_RECORD.jsp";
  const API_LOG_EVENT          = "https://23700999.com:8081/HMA/000TTELOG_EVENT.jsp";
  const EventType = "Breath";
  const STORAGE_WATCHED_KEY = "yt_watched_list";
  let vipId = new URLSearchParams(location.search).get("vip") || "unknown";
  let BID="";
  // ===== YouTube è¿½è¹¤æ’­æ”¾å™¨åˆå§‹åŒ–æ——æ¨™ =====
  let ytApiReady = false;           // YT Iframe API æ˜¯å¦è¼‰å…¥å®Œæˆ
  let playersInitialized = false;   // createPlayers æ˜¯å¦å·²ç¶“è·‘é
  let wantInitOtherPlayers = false; // æ˜¯å¦å·²ç¶“æœ‰äººè¦æ±‚åˆå§‹åŒ–å…¶å®ƒå½±ç‰‡

  logEvent("leadingpage", EventType);

  /* ====== å–å¾—æ‰‹æ©Ÿè£ç½®èˆ‡ç³»çµ±è³‡è¨Š ====== */
  function getDeviceInfo() {
    var ua = navigator.userAgent || "";
    var uaData = navigator.userAgentData || null;

    var os = "æœªçŸ¥";
    if (/Android/i.test(ua)) {
      os = "Android";
    } else if (/iPhone|iPad|iPod/i.test(ua)) {
      os = "iOS";
    } else if (/Win/i.test(ua)) {
      os = "Windows";
    } else if (/Mac/i.test(ua)) {
      os = "macOS";
    } else if (/Linux/i.test(ua)) {
      os = "Linux";
    }

    var deviceModel = "ç„¡æ³•è¾¨è­˜";
    var m = ua.match(/\(([^)]+)\)/);
    if (m) {
      var inside = m[1];
      if (inside.indexOf("Android") !== -1) {
        var parts = inside.split(";");
        deviceModel = parts[parts.length - 1].trim();
      } else if (/iPhone/.test(inside)) {
        deviceModel = "iPhone";
      } else if (/iPad/.test(inside)) {
        deviceModel = "iPad";
      }
    }

    var platform = "";
    if (uaData && uaData.platform) {
      platform = uaData.platform;
    } else if (navigator.platform) {
      platform = navigator.platform;
    }

    return { os: os, deviceModel: deviceModel, platform: platform, userAgent: ua };
  }

  const deviceInfo = getDeviceInfo();
  console.log("vipId=" + vipId, deviceInfo);


  async function logEvent(Event, EventType) {
    const payload = {SafeKey:"qrt897hpmd", VIP: vipId, Event, EventType} ;
    console.log("payload1="+JSON.stringify(payload, null, 1));
       // 1) å…ˆå˜—è©¦ sendBeaconï¼ˆPOSTï¼ŒContent-Type: text/plain; charset=UTF-8ï¼‰
    try {
           const ok = navigator.sendBeacon(API_LOG_EVENT, new Blob(
           [JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }
          ));
          if (ok) {console.info("[logEvent] sendBeacon sent");return;}     
    } catch (e) {
         console.warn("[logEvent] sendBeacon failed, fallback to fetch no-cors", e);
    }
      // 2) fallback: simple requestï¼ˆno-cors + text/plain â†’ ä¸æœƒ preflightï¼‰
    try {
             await fetch(API_LOG_EVENT, {
               method: "POST",
               mode: "no-cors",
               headers: { "Content-Type": "text/plain;charset=UTF-8" }, // æ³¨æ„ï¼šä¸è¦ application/json
               body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
               keepalive: true,
               });
              console.info("[logEvent] fetch(no-cors) sent (opaque response)");
        } catch (err) {
             console.error("[logEvent] still failed:", err);
          }
}

  /* ====== ç·´ç¿’äº‹ä»¶é€åˆ°å¾Œç«¯ï¼štype = start / end ====== */
  async function sendPracticeEvent(type, data) {

   const payload = {
       Key: "qrt897hpmd",
       BID: BID,                     // â­ é€™è£¡æœƒå¸¶ä¸Šä¸€é–‹å§‹å–å¾—çš„ BID
       type: type,                  // start / end
       VIP: vipId,
       DeviceModel: deviceInfo.deviceModel,
       Os: deviceInfo.os,
       Platform: deviceInfo.platform,
       userAgent: deviceInfo.userAgent
    };

//console.log("payload4="+JSON.stringify(payload, null, 1));

/* =====================================================
   ç¬¬ 1 éšæ®µï¼šç”¨æ­£å¸¸ fetch é€ï¼ˆå¯å–å¾— JSON å›æ‡‰ï¼‰
   ===================================================== */
try {
  const res = await fetch(Save_Breath_Record_URL, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  const text = await res.text();
 // console.log("ğŸ“¥ API å›æ‡‰åŸå§‹æ–‡å­— =", text);

  // å˜—è©¦è§£æ JSON
  let json = null;
  try {
    json = JSON.parse(text);
  } catch (e) {
    console.warn("âš  å›æ‡‰ä¸æ˜¯ JSONï¼Œç„¡æ³•æ›´æ–° BID");
  }

  // â­ å¦‚æœæˆåŠŸè§£æ JSON & æœ‰ BIDï¼Œæ›´æ–°å…¨åŸŸ BID
  if (json && json.BID) {
    BID = json.BID;
    console.log("â­ BID å·²æ›´æ–°ç‚ºï¼š", BID);
  }
  // å·²æˆåŠŸé€å‡ºå°± returnï¼Œä¸èµ° fallback
  return;
}
catch (e) {
  console.warn("âŒ æ­£å¸¸ fetch å¤±æ•—ï¼Œæ”¹ç”¨ sendBeacon / no-cors fallbackï¼", e);
}

/* ç¬¬ 2 éšæ®µï¼šsendBeaconï¼ˆç„¡æ³•å–å¾—å›æ‡‰ï¼‰*/
try {
  const ok = navigator.sendBeacon(
    Save_Breath_Record_URL,
    new Blob([JSON.stringify(payload)], {
      type: "text/plain;charset=UTF-8"
    })
  );

  if (ok) {
    console.info("ğŸ“¡ sendBeacon å·²é€å‡ºï¼ˆä½†ç„¡æ³•å–å¾— BIDï¼‰");
    return;
  }
} catch (e) {
  console.warn("sendBeacon å¤±æ•— -> fallback to no-cors fetch", e);
}
/* ç¬¬ 3 éšæ®µï¼šno-cors fallbackï¼ˆç„¡æ³•å–å¾—å›æ‡‰ï¼‰ */
try {
  await fetch(Save_Breath_Record_URL, {
    method: "POST",
    mode: "no-cors",
    headers: {
      "Content-Type": "text/plain;charset=UTF-8"
    },
    body: new Blob([JSON.stringify(payload)], {
      type: "text/plain;charset=UTF-8"
    }),
    keepalive: true
  });

  console.info("ğŸŒ fetch(no-cors) å·²é€å‡ºï¼ˆç„¡æ³•å–å¾— BIDï¼‰");
} catch (err) {
  console.error("ğŸ’¥ fallback å…¨éƒ¨å¤±æ•—ï¼š", err);
}
}

async function getBreathRecord() {
  const payload = {
    Key: "qrt897hpmd",
    VIP: vipId,
  };
  console.log("payloadg=" + JSON.stringify(payload, null, 1));

  try {
    const res = await fetch(Get_Breath_Record_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    const text = await res.text();
    //console.log("ğŸ“¥ Get_Breath_Record å›æ‡‰åŸå§‹æ–‡å­— =", text);

    let json = null;
    try {
      json = JSON.parse(text);
    } catch (e) {
      console.warn("âš  Get_Breath_Record å›æ‡‰ä¸æ˜¯ JSONï¼Œç„¡æ³•è§£ææˆç´€éŒ„é™£åˆ—");
      return [];
    }

    return json;   // æœŸå¾…å¾Œç«¯å›å‚³çš„æ˜¯é™£åˆ—
  } catch (e) {
    console.warn("âŒ å‘¼å« Get_Breath_Record_URL å¤±æ•—ï¼š", e);
    return [];
  }
}


function parseBackendTime(ts) {
  if (!ts) return null;
  ts = String(ts).trim();

  // 14 ç¢¼ï¼šyyyyMMddHHmmss  â†’  2025 11 26 09:10:23
  if (/^\d{14}$/.test(ts)) {
    const year  = parseInt(ts.slice(0, 4), 10);
    const month = parseInt(ts.slice(4, 6), 10) - 1; // 0-based
    const day   = parseInt(ts.slice(6, 8), 10);
    const hour  = parseInt(ts.slice(8,10), 10);
    const min   = parseInt(ts.slice(10,12), 10);
    const sec   = parseInt(ts.slice(12,14), 10);
    return new Date(year, month, day, hour, min, sec);
  }

  // å¦‚æœä»¥å¾Œå¾Œç«¯æ”¹æˆ timestamp (13 ç¢¼æ¯«ç§’)
  if (/^\d{13}$/.test(ts)) {
    const ms = parseInt(ts, 10);
    const d  = new Date(ms);
    if (!isNaN(d.getTime())) return d;
  }

  // æœ€å¾Œæ‰å˜—è©¦ç”¨åŸç”Ÿ Date è§£æï¼ˆä¾‹å¦‚å·²ç¶“æ˜¯ ISO å­—ä¸²ï¼‰
  const d = new Date(ts);
  if (isNaN(d.getTime())) return null;
  return d;
}


   // å…ˆæŠŠåŸæœ¬å»ºç«‹ practicePlayer çš„å…§å®¹æŠ½æˆä¸€å€‹å‡½å¼
function initPracticePlayer() {
  console.log("YouTube Iframe API Ready");
  var iframe = document.getElementById("practiceVideo");
  if (!iframe) {
    console.log("æ‰¾ä¸åˆ° practiceVideo iframe");
    return;
  }

  practicePlayer = new YT.Player("practiceVideo", {
    events: {
      onStateChange: function(e) {
        var state = e.data;
        var player = practicePlayer;

        if (state === YT.PlayerState.PLAYING) {
          if (!practiceFlags.clicked) {
            practiceFlags.clicked = true;
            trackVideoStatusToSession(YT_STATUS.CLICK, player);
          }

          if (!practiceFlags.halfTimer && !practiceFlags.sent50) {
            practiceFlags.halfTimer = setInterval(function() {
              try {
                var d = player.getDuration ? player.getDuration() : 0;
                var c = player.getCurrentTime ? player.getCurrentTime() : 0;
                if (d > 0 && c / d >= 0.5 && !practiceFlags.sent50) {
                  practiceFlags.sent50 = true;
                  trackVideoStatusToSession(YT_STATUS.HALF, player);
                  clearInterval(practiceFlags.halfTimer);
                  practiceFlags.halfTimer = null;
                }
              } catch (err) {}
            }, 1000);
          }
        }

        if (state === YT.PlayerState.ENDED) {
          if (!practiceFlags.sent100) {
            practiceFlags.sent100 = true;

            if (practiceFlags.halfTimer) {
              clearInterval(practiceFlags.halfTimer);
              practiceFlags.halfTimer = null;
            }

            trackVideoStatusToSession(YT_STATUS.END, player);

            if (currentSession && !currentSession.finishedBy) {
              finishPractice("autoVideoEnded");
            }
          }
        }
      }
    }
  });

  if (pendingStartPlay && practicePlayer && typeof practicePlayer.playVideo === "function") {
    console.log("pendingStartPlay -> autoplay now");
    practicePlayer.playVideo();
    pendingStartPlay = false;
  }
}

  /* ====== æ¨¡å¼åˆ‡æ› ====== */
  var modeBtns = document.querySelectorAll(".mode-btn");
  var panels = document.querySelectorAll(".panel");
  modeBtns.forEach(function(btn) {
    btn.addEventListener("click", function() {
      var target = btn.dataset.target;
      modeBtns.forEach(function(b) { b.classList.toggle("active", b === btn); });
      panels.forEach(function(p) { p.classList.toggle("active", p.id === target); });
    });
  });

  /* ====== YouTube Player & ç·´ç¿’ Session ====== */
  var practicePlayer = null;
  var currentSession = null;
  var pendingStartPlay = false;

  var practiceFlags = {
    clicked: false,
    sent50: false,
    sent100: false,
    halfTimer: null
  };

  var YT_STATUS = {
    CLICK: "click",
    HALF: "50",
    END: "100"
  };

  function trackVideoStatusToSession(status, player) {
    if (!currentSession) return;

    if (!currentSession.videoEvents) {
      currentSession.videoEvents = [];
    }

    var meta = null;
    try {
      if (player && typeof player.getVideoData === "function") {
        var data = player.getVideoData();
        if (data) {
          meta = {
            videoId: data.video_id,
            title: data.title,
            author: data.author
          };
        }
      }
    } catch (e) {}

    var now = Date.now();
    var currentTime = null;
    var duration = null;
    try {
      if (player && typeof player.getCurrentTime === "function") {
        currentTime = player.getCurrentTime();
      }
      if (player && typeof player.getDuration === "function") {
        duration = player.getDuration();
      }
    } catch (e) {}

    currentSession.videoEvents.push({
      status: status,
      at: now,
      currentTime: currentTime,
      duration: duration,
      meta: meta
    });

    console.log("YT event recorded:", status, currentSession.videoEvents);
  }

  // YouTube API è¼‰å…¥å®Œæˆå¾Œï¼Œçµ±ä¸€å¾é€™è£¡å‘¼å«
  window.onYouTubeIframeAPIReady = function () {
     ytApiReady = true;
     initPracticePlayer();  // 30 åˆ†é˜ç·´ç¿’å½±ç‰‡

  // å¦‚æœä¹‹å‰ startPractice å·²ç¶“å‘¼å«é ensurePlayersInitialized()
  //ï¼ˆwantInitOtherPlayers=trueï¼‰ï¼Œé‚£é€™è£¡å¹«å¿™çœŸçš„å» createPlayers()
     //if (wantInitOtherPlayers && !playersInitialized) {
         createPlayers();
         playersInitialized = true;
    // }
};

// ç¢ºä¿åªåœ¨ã€ŒAPI å·²è¼‰å…¥ã€ä¸”ã€Œå°šæœªå»ºç«‹ã€æ™‚å‘¼å« createPlayers()
function ensurePlayersInitialized() {
   // æœ‰æŒ‰éã€Œé–‹å§‹ç·´ç¿’ã€å°±è¨­ç‚º true
   wantInitOtherPlayers = true;

// API é‚„æ²’ ready å°±å…ˆè¨˜ä¸‹æ„åœ–ï¼Œç­‰ onYouTubeIframeAPIReady è£œä½œ
   if (!ytApiReady) return;

   if (playersInitialized) return;   // å·²ç¶“å»ºéå°±ä¸è¦é‡è¤‡ new

   createPlayers();
   playersInitialized = true;
}

/* ====== æˆé•·ç´€éŒ„ï¼šå¾ DB (Get_Breath_Record_URL) å–å¾— ====== */



  function formatDate(ts) {
  var d = parseBackendTime(ts);
  if (!d) return "æ™‚é–“æ ¼å¼éŒ¯èª¤";
  var pad = function(n){ return String(n).padStart(2,"0"); };
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate())+" "+pad(d.getHours())+":"+pad(d.getMinutes());
}

function formatDateYMD(ts) {
  var d = parseBackendTime(ts);
  if (!d) return null;
  var pad = function(n){ return String(n).padStart(2,"0"); };
  return d.getFullYear()+"-"+pad(d.getMonth()+1)+"-"+pad(d.getDate());
}

function computeStreakFromRecords(records) {
  if (!records || !records.length) return 0;

  var daysSet = new Set();
  records.forEach(function(r){
    // å„ªå…ˆç”¨ Endtimeï¼Œå…¶æ¬¡ Starttime / CheckTime
    var ts =
      r.Endtime   || r.ENDTIME   ||
      r.Starttime || r.STARTTIME ||
      r.CheckTime || r.CHECKTIME;

    var dayStr = formatDateYMD(ts);
    if (dayStr) daysSet.add(dayStr);
  });

  var days = Array.from(daysSet).sort();
  if (!days.length) return 0;

  var streak = 1;
  for (var i = days.length - 2; i >= 0; i--) {
    var cur  = new Date(days[i]);
    var next = new Date(days[i+1]);
    var diff = (next - cur) / (1000*60*60*24);
    if (diff === 1) streak++;
    else if (diff > 1) break;
  }
  return streak;
}


function renderSessionsFromDB() {
  var totalEl  = document.getElementById("statTotal");
  var lastEl   = document.getElementById("statLast");
  var streakEl = document.getElementById("statStreak");
  var listEl   = document.getElementById("sessionList");

  // â­ é€™è£¡è¨˜å¾—ç”¨ Promise æ–¹å¼æ¥ async çµæœ
  getBreathRecord()
    .then(function(records) {
      if (!Array.isArray(records)) {
        console.warn("Get_Breath_Record_URL å›å‚³ä¸æ˜¯é™£åˆ—ï¼Œå¯¦éš›å€¼ =", records);
        records = [];
      }

      // 1) ç´¯ç©å®Œæˆæ¬¡æ•¸
      totalEl.textContent = records.length;

      // 2) æœ€è¿‘ä¸€æ¬¡å®Œæˆæ™‚é–“ï¼šç”¨æœ€å¾Œä¸€ç­†çš„ Endtime / Starttime / CheckTime
      if (records.length) {
        var last = records[records.length - 1];
        var lastEnd =
          last.Endtime   || last.ENDTIME   ||
          last.Starttime || last.STARTTIME ||
          last.CheckTime || last.CHECKTIME;

        lastEl.textContent = formatDate(lastEnd);
      } else {
        lastEl.textContent = "å°šæœªé–‹å§‹";
      }

      // 3) é€£çºŒå¤©æ•¸
      streakEl.textContent = computeStreakFromRecords(records);

      // 4) åˆ—è¡¨æ˜ç´°
      listEl.innerHTML = "";
      records.slice().reverse().forEach(function(rec){
         var li = document.createElement("li");

         var start = rec.Starttime || rec.STARTTIME;
         var end   = rec.Endtime   || rec.ENDTIME;

  // ---- 1. å…ˆç”¨ Durationï¼ˆç§’ï¼‰æ›ç®—æˆåˆ†é˜ ----
         var rawSec =
             parseInt(rec.Duration, 10)  ||
             parseInt(rec.DURATION, 10)  ||
             parseInt(rec.duration, 10)  ||
             parseInt(rec.DURATION2, 10) || 0;

          var mins = 0;
          if (!isNaN(rawSec) && rawSec > 0) {
             mins = Math.round(rawSec / 60);      // 37 ç§’ â†’ å››æ¨äº”å…¥æˆ 1 åˆ†é˜
              if (mins < 1) mins = 1;              // æœ€å°‘é¡¯ç¤º 1 åˆ†é˜
            } else {
    // ---- 2. æ²’æœ‰ Durationï¼Œå°±ç”¨ Start / End ç®— ----
            var sDate = parseBackendTime(start);
            var eDate = parseBackendTime(end);
            if (sDate && eDate) {
               var diffMs = eDate - sDate;
               mins = Math.round(diffMs / 60000);
               if (mins < 1) mins = 1;
             } else {
                mins = 30; // å¯¦åœ¨ç®—ä¸å‡ºä¾†æ™‚å°±çµ¦é è¨­ 30 åˆ†é˜
              }
             }

             var startStr = start ? formatDate(start) : "æœªçŸ¥é–‹å§‹æ™‚é–“";
             var endStr   = end   ? formatDate(end)   : "æœªçŸ¥çµæŸæ™‚é–“";

             li.textContent = startStr + " ï½ " + endStr + " â€” å®Œæˆ " + mins + " åˆ†é˜";
             listEl.appendChild(li);
    });

    })
    .catch(function(err) {
      console.error("âŒ renderSessionsFromDB ç™¼ç”ŸéŒ¯èª¤ï¼š", err);
    });
}

  



  /* ====== æ§åˆ¶æŒ‰éˆ• & æµç¨‹ ====== */
  var btnStart  = document.getElementById("btnStart");
  var btnFinish = document.getElementById("btnFinish");
  var toast     = document.getElementById("toast");

  function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = "block";
    setTimeout(function(){ toast.style.display = "none"; }, 1800);
  }

  function resetPracticeFlags() {
    if (practiceFlags.halfTimer) {
      clearInterval(practiceFlags.halfTimer);
      practiceFlags.halfTimer = null;
    }
    practiceFlags.clicked = false;
    practiceFlags.sent50  = false;
    practiceFlags.sent100 = false;
  }

  function startPractice() {
    
    ensurePlayersInitialized();

    if (currentSession) {
      showToast("å·²ç¶“åœ¨é€²è¡Œä¸€å€‹ç·´ç¿’å›‰ã€‚å…ˆå®Œæˆé€™æ¬¡å†é–‹å§‹ä¸‹ä¸€æ¬¡ã€‚");
      return;
    }

    currentSession = { 
      start: Date.now(), 
      finishedBy: null,
      device: deviceInfo
    };

    // å‘¼å« APIï¼šé–‹å§‹ç·´ç¿’ï¼ˆå¯ä»¥æŠŠ start_time å‚³å‡ºå»ï¼‰
    sendPracticeEvent("start", {
      start_time: currentSession.start
    });

    resetPracticeFlags();
    
    btnStart.disabled  = true;
    btnFinish.disabled = false;

    console.log("startPractice: practicePlayer =", practicePlayer);

    if (practicePlayer && typeof practicePlayer.playVideo === "function") {
      practicePlayer.playVideo();
    } else {
      console.log("player å°šæœª readyï¼Œè¨­å®š pendingStartPlay = true");
      pendingStartPlay = true;
    }

    showToast("å·²é–‹å§‹æœ¬æ¬¡ç·´ç¿’ï¼Œç¥ä½ æœ‰ä¸€æ®µå®‰ç©©çš„ 30 åˆ†é˜ã€‚");
  }

  function finishPractice(mode) {
    if (!currentSession) {
      showToast("ç›®å‰æ²’æœ‰æ­£åœ¨é€²è¡Œçš„ç·´ç¿’ã€‚");
      return;
    }

    currentSession.end      = Date.now();
    currentSession.duration = (currentSession.end - currentSession.start) / 1000; // ç§’
    currentSession.finishedBy = mode || "manual";

    var minutes = Math.round(currentSession.duration / 60);

    // å‘¼å« APIï¼šçµæŸç·´ç¿’ï¼ŒæŠŠ start / end / minutes å‚³åˆ°è³‡æ–™åº«
    sendPracticeEvent("end", {
      start_time: currentSession.start,
      end_time: currentSession.end,
      duration_sec: currentSession.duration,
      minutes: minutes
    });

    currentSession = null;

    btnStart.disabled  = false;
    btnFinish.disabled = true;

    // å¾è³‡æ–™åº«é‡æ–°æŠ“æœ€æ–°æˆé•·ç´€éŒ„
    renderSessionsFromDB();

    showToast("å·²ç‚ºä½ è¨˜éŒ„é€™æ¬¡ç·´ç¿’ï¼Œè¾›è‹¦äº†ï¼");
  }

  btnStart.addEventListener("click", function(){ startPractice(); });
  btnFinish.addEventListener("click", function(){ finishPractice("manual"); });

  document.addEventListener("DOMContentLoaded", function(){
    // ä¸€é€²é é¢å°±å…ˆæŠ“è³‡æ–™åº«æˆé•·ç´€éŒ„
      renderSessionsFromDB();

// â˜… å°æ‰€æœ‰ iframe åšæ­£è¦åŒ– & åŠ ä¸Š data-track="yt"
      prepareIframes();
  });



  /** è§£æ YouTube ä¾†æºç‚º { id(ytId), url(å¯è¿½è¹¤embed) } */
function normalizeYouTubeSrc(src) {
  if (!src) return null;
  const be = src.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
  const watch = src.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  const embed = src.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
  const ytId = be?.[1] || watch?.[1] || embed?.[1];
  if (!ytId) return null;
  const url = new URL("https://www.youtube-nocookie.com/embed/" + ytId);
  url.searchParams.set("enablejsapi", "1");
  url.searchParams.set("rel", "0");
  url.searchParams.set("modestbranding", "1");
  url.searchParams.set("playsinline", "1");
  return { id: ytId, url: url.toString() };
}

/** æƒæ iframes â†’ æ­£è¦åŒ– â†’ è£œè³‡æ–™å±¬æ€§ */
function prepareIframes() {
  const iframes = Array.from(document.querySelectorAll("iframe"));
  let idx = 0;
  for (const el of iframes) {
    // â˜… è·³éå¯¦ä½œç”¨çš„ä¸»å½±ç‰‡ï¼Œä¸è¦è®“ createPlayers ç®¡å®ƒ
    if (el.id === "practiceVideo") continue;

    const norm = normalizeYouTubeSrc(el.getAttribute("src"));
    if (!norm) continue;

    el.src = norm.url;
    if (!el.id) el.id = `ytp-${++idx}`;

    let title = el.getAttribute("title") || `video-${idx}`;
    const card = el.closest(".card, .single-video, .hero");
    const h = card?.querySelector("h3, h4, h2");
    if (h?.textContent) title = h.textContent.trim();

    el.dataset.track     = "yt";
    el.dataset.title     = title;
    el.dataset.youtubeId = norm.id;
    el.dataset.videoId   = el.dataset.videoId || norm.id;
  }
}


/** æ’­æ”¾å™¨&ç‹€æ…‹æ——æ¨™ */
const players = {};
const flags = {}; // { [iframeId]: { clicked, sent50, sent100 } }

/** æ¨™è¨˜ 100% å®Œæˆæ¸…å–®ï¼ˆå¯é¸ï¼‰ */
function markWatched(record) {
  try {
    const list = JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]");
    if (!list.find(x => x.videoId === record.videoId)) {
      list.push(record);
      localStorage.setItem(STORAGE_WATCHED_KEY, JSON.stringify(list));
    }
  } catch {}
}

/** é€äº‹ä»¶çš„çµ±ä¸€å‡½å¼ */
function sendProgress({ iframeId, status, player, meta }) {
  const duration = Math.round(player?.getDuration?.() || 0);
  const watched  = Math.round(player?.getCurrentTime?.() || 0);
  const payload = {
    vipId,
    status,                    // "click" | "50" | "100"
    videoId:   meta.videoId,   // ä½ çš„å•†å‹™ID
    youtubeId: meta.youtubeId, // çœŸæ­£ YT ID
    title:     meta.title,
    watchedSec: watched,
    duration,
    ts: new Date().toISOString()
  };
  console.log("payload1="+JSON.stringify(payload, null, 1));
  //postEvent(payload);
  if (status === "100") {
    markWatched(payload);
  }
}
function createPlayers() {
  const iframes = Array.from(document.querySelectorAll('iframe[data-track="yt"]'));
  iframes.forEach((el) => {
    const iframeId = el.id;
    const meta = {
      videoId:   el.dataset.videoId,
      youtubeId: el.dataset.youtubeId,
      title:     el.dataset.title || el.title || el.dataset.videoId || el.dataset.youtubeId
    };
    flags[iframeId] = { clicked: false, sent50: false, sent100: false };

    players[iframeId] = new YT.Player(iframeId, {
      events: {
        onStateChange: (e) => {
          const state  = e.data;
          const player = players[iframeId];

          // clickï¼ˆé¦–æ¬¡æ’­æ”¾ï¼‰
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].clicked) {
            flags[iframeId].clicked = true;
            sendProgress({ iframeId, status: "click", player, meta });
            logEvent("videoPlay_"+el.dataset.videoId, EventType);
          }

          // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è·¨é 50%
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].sent50) {
            if (!flags[iframeId].halfTimer) {
              flags[iframeId].halfTimer = setInterval(() => {
                try {
                  const d = player.getDuration?.() || 0;
                  const c = player.getCurrentTime?.() || 0;
                  if (d > 0 && c / d >= 0.5 && !flags[iframeId].sent50) {
                    flags[iframeId].sent50 = true;
                    sendProgress({ iframeId, status: "50", player, meta });
                    logEvent("videoPlay50_"+el.dataset.videoId, EventType);
                    clearInterval(flags[iframeId].halfTimer);
                    flags[iframeId].halfTimer = null;
                  }
                } catch {}
              }, 1000);
            }
          }

          // 100%ï¼ˆæ’­æ”¾çµæŸï¼‰
          if (state === YT.PlayerState.ENDED && !flags[iframeId].sent100) {
            flags[iframeId].sent100 = true;
            if (flags[iframeId].halfTimer) {
              clearInterval(flags[iframeId].halfTimer);
              flags[iframeId].halfTimer = null;
            }
            sendProgress({ iframeId, status: "100", player, meta });
            logEvent("videoPlay100_"+el.dataset.videoId, EventType);
          }
        }
      }
    });
  });
}

</script>

</body>
</html>
