<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºå¹³è¡¡æœƒå“¡é »é“ï½œå°ˆå±¬å½±ç‰‡é«”é©—</title>
  <style>
    :root {
      --deep:#0f3b3b;
      --gold:#c9a14a;
      --muted:#6b7280;
      --ink:#1f2a37;
      --bg:#ffffff;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body {
      font-family:"PingFang TC","Microsoft JhengHei",system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.8;
    }
    header {
      text-align:center;
      padding:80px 16px 40px;
    }
    header h1 {
      font-size:clamp(28px,4vw,42px);
      font-weight:800;
      color:var(--deep);
      letter-spacing:1px;
    }
    header p {
      max-width:800px;
      margin:14px auto 0;
      color:var(--muted);
    }
    header .accent {
      width:140px;
      height:3px;
      background:var(--gold);
      margin:20px auto;
      border-radius:2px;
    }
    /* Hero å€å¡Š */
    .hero {
      max-width:1000px;
      margin:0 auto 80px;
      padding:0 16px;
      text-align:center;
    }
    .hero-intro h2 {
      font-size:28px;
      color:var(--deep);
      font-weight:800;
      margin-bottom:10px;
    }
    .hero-intro p {
      font-size:17px;
      color:var(--muted);
      margin-bottom:24px;
    }
    .hero iframe {
      width:100%;
      max-width:960px;
      height:540px;
      border:none;
      border-radius:16px;
      box-shadow:0 8px 30px rgba(0,0,0,0.15);
    }

    /* å–®æ”¯å½±ç‰‡å€ */
    .single-video {
      max-width:960px;
      margin:0 auto 80px;
      padding:0 16px;
      text-align:center;
    }
    .single-video h3 {
      font-size:20px;
      color:var(--deep);
      font-weight:800;
      margin:16px 0 8px;
    }
    .single-video p {
      color:var(--muted);
      font-size:15px;
      margin-bottom:16px;
    }
    .single-video iframe {
      width:100%;
      max-width:960px;
      height:540px;
      border:none;
      border-radius:16px;
      box-shadow:0 8px 24px rgba(0,0,0,0.1);
    }
    .cta {
      display:inline-block;
      padding:10px 22px;
      border-radius:999px;
      background:var(--gold);
      color:#fff;
      text-decoration:none;
      font-weight:800;
      border:2px solid var(--gold);
      transition:.2s;
    }
    .cta:hover { background:transparent; color:var(--gold); }
    
    /* é›™æ¬„å½±ç‰‡å€ */
    .grid-two {
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(400px,1fr));
      gap:30px;
      max-width:1160px;
      margin:0 auto 80px;
      padding:0 16px;
    }
    .card {
      background:#fff;
      border-radius:18px;
      border:1px solid rgba(201,161,74,.35);
      box-shadow:0 10px 34px rgba(17,24,39,.08);
      overflow:hidden;
      transition:.25s;
    }
    .card:hover {
      transform:translateY(-4px);
      box-shadow:0 14px 40px rgba(201,161,74,.28);
    }
    .thumb { aspect-ratio:16/9; background:#000; }
    .thumb iframe {
      width:100%;
      height:100%;
      border:0;
      display:block;
    }
    .content { padding:20px 24px 26px; }
    .content h4 {
      font-size:18px;
      color:var(--deep);
      font-weight:800;
      margin-bottom:8px;
    }
    .content p {
      color:var(--muted);
      font-size:15px;
      margin-bottom:18px;
    }

    /* POP å½ˆçª— */
    .popup-overlay {
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      animation:fadeIn .4s ease forwards;
    }
    .popup {
      background:#fff;
      border:2px solid var(--gold);
      border-radius:18px;
      box-shadow:0 0 40px rgba(201,161,74,.3);
      padding:30px 26px;
      text-align:center;
      max-width:360px;
      width:90%;
      animation:popIn .4s ease forwards;
    }
    .popup h2 {
      font-size:20px;
      color:var(--deep);
      margin-bottom:14px;
      font-weight:800;
    }
    .popup p {
      color:var(--muted);
      margin-bottom:16px;
    }
    .popup input {
      width:100%;
      padding:10px;
      border-radius:8px;
      border:1px solid #ccc;
      margin-bottom:10px;
      font-size:15px;
      text-align:center;
    }
    .popup button {
      background:var(--gold);
      border:none;
      color:#fff;
      font-weight:800;
      padding:10px 30px;
      border-radius:999px;
      cursor:pointer;
      transition:.2s;
    }
    .popup button:hover { background:#b8903c; }
    #errorMsg {
      color:#b94a48;
      font-size:14px;
      display:none;
      margin-top:8px;
    }
    @keyframes fadeIn { from{opacity:0} to{opacity:1} }
    @keyframes popIn { from{transform:scale(.8);opacity:0} to{transform:scale(1);opacity:1} }

    footer {
      margin-top:60px;
      text-align:center;
      padding:40px 10px;
      border-top:1px solid rgba(201,161,74,.35);
      color:var(--muted);
      font-size:14px;
      background:linear-gradient(135deg,rgba(201,161,74,.07),rgba(255,255,255,0));
    }
   .section { padding: 50px 20px; }
   .container { max-width: 1100px; margin: 0 auto; }
   .title { font-size: clamp(22px,3vw,28px); text-align: center; color: var(--deep); margin-bottom: 20px; position: relative; }
   .title::after { content: ""; display: block; width: 100px; height: 3px; background: linear-gradient(90deg,transparent,var(--gold),transparent); margin: 10px auto 0; border-radius: 2px; }
   .grid { display: grid; grid-template-columns: repeat(auto-fit,minmax(240px,1fr)); gap: 16px; }
   .feature { background: #fff; border: 1px solid rgba(201,161,74,.35); border-radius: 14px; padding: 18px; text-align: center; }
   .feature h3 { color: var(--deep); margin: 6px 0 4px; font-size: 18px; }
   .feature p { color: var(--muted); font-size: 14px; }
   .card { background: #fff; border-radius: 16px; padding: 28px; border: 1px solid rgba(201,161,74,.35); box-shadow: 0 12px 36px rgba(17,24,39,.06); }
   .hl { list-style: none; margin: 8px 0 0; padding: 0; }
   .hl li { padding: 8px 0 8px 20px; border-bottom: 1px dashed rgba(201,161,74,.35); position: relative; }
   .hl li::before { content: "â—†"; color: var(--gold); position: absolute; left: 0; top: 8px; }
   .survey-overlay{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:1200;}
   .survey-wrap{background:#fff;border:2px solid var(--gold);border-radius:16px;box-shadow:0 20px 60px rgba(0,0,0,.25);width:min(780px,94vw);max-height:90vh;overflow:auto;padding:20px;}
   .survey-head{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px}
   .survey-head h3{margin:0;font-size:18px;color:var(--deep);font-weight:800}
   .survey-close{appearance:none;border:0;background:#eee;border-radius:10px;padding:6px 10px;cursor:pointer}
   .survey-close:hover{background:#e4e4e4}
   .survey-wrap fieldset{margin:12px 0;padding:10px 12px;border:1px solid #eee;border-radius:10px}
   .survey-wrap legend{padding:0 6px;color:#444;font-weight:700}
   .survey-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}
   .btn{padding:10px 16px;border-radius:999px;border:2px solid var(--gold);font-weight:800;cursor:pointer}
   .btn-primary{background:var(--gold);color:#fff}
   .btn-primary:hover{opacity:.9}
   .btn-ghost{background:transparent;color:var(--gold)}
   .survey-toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#111;color:#fff;border-radius:10px;padding:10px 14px;font-size:14px;display:none;z-index:1300}
   
  </style>
</head>
<body>
  <!-- POP å½ˆçª— -->
  <div class="popup-overlay" id="vipPopup">
    <div class="popup">
      <h2>ğŸ’› æ™ºå¹³è¡¡ VIP å°ˆå±¬é‚€è«‹ ğŸ’›</h2>
      <p>è«‹è¼¸å…¥æ‚¨çš„å°ˆå±¬é‚€è«‹ç¢¼ä»¥é–‹å§‹é«”é©—</p>
      <input type="text" id="vipCode" placeholder="è«‹è¼¸å…¥é‚€è«‹ç¢¼" />
      <button id="confirmBtn">ç¢ºèª</button>
      <p id="errorMsg">é‚€è«‹ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>
    </div>
  </div>

  <header>
    <h1>æ™ºå¹³è¡¡æœƒå“¡é »é“ï½œå½±ç‰‡é«”é©—æ´»å‹•</h1>
    <div class="accent"></div>
    <p>å°ˆç‚ºæ™ºå¹³è¡¡æœƒå“¡æ‰“é€ çš„å½±ç‰‡é«”é©—ï¼Œé‚€è«‹æ‚¨é‡æ–°æ„Ÿå—ã€Œè¢«ç…§é¡§çš„å®‰å¿ƒæ„Ÿã€ã€‚<br>çœ‹å®Œå½±ç‰‡ä¸¦å®Œæˆ4æ”¯å½±ç‰‡çš„å•å·ï¼Œå°±æœ‰æ©Ÿæœƒç²å¾—åƒ¹å€¼ <b style="color:var(--gold)">è²´è³“å…¸è—ç¦®</b>ï¼</p>
  </header>

  <!-- ç¬¬ä¸€å€ï¼šHero æœƒå“¡é »é“ç™¼åˆŠå®£è¨€ -->
  <section class="hero">
    <div class="hero-intro">
      <h2>è¦ªæ„›çš„æœƒå“¡ï¼Œæ‚¨å¥½ã€‚</h2>
      <p>é€™æ˜¯ä¸€å€‹å±¬æ–¼æ‚¨çš„å°ˆå±¬æ™‚åˆ»ã€‚<br>æ”¾ä¸‹å¤–ç•Œçš„å–§å›‚ï¼Œè®“æˆ‘å€‘ä¸€èµ·å›åˆ°ã€Œè¢«ç…§é¡§ã€çš„ç¯€å¥ã€‚<br>æ™ºå¹³è¡¡é‚€è«‹æ‚¨ï¼Œé€éæ¯ä¸€æ®µçœŸèª çš„è²éŸ³ï¼Œé‡æ–°é€£çµèº«å¿ƒçš„ç©©å®šèˆ‡ä¿¡ä»»ã€‚</p>
    </div>
    <!-- å¯è‡ªè¡Œæ›¿æ›é€£çµ -->
    <iframe src="https://www.youtube.com/watch?v=G0T5fxefVLc" data-video-id="video001" allowfullscreen title="æœƒå“¡é »é“ç™¼åˆŠå®£è¨€" ></iframe>
  </section>

  <!-- ç¬¬äºŒå€ï¼šæ±é¢¨è¡›è¦–å°ˆè¨ª -->
  <section class="single-video">
    <iframe src="https://www.youtube.com/watch?v=OnvLbczesUU" data-video-id="video002" title="æ±é¢¨è¡›è¦–å°ˆè¨ª" allowfullscreen ></iframe>
    <h3>ã€Šæ±é¢¨è¡›è¦–å°ˆè¨ªï¼šç§‘æŠ€è®“é†«ç™‚å›åˆ°äººæœ¬ã€‹</h3>
    <p>é†«å¸«è«‡çš„ä¸åªæ˜¯æŠ€è¡“ï¼Œè€Œæ˜¯ä¸€ç¨®ã€Œä¸åƒè—¥ä¹Ÿèƒ½æ”¹å–„ã€çš„æ–°å¸Œæœ›ã€‚<br>é€é AI æ•¸æ“šèˆ‡ç©¿æˆ´ç›£æ¸¬ï¼Œè®“ç…§é¡§æ›´è²¼è¿‘æ¯å€‹äººçš„ç¯€å¥â€”â€”<br>ç‚ºä½ æ‰¾åˆ°å±¬æ–¼è‡ªå·±çš„å¥åº·æ–¹å¼ã€‚</p>
  </section>

  <!-- ç¬¬ä¸‰å€ï¼šé†«å¸«çœŸå¿ƒè©±-1ã€é†«å¸«çœŸå¿ƒè©±- -->
  <div class="grid-two">
    <article class="card">
      <div class="thumb">
        <!-- é†«å¸«çœŸå¿ƒè©±-1 -->
        <iframe src="https://www.youtube.com/watch?app=desktop&v=o0yUTESrNkg" data-video-id="video003" allowfullscreen title="é†«å¸«çœŸå¿ƒè©±-1"></iframe>
      </div>
      <div class="content">
        <h4>ã€Šé†«å¸«çœŸå¿ƒè©±ï¼šåƒè—¥è¶Šå¤šï¼Œç—…å»è¶Šé‡ï¼Ÿé†«å¸«æ­é–‹é—œéµçœŸç›¸ï¼</h4>
        <p>å¾ˆå¤šç—…äººæª¢æŸ¥éƒ½æ­£å¸¸ï¼Œå»å§‹çµ‚è¦ºå¾—ä¸èˆ’æœã€‚<br>
        åƒäº†å¾ˆå¤šè—¥ï¼Œç—‡ç‹€ä¸€æ™‚å£“ä¸‹å»ï¼Œå»åˆå†’å‡ºæ–°çš„å•é¡Œã€‚<br>
        ç‚ºä»€éº¼æœƒé€™æ¨£ï¼ŸåŸ·è¡Œé•·ç”¨20å¹´è‡¨åºŠç¶“é©—ï¼Œæ­é–‹ã€ŒåŠŸèƒ½æ€§å•é¡Œã€çš„çœŸç›¸â€”â€”<br>
        ğŸ‘‰ ä¸æ˜¯å£“ç—‡ç‹€ï¼Œè€Œæ˜¯è¦æ‰¾åˆ°èº«é«”å‡ºå•é¡Œçš„æºé ­ã€‚</p>
        <a class="cta" href="#q">å¡«å¯«å•å·</a>
      </div>
    </article>

    <article class="card">
      <div class="thumb">
        <!-- é†«å¸«çœŸå¿ƒè©±-2 -->
        <iframe src="https://www.youtube.com/watch?app=desktop&v=i0EfH6tqn4g&feature=youtu.be" allowfullscreen data-video-id="video004" title="é†«å¸«çœŸå¿ƒè©±-2"></iframe>
      </div>
      <div class="content">
        <h4>ã€Šé†«å¸«çœŸå¿ƒè©±ï¼šå­©å­ä¸è½è©±ï¼Ÿé†«å¸«æ•™ä½ ä¸€å€‹ä¸å¼ä¸ç½µçš„é—œéµæ–¹æ³•ï¼ ã€‹</h4>
        <p>é€™é›†åŸ·è¡Œé•·åˆ†äº«ä¸€å€‹çœŸå¯¦æ¡ˆä¾‹ï¼šä¸€ä½è€å¸«ã€çˆ¸çˆ¸éƒ½æŸæ‰‹ç„¡ç­–çš„å­©å­ï¼Œ<br>
        åªå› ç‚ºæ›äº†ã€Œç†è§£èˆ‡å•†é‡ã€çš„æ–¹å¼ï¼Œè¡Œç‚ºå°±æœ‰äº†æ˜é¡¯æ”¹è®Šã€‚</p>
        <a class="cta" href="#q">å¡«å¯«å•å·</a>
      </div>
    </article>
  </div>

  <!-- ç¬¬å››å€ï¼šæ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾©ã€ä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿é -->
  <div class="grid-two">
    <article class="card">
      <div class="thumb">
        <!-- æ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾© -->
        <iframe src="https://www.youtube.com/watch?v=v8Jx_GX2mgE" data-video-id="video005" allowfullscreen title="æ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾©"></iframe>
      </div>
      <div class="content">
        <h4>ã€Šè…¦æ´å¤§é–‹ï¼šæ­£å¿µ Ã— èŠ³é¦™ Ã— ä¿®å¾©ã€‹</h4>
        <p>å¾å—…è¦ºè¨“ç·´èˆ‡æƒ…ç·’ä¿®å¾©å‡ºç™¼ï¼Œé«”é©—èº«å¿ƒæ•´åˆçš„å¹³è¡¡ï¼Œæ‰¾åˆ°å±¬æ–¼ä½ çš„æ”¾é¬†ç¯€å¥ã€‚</p>
        <a class="cta" href="#q">å¡«å¯«å•å·</a>
      </div>
    </article>

    <article class="card">
      <div class="thumb">
        <!-- ä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿é -->
        <iframe src="https://www.youtube.com/watch?app=desktop&v=heS-mRhncAg&feature=youtu.be" allowfullscreen data-video-id="video006" title="è…¦æ´å¤§é–‹ï¼šä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿é"></iframe>
      </div>
      <div class="content">
        <h4>ã€Šè…¦æ´å¤§é–‹ï¼šåŸä¾†ã€Œå¤§è…¦ã€ä¹Ÿæœƒå½±éŸ¿å¤§ä¾¿ï¼Ÿé†«å¸«æ­é–‹é‡å­ç³¾çºçš„èº«é«”ç¥•å¯†ï¼ã€‹</h4>
        <p>ä½ ä»¥ç‚ºã€Œå¤§ä¾¿ä¸é †ã€åªæ˜¯è…¸å­çš„å•é¡Œå—ï¼ŸåŸ·è¡Œé•·åœ¨é–€è¨ºè£¡ç™¼ç¾ï¼ŒçœŸæ­£çš„é—œéµâ€”â€”å¯èƒ½è—åœ¨ã€Œä½ çš„å¤§è…¦ã€è£¡ã€‚</p>
        <a class="cta" href="#q">å¡«å¯«å•å·</a>
      </div>
    </article>
  </div>
<div class="survey-overlay" id="surveyOverlay" aria-hidden="true">
  <div class="survey-wrap" role="dialog" aria-modal="true" aria-labelledby="surveyTitle">
    <div class="survey-head">
      <h3 id="surveyTitle">å¡«å¯«å•å·</h3>
      <button class="survey-close" type="button" aria-label="é—œé–‰" id="surveyClose">é—œé–‰</button>
    </div>

    <form id="dynamic-form">
      <!-- éš±è—æ¬„ä½ï¼šè‡ªå‹•æ³¨å…¥ -->
      <input type="hidden" name="userId">
      <input type="hidden" name="videoId">
      <input type="hidden" name="youtubeId">
      <input type="hidden" name="title">
      <input type="hidden" name="openedAt">
      <input type="hidden" name="pageUrl" value="">
      <input type="hidden" name="sessionId" value="">
      <input type="hidden" name="surveyKey" value="">
      <!-- å•å·ä¸»é«”æœƒæ’å…¥åˆ°é€™è£¡ -->
      <div id="surveyQuestions" aria-live="polite"></div>

      <div class="survey-actions">
        <button type="button" class="btn btn-ghost" id="surveyCancel">å–æ¶ˆ</button>
        <button type="submit" class="btn btn-primary" aria-label="é€å‡ºå•å·">é€å‡ºå•å·</button>
      </div>
    </form>
  </div>
</div>
<div class="survey-toast" id="surveyToast" role="status" aria-live="polite">å·²é€å‡ºï¼Œæ„Ÿè¬ä½ çš„å›è¦†ï¼</div>

<section class="section container">
  <div class="card" id="vip">
    <h2 class="title" style="margin-top:0">å°åŒ—æ™¶è¯é…’åº—ï½œVIP é‚€è«‹ç››å®´</h2>
    <ul class="hl">
      <li>åŸ·è¡Œé•·å°ˆæ¥­æ¼”èªªï¼šå¾ç›¸æ‡‰ç¥ç¶“èª¿ç¯€ç™‚æ³•ã€AIåˆ°é‡å­å¥åº·çš„è‡¨åºŠæ‡‰ç”¨</li>
      <li>ç¬¬å…­ä»£ç´…å…‰æ¥µæ™ºè¡£ç¾å ´å±•ç¤ºèˆ‡é«”é©—</li>
      <li>è­·æ‚¨ç©©å¹³è¡¡è¡£ï¼šè®“å¥åº·ä¿é¤Šåœ¨ç¡çœ ä¸­è‡ªå‹•ç™¼ç”Ÿ</li>
    </ul>
    <div class="cta">
      <a id="goVip" href="" class="btn">å‰å¾€VIPç››å®´</a>
    </div>    
  </div>
</section>

  <footer>Â© 2025 æ™ºå¹³è¡¡å¥åº·é›†åœ˜ â€” æ„Ÿè¬æ‚¨ä¸€ç›´ä»¥ä¾†çš„ä¿¡ä»»ã€‚çœ‹å®Œå½±ç‰‡ä¸¦å®Œæˆå•å·ï¼Œå°±æœ‰æ©Ÿæœƒç²å¾— <span style="color:var(--gold)">5,000 å…ƒç²¾æ²¹ç¦®ç›’</span>ï¼</footer>

<script>
/** === è¨­å®š === */
const SURVEY_POST_URL = "https://23700999.com:8081/HMA/000TTEMemberChannelSurvey.jsp"; // â† æ›æˆä½ çš„å•å·ç´€éŒ„ API";
const API_LOG_EVENT = "https://23700999.com:8081/HMA/000TTELOG_EVENT.jsp";
const STORAGE_EVENTS_KEY  = "videoEvents";   // äº‹ä»¶æµæ°´å¸³ï¼ˆå¯é¸ï¼‰
const STORAGE_WATCHED_KEY = "watchedVideos"; // å®Œæˆæ¸…å–®ï¼ˆå¯é¸ï¼‰
const EventType="vipclub";
let vipId = new URLSearchParams(location.search).get("vip") || "unknown";
   //vipId="1111";
console.log("vipId="+vipId);
logEvent("leadingpage", EventType);

async function logEvent(Event, EventType) {
    const payload = {SafeKey:"qrt897hpmd", VIP: vipId, Event, EventType} ;
    console.log("payload1="+JSON.stringify(payload, null, 1));
       // 1) å…ˆå˜—è©¦ sendBeaconï¼ˆPOSTï¼ŒContent-Type: text/plain; charset=UTF-8ï¼‰
    try {
           const ok = navigator.sendBeacon(API_LOG_EVENT, new Blob(
           [JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }
          ));
          if (ok) {console.info("[logEvent] sendBeacon sent");return;}     
    } catch (e) {
         console.warn("[logEvent] sendBeacon failed, fallback to fetch no-cors", e);
    }
      // 2) fallback: simple requestï¼ˆno-cors + text/plain â†’ ä¸æœƒ preflightï¼‰
    try {
             await fetch(API_LOG_EVENT, {
               method: "POST",
               mode: "no-cors",
               headers: { "Content-Type": "text/plain;charset=UTF-8" }, // æ³¨æ„ï¼šä¸è¦ application/json
               body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
               keepalive: true,
               });
              console.info("[logEvent] fetch(no-cors) sent (opaque response)");
        } catch (err) {
             console.error("[logEvent] still failed:", err);
          }
}

/** VIP è§£é– â†’ æŠŠ code ç•¶ä½œ userId å„²å­˜ï¼ˆè‹¥ä½ è¦ï¼‰ */
function bindVipUnlock() {
  const popup = document.getElementById("vipPopup");
  const btn = document.getElementById("confirmBtn");
  const input = document.getElementById("vipCode");
  const error = document.getElementById("errorMsg");
  if (!btn || !input || !popup) return;
  btn.addEventListener("click", () => {
    const code = input.value.trim();
    if (code === "1314") {
      popup.style.display = "none";
      logEvent("unlock_success", EventType);
    } else {
      error.style.display = "block";
      input.value = "";
      logEvent("unlock_failed", EventType);
    }
  });
}

/** === å–å¾—ä½¿ç”¨è€…IDï¼ˆå„ªå…ˆåºï¼šwindow.USER_ID â†’ URL ?uid â†’ localStorage â†’ VIPç¢¼ï¼‰ === */
function getUserId() {
  if (window.USER_ID && String(window.USER_ID).trim()) return String(window.USER_ID).trim();
  const urlUid = new URLSearchParams(location.search).get("uid");
  if (urlUid) { localStorage.setItem("userId", urlUid); return urlUid; }
  const saved = localStorage.getItem("userId");
  if (saved) return saved;
  // å…ˆå›å‚³æš«æ™‚IDï¼Œè‹¥ VIP ä¹‹å¾Œè¼¸å…¥æˆåŠŸæœƒè¦†è“‹
  const gen = "guest_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("userId", gen);
  return gen;
}

/** === åŸºç¤å·¥å…· === */
function appendLocalEvent(evt) {
  try {
    const arr = JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]");
    arr.push(evt);
    localStorage.setItem(STORAGE_EVENTS_KEY, JSON.stringify(arr));
  } catch {}
}

/** è§£æ YouTube ä¾†æºç‚º { id(ytId), url(å¯è¿½è¹¤embed) } */
function normalizeYouTubeSrc(src) {
  if (!src) return null;
  const be = src.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
  const watch = src.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  const embed = src.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
  const ytId = be?.[1] || watch?.[1] || embed?.[1];
  if (!ytId) return null;
  const url = new URL("https://www.youtube-nocookie.com/embed/" + ytId);
  url.searchParams.set("enablejsapi", "1");
  url.searchParams.set("rel", "0");
  url.searchParams.set("modestbranding", "1");
  url.searchParams.set("playsinline", "1");
  return { id: ytId, url: url.toString() };
}

/** æƒæ iframes â†’ æ­£è¦åŒ– â†’ è£œè³‡æ–™å±¬æ€§ */
function prepareIframes() {
  const iframes = Array.from(document.querySelectorAll("iframe"));
  let idx = 0;
  for (const el of iframes) {
    const norm = normalizeYouTubeSrc(el.getAttribute("src"));
    if (!norm) continue;

    el.src = norm.url;
    if (!el.id) el.id = `ytp-${++idx}`;

    let title = el.getAttribute("title") || `video-${idx}`;
    const card = el.closest(".card, .single-video, .hero");
    const h = card?.querySelector("h3, h4, h2");
    if (h?.textContent) title = h.textContent.trim();

    el.dataset.track    = "yt";
    el.dataset.title    = title;
    el.dataset.youtubeId= norm.id;                 // çœŸæ­£ YouTube ID
    el.dataset.videoId  = el.dataset.videoId || norm.id; // ä½ çš„å•†å‹™IDï¼ˆæœªå¡«å°±ç”¨ ytIdï¼‰
  }
}

/** æ’­æ”¾å™¨&ç‹€æ…‹æ——æ¨™ */
const players = {};
const flags = {}; // { [iframeId]: { clicked, sent50, sent100 } }

/** æ¨™è¨˜ 100% å®Œæˆæ¸…å–®ï¼ˆå¯é¸ï¼‰ */
function markWatched(record) {
  try {
    const list = JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]");
    if (!list.find(x => x.videoId === record.videoId)) {
      list.push(record);
      localStorage.setItem(STORAGE_WATCHED_KEY, JSON.stringify(list));
    }
  } catch {}
}

/** é€äº‹ä»¶çš„çµ±ä¸€å‡½å¼ */
function sendProgress({ iframeId, status, player, meta }) {
  const duration = Math.round(player?.getDuration?.() || 0);
  const watched  = Math.round(player?.getCurrentTime?.() || 0);
  const payload = {
    vipId,
    status,                    // "click" | "50" | "100"
    videoId:   meta.videoId,   // ä½ çš„å•†å‹™ID
    youtubeId: meta.youtubeId, // çœŸæ­£ YT ID
    title:     meta.title,
    watchedSec: watched,
    duration,
    ts: new Date().toISOString()
  };
  console.log("payload1="+JSON.stringify(payload, null, 1));
  //postEvent(payload);
  if (status === "100") {
    markWatched(payload);
  }
}

/** å»ºç«‹æ’­æ”¾å™¨ä¸¦è¿½è¹¤ click / 50% / 100% */
function createPlayers() {
  const iframes = Array.from(document.querySelectorAll('iframe[data-track="yt"]'));
  iframes.forEach((el) => {
    const iframeId = el.id;
    const meta = {
      videoId:   el.dataset.videoId,
      youtubeId: el.dataset.youtubeId,
      title:     el.dataset.title || el.title || el.dataset.videoId || el.dataset.youtubeId
    };
    flags[iframeId] = { clicked: false, sent50: false, sent100: false };

    players[iframeId] = new YT.Player(iframeId, {
      events: {
        onStateChange: (e) => {
          const state  = e.data;
          const player = players[iframeId];

          // clickï¼ˆé¦–æ¬¡æ’­æ”¾ï¼‰
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].clicked) {
            flags[iframeId].clicked = true;
            sendProgress({ iframeId, status: "click", player, meta });
            logEvent("videoPlay_"+el.dataset.videoId, EventType);
          }

          // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è·¨é 50%
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].sent50) {
            if (!flags[iframeId].halfTimer) {
              flags[iframeId].halfTimer = setInterval(() => {
                try {
                  const d = player.getDuration?.() || 0;
                  const c = player.getCurrentTime?.() || 0;
                  if (d > 0 && c / d >= 0.5 && !flags[iframeId].sent50) {
                    flags[iframeId].sent50 = true;
                    sendProgress({ iframeId, status: "50", player, meta });
                    logEvent("videoPlay50_"+el.dataset.videoId, EventType);
                    clearInterval(flags[iframeId].halfTimer);
                    flags[iframeId].halfTimer = null;
                  }
                } catch {}
              }, 1000);
            }
          }

          // 100%ï¼ˆæ’­æ”¾çµæŸï¼‰
          if (state === YT.PlayerState.ENDED && !flags[iframeId].sent100) {
            flags[iframeId].sent100 = true;
            if (flags[iframeId].halfTimer) {
              clearInterval(flags[iframeId].halfTimer);
              flags[iframeId].halfTimer = null;
            }
            sendProgress({ iframeId, status: "100", player, meta });
            logEvent("videoPlay100_"+el.dataset.videoId, EventType);
          }
        }
      }
    });
  });
}

/** å•Ÿå‹• */
document.addEventListener("DOMContentLoaded", () => {
  prepareIframes();
  bindVipUnlock();
   // è®“ VIP é€£çµå¸¶ä¸Š ?vip=
  wireVipLink();
  const s = document.createElement("script");
  s.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
});
window.onYouTubeIframeAPIReady = createPlayers;



/** ===== å››æ”¯å½±ç‰‡çš„å•å·å®šç¾©ï¼ˆä¾ä½ çš„ data-video-id å°æ‡‰ï¼‰===== */
/** å»ºè­°å°æ‡‰ä¸‹åˆ— 4 æ”¯ï¼š
 *  video003ï¼šé†«å¸«çœŸå¿ƒè©±-1
 *  video004ï¼šé†«å¸«çœŸå¿ƒè©±-2
 *  video005ï¼šæ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾©
 *  video006ï¼šä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿é
 * è‹¥ä½ æƒ³ç”¨ youtubeId å°æ‡‰ï¼Œä¹Ÿå¯åœ¨ SURVEY_DEFS ç”¨ key: 'o0yUTESrNkg' é€™ç¨®å¯«æ³•ã€‚
 */
const SURVEY_DEFS = {
  /* é†«å¸«çœŸå¿ƒè©±-1ï¼ˆæ²¿ç”¨ä½ æä¾›çš„Bé¡å•å·ï¼‰ */
  "video003": {
    title: "é†«å¸«çœŸå¿ƒè©±-1ï½œä¸æ˜¯æ§åˆ¶ç—‡ç‹€ï¼Œè€Œæ˜¯æ‰¾å›æºé ­ï¼ˆB é¡å•å·ï¼‰",
    html: `
      <fieldset aria-labelledby="q1" data-role="q1" data-metric="ç†è§£å³°" data-imprint="æ´è¦‹" data-cta="First Visit">
        <legend id="q1">Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q1" value="æˆ‘å€‘ä¸è¦ä¸€ç›´åªé‡å°ç—‡ç‹€ï¼Œæ‡‰è©²æ˜¯å»æ‰¾åŸå› ï¼ŒæŠŠå•é¡Œè§£æ±ºæ‰" required> æˆ‘å€‘ä¸è¦ä¸€ç›´åªé‡å°ç—‡ç‹€ï¼Œæ‡‰è©²æ˜¯å»æ‰¾åŸå› ï¼ŒæŠŠå•é¡Œè§£æ±ºæ‰ã€‚</label><br>
        <label><input type="radio" name="q1" value="è—¥ç‰©åªæ˜¯æŒ–æ±ç‰†è£œè¥¿ç‰†"> è—¥ç‰©åªæ˜¯æŒ–æ±ç‰†è£œè¥¿ç‰†ï¼Œè¶Šè£œè¶Šäº‚ã€‚</label><br>
        <label><input type="radio" name="q1" value="äººé«”æœ¬èº«æœ‰éå¸¸ç²¾å¯†çš„é‹ä½œï¼Œä¸éœ€è¦è¢«éåº¦æ§åˆ¶"> äººé«”æœ¬èº«æœ‰éå¸¸ç²¾å¯†çš„é‹ä½œï¼Œä¸éœ€è¦è¢«éåº¦æ§åˆ¶ã€‚</label><br>
        <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š"> æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q2" data-role="q2" data-metric="æ±ºç­–" data-imprint="è¡Œå‹•æ„åœ–" data-cta="Immediate Conversion">
        <legend id="q2">Q2ï½œä»Šå¤©ä½ æœ€æƒ³å…ˆå®Œæˆå“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q2" value="æ‰¾å‡ºè‡ªå·±é•·æœŸä¸èˆ’æœçš„ã€ŒçœŸæ­£åŸå› ã€" required> æ‰¾å‡ºè‡ªå·±é•·æœŸä¸èˆ’æœçš„ã€ŒçœŸæ­£åŸå› ã€ã€‚</label><br>
        <label><input type="radio" name="q2" value="å˜—è©¦æ¸›å°‘ä¸€ç¨®é•·æœŸæœç”¨çš„è—¥ç‰©ï¼Œä¸¦è§€å¯Ÿè®ŠåŒ–"> å˜—è©¦æ¸›å°‘ä¸€ç¨®é•·æœŸæœç”¨çš„è—¥ç‰©ï¼Œä¸¦è§€å¯Ÿè®ŠåŒ–ã€‚</label><br>
        <label><input type="radio" name="q2" value="å­¸æœƒè¨˜éŒ„ç—‡ç‹€èˆ‡ç”Ÿæ´»ä½œæ¯ä¹‹é–“çš„é—œè¯"> å­¸æœƒè¨˜éŒ„ç—‡ç‹€èˆ‡ç”Ÿæ´»ä½œæ¯ä¹‹é–“çš„é—œè¯ã€‚</label><br>
        <label><input type="radio" name="q2" value="è«®è©¢å°ˆæ¥­é†«å¸«ï¼Œäº†è§£åŠŸèƒ½æ€§å•é¡Œçš„æ ¹æº"> è«®è©¢å°ˆæ¥­é†«å¸«ï¼Œäº†è§£åŠŸèƒ½æ€§å•é¡Œçš„æ ¹æºã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q3" data-role="q3" data-metric="å¯¦è¸" data-imprint="è¡Œå‹•å°è¨˜" data-cta="Repeat Engagement">
        <legend id="q3">Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q3" value="å¯¦ä½œä¸€æ¬¡ã€Œæ‰¾åŸå› è€Œéæ­¢ç—‡ç‹€ã€çš„å¥åº·æª¢è¦–" required> å¯¦ä½œä¸€æ¬¡ã€Œæ‰¾åŸå› è€Œéæ­¢ç—‡ç‹€ã€çš„å¥åº·æª¢è¦–ã€‚</label><br>
        <label><input type="radio" name="q3" value="é‡æ–°æ•´ç†è‡ªå·±çš„ç”¨è—¥èˆ‡èº«é«”è®ŠåŒ–ç´€éŒ„"> é‡æ–°æ•´ç†è‡ªå·±çš„ç”¨è—¥èˆ‡èº«é«”è®ŠåŒ–ç´€éŒ„ã€‚</label><br>
        <label><input type="radio" name="q3" value="ç·´ç¿’ä¸€å¤©ä¸ä¾è³´æ­¢ç—›è—¥ã€è§€å¯Ÿèº«é«”åæ‡‰"> ç·´ç¿’ä¸€å¤©ä¸ä¾è³´æ­¢ç—›è—¥ã€è§€å¯Ÿèº«é«”åæ‡‰ã€‚</label><br>
        <label><input type="radio" name="q3" value="èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œå¾æºé ­çœ‹ç—…ã€çš„æ–°è§€é»"> èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œå¾æºé ­çœ‹ç—…ã€çš„æ–°è§€é»ã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q4" data-role="q4" data-metric="å…±å‰µ" data-imprint="ä¿¡ä»»å°è¨˜" data-cta="Referral/Advocacy">
        <legend id="q4">Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
        <label><input type="checkbox" name="q4[]" value="å­¸æœƒå¦‚ä½•æ‰¾å‡ºåŠŸèƒ½æ€§å•é¡Œçš„çœŸæ­£æºé ­"> å­¸æœƒå¦‚ä½•æ‰¾å‡ºåŠŸèƒ½æ€§å•é¡Œçš„çœŸæ­£æºé ­ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="äº†è§£ã€Œèº«é«”è¨Šè™Ÿã€èˆ‡ã€Œè‡ªå¾‹ç¥ç¶“ã€ä¹‹é–“çš„é€£å‹•"> äº†è§£ã€Œèº«é«”è¨Šè™Ÿã€èˆ‡ã€Œè‡ªå¾‹ç¥ç¶“ã€ä¹‹é–“çš„é€£å‹•ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="çœ‹å¯¦ä¾‹"> çœ‹å¯¦ä¾‹ï¼šä¸ç”¨è—¥ä¹Ÿèƒ½æ”¹å–„çš„è‡¨åºŠæ¡ˆä¾‹ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="å­¸æœƒå»ºç«‹å±¬æ–¼è‡ªå·±çš„å¥åº·èª¿ç¯€è¨ˆç•«"> å­¸æœƒå»ºç«‹å±¬æ–¼è‡ªå·±çš„å¥åº·èª¿ç¯€è¨ˆç•«ã€‚</label><br>
        <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
      </fieldset>
    `
  },

  /* é†«å¸«çœŸå¿ƒè©±-2ï¼ˆæ•™é¤Šæƒ…å¢ƒï¼‰ */
  "video004": {
    title: "é†«å¸«çœŸå¿ƒè©±-2ï½œä¸å¼ä¸ç½µçš„é—œéµæ–¹æ³•ï¼ˆæ•™é¤Šæƒ…å¢ƒå•å·ï¼‰",
    html: `
       <fieldset data-role="q1" data-metric="ç†è§£å³°" data-cta="First Visit" data-imprint="ç†è§£">
        <legend>Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q1" value="é›–ä¸æ»¿æ„ï¼Œä½†å¯ä»¥å•†é‡çš„æ–¹å¼ï¼Œä¸€æ¬¡åˆä¸€æ¬¡å»é«”æœƒ">ã€Œé›–ä¸æ»¿æ„ï¼Œä½†å¯ä»¥å•†é‡çš„æ–¹å¼ï¼Œä¸€æ¬¡åˆä¸€æ¬¡å»é«”æœƒã€‚ã€</label><br>
        <label><input type="radio" name="q1" value="çµ¦ä»–äº”åˆ†é˜æŠŠäº‹æƒ…åšå®Œï¼Œç„¶å¾Œå†ä¹–ä¹–ä¸Šèª²">ã€Œçµ¦ä»–äº”åˆ†é˜æŠŠäº‹æƒ…åšå®Œï¼Œç„¶å¾Œå†ä¹–ä¹–ä¸Šèª²ã€‚ã€</label><br>
        <label><input type="radio" name="q1" value="ä¸å–œæ­¡å°±å†·è™•ç†ï¼Œè½‰ç§»æ³¨æ„åŠ›">ã€Œä¸å–œæ­¡å°±å†·è™•ç†ï¼Œè½‰ç§»æ³¨æ„åŠ›ï¼Œå¸¶ä»–å»åšä»–å–œæ­¡çš„äº‹ã€‚ã€</label><br>
        <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š">æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
       </fieldset> 
    <fieldset data-role="q2" data-metric="è¡Œå‹•æ±ºç­–" data-cta="Immediate Conversion" data-imprint="è¡Œå‹•">
    <legend>Q2ï½œç›®å‰ä½ æœ€æƒ³å…ˆå˜—è©¦å“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q2" value="ç·´ç¿’çŸ­æ™‚æ®µå”å•†">åœ¨æ—¥å¸¸ä¸­ç·´ç¿’ã€ŒçŸ­æ™‚æ®µå®Œæˆä»»å‹™ã€çš„å”å•†ï¼ˆä¾‹å¦‚ï¼šçµ¦ 5 åˆ†é˜ï¼‰ã€‚</label><br>
    <label><input type="radio" name="q2" value="å†·è™•ç†èˆ‡è½‰ç§»">å­¸æœƒå¦‚ä½•ç”¨ã€Œå†·è™•ç†ï¼‹è½‰ç§»ã€æ¸›å°‘å°æ–¹è² é¢åæ‡‰ã€‚</label><br>
    <label><input type="radio" name="q2" value="å”å•†å…±è­˜">èˆ‡è€å¸«/å®¶é•·å”å•†ä¸€è‡´çš„è¡Œç‚ºç®¡ç†å°ç­–ç•¥ï¼ˆå¯åŸ·è¡Œçš„æ­¥é©Ÿï¼‰ã€‚</label><br>
    <label><input type="radio" name="q2" value="å…ˆè§€å¯Ÿè¡Œç‚ºæ¨¡å¼">å…ˆè§€å¯Ÿå­©å­/ç•¶äº‹äººä¸€é€±çš„è¡Œç‚ºæ¨¡å¼å†æ±ºå®šã€‚</label>
  </fieldset>

  <fieldset data-role="q3" data-metric="ä»»å‹™åŒ–è¡Œå‹•" data-cta="Repeat Engagement" data-imprint="è¡Œå‹•">
    <legend>Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q3" value="å”å•†æµç¨‹ç´€éŒ„">å˜—è©¦ä¸€æ¬¡ã€Œçµ¦ 5 åˆ†é˜å®Œæˆ â†’ å†ä¸Šèª²ã€çš„å”å•†æµç¨‹ä¸¦è¨˜éŒ„çµæœã€‚</label><br>
    <label><input type="radio" name="q3" value="å¿½ç•¥è½‰ç§»ç·´ç¿’">ç·´ç¿’ã€Œå¿½ç•¥ä¸ç•¶è¡Œç‚º â†’ ç«‹å³è½‰ç§»åˆ°å–œæ­¡æ´»å‹•ã€å…©æ¬¡ä»¥ä¸Šã€‚</label><br>
    <label><input type="radio" name="q3" value="æºé€šå…±è­˜å»ºç«‹">èˆ‡è€å¸«æºé€šä¸¦å»ºç«‹ç°¡å–®çš„è¡Œç‚ºè™•ç†å…±è­˜ï¼ˆåŒä¸€å€‹æŒ‡ä»¤/å›é¥‹èªï¼‰ã€‚</label><br>
    <label><input type="radio" name="q3" value="å°‹æ±‚å°ˆæ¥­è«®è©¢">æ‰¾å°ˆæ¥­è«®è©¢ï¼Œäº†è§£è¡Œç‚ºèƒŒå¾Œçš„å¯èƒ½åŸå› èˆ‡èª¿æ•´æ–¹å‘ã€‚</label>
  </fieldset>

  <fieldset data-role="q4" data-metric="å…±å‰µé¡˜æ™¯" data-cta="Referral/Advocacy" data-imprint="ä¿¡ä»»">
    <legend>Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
    <label><input type="checkbox" name="q4[]" value="ç¤ºç¯„å®Œæ•´æµç¨‹">ç¤ºç¯„ä¸€å€‹å®Œæ•´çš„ã€Œ5 åˆ†é˜å”å•† â†’ å›èª²ç¨‹ã€æ“ä½œæµç¨‹ï¼ˆå¯æ¨¡ä»¿ï¼‰ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="è€å¸«è§’åº¦åŸ·è¡Œ">ç¤ºç¯„å¦‚ä½•åœ¨èª²å ‚ä¸Šç”¨ã€Œå†·è™•ç†ï¼‹è½‰ç§»ã€å®‰å…¨åŸ·è¡Œï¼ˆè€å¸«è§’åº¦ï¼‰ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="ä¸‰å¥å¯ç”¨èªå¥">æä¾›å®¶é•·ï¼è€å¸«èƒ½ç”¨çš„ 3 å€‹å³åˆ»å¯ç”¨çš„èªå¥æˆ–æ­¥é©Ÿã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æƒ…ç·’æ”¯æŒè¨è«–">è¨è«–è¡Œç‚ºæ”¹è®Šæ™‚å¸¸è¦‹çš„æƒ…ç·’åæ‡‰èˆ‡å¦‚ä½•æ”¯æŒï¼ˆå®¶é•·æƒ…ç·’é¢ï¼‰ã€‚</label>
    <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
  </fieldset> `
  },

  /* æ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾©ï¼ˆèº«å¿ƒæ”¾é¬†ï¼‰ */
  "video005": {
    title: "é†«å¸«çœŸå¿ƒè©±-4 å•å·ï½œå—…è¦ºä¿®å¾©èˆ‡å¤§è…¦é‡å•Ÿ",
    html: `
       <fieldset data-role="q1" data-metric="ç†è§£å³°" data-cta="First Visit" data-imprint="ç†è§£">
    <legend>Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q1" value="ç–«æƒ…æ”¹è®Šäº†æˆ‘å€‘çš„å¤§è…¦">ã€Œç–«æƒ…æ”¹è®Šäº†ä¸–ç•Œï¼Œä¹Ÿæ‚„æ‚„æ”¹è®Šäº†æˆ‘å€‘çš„å¤§è…¦ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="å—…è¦ºæ˜¯é€šå¾€å¤§è…¦çš„ç›´æ¥é€šé“">ã€Œå—…è¦ºæ˜¯é€šå¾€å¤§è…¦æœ€ç›´æ¥çš„é€šé“ï¼Œèƒ½é‡æ–°é€£çµè¨˜æ†¶èˆ‡æƒ…ç·’ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æ­£å¿µèˆ‡å‘¼å¸èƒ½ä¿®å¾©ç¥ç¶“é€£çµ">ã€Œçµåˆæ­£å¿µèˆ‡ç©©å®šå‘¼å¸ï¼Œå¤§è…¦çš„ç¥ç¶“é€£çµæœƒé–‹å§‹ä¿®å¾©ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š">æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
  </fieldset>

  <fieldset data-role="q2" data-metric="è¡Œå‹•æ±ºç­–" data-cta="Immediate Conversion" data-imprint="è¡Œå‹•">
    <legend>Q2ï½œä»Šå¤©ä½ æœ€æƒ³å…ˆå˜—è©¦å“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q2" value="æ¯æ—¥é¦™æ°£ç·´ç¿’">æ¯å¤©ç¡å‰é€²è¡Œ 2 åˆ†é˜ã€Œèé¦™ï¼‹æ·±å‘¼å¸ã€è¨“ç·´ã€‚</label><br>
    <label><input type="radio" name="q2" value="å»ºç«‹å—…è¦ºå„€å¼">ç‚ºè‡ªå·±å»ºç«‹å›ºå®šæ™‚é–“çš„å—…è¦ºæ”¾é¬†å„€å¼ï¼ˆæ—©æ™¨æˆ–æ™šé–“ï¼‰ã€‚</label><br>
    <label><input type="radio" name="q2" value="è¨˜éŒ„æƒ…ç·’è®ŠåŒ–">è¨˜éŒ„å—…è¦ºç·´ç¿’å¾Œçš„å°ˆæ³¨åŠ›ã€æƒ…ç·’è®ŠåŒ–ã€‚</label><br>
    <label><input type="radio" name="q2" value="äº†è§£ä¿®å¾©æ©Ÿåˆ¶">é–±è®€æˆ–äº†è§£ã€Œå¤§è…¦ä¿®å¾©èˆ‡å—…è¦ºç¥ç¶“é€£çµã€çš„ç›¸é—œç ”ç©¶ã€‚</label>
  </fieldset>

  <fieldset data-role="q3" data-metric="ä»»å‹™åŒ–è¡Œå‹•" data-cta="Repeat Engagement" data-imprint="è¡Œå‹•">
    <legend>Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q3" value="é€£çºŒä¸ƒå¤©èé¦™è¨“ç·´">é€£çºŒä¸ƒå¤©ç¡å‰èé¦™ï¼‹æ·±å‘¼å¸ 2 åˆ†é˜ã€‚</label><br>
    <label><input type="radio" name="q3" value="é…åˆæ­£å¿µå†¥æƒ³">æ¯å¤©æ—©ä¸Šé…åˆ 3 åˆ†é˜æ­£å¿µå‘¼å¸èˆ‡å—…è¦ºè§€å¯Ÿã€‚</label><br>
    <label><input type="radio" name="q3" value="æ¸›å°‘éåº¦åˆºæ¿€">æ¸›å°‘å¤šå·¥èˆ‡è—å…‰å¹²æ“¾ï¼Œè§€å¯Ÿè…¦éœ§æ”¹å–„è®ŠåŒ–ã€‚</label><br>
    <label><input type="radio" name="q3" value="åˆ†äº«ä¿®å¾©å¿ƒå¾—">èˆ‡æœ‹å‹æˆ–å®¶äººåˆ†äº«ã€Œå—…è¦ºä¿®å¾©ã€çš„é«”é©—å¿ƒå¾—ã€‚</label>
  </fieldset>

  <fieldset data-role="q4" data-metric="å…±å‰µé¡˜æ™¯" data-cta="Referral/Advocacy" data-imprint="ä¿¡ä»»">
    <legend>Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
    <label><input type="checkbox" name="q4[]" value="ç¤ºç¯„å—…è¦ºç·´ç¿’">ç¤ºç¯„ä¸€æ®µå®Œæ•´çš„ã€Œå—…è¦ºä¿®å¾©ã€ç·´ç¿’æµç¨‹ï¼ˆå«å‘¼å¸æŒ‡å°ï¼‰ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="è§£é‡‹è…¦éœ§èˆ‡å£“åŠ›é—œè¯">è¬›è§£ã€Œè…¦éœ§ã€ç„¦æ…®ã€èˆ‡è‡ªå¾‹ç¥ç¶“çš„é—œè¯æ©Ÿåˆ¶ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æä¾›é¦™æ°£æŒ‡å—">æä¾›ä¸åŒé¦™æ°£å°æƒ…ç·’èˆ‡è¨˜æ†¶ä¿®å¾©çš„æŒ‡å—ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="å»¶ä¼¸ç¥ç¶“ä¿®å¾©ä¸»é¡Œ">å»¶ä¼¸æ¢è¨ã€Œäº”æ„Ÿä¿®å¾© Ã— ç¥ç¶“å¯å¡‘æ€§ã€çš„ç”Ÿæ´»æ‡‰ç”¨ã€‚</label>
    <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
  </fieldset>

    `
  },

  /* ä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿éï¼ˆè…¸è…¦è»¸ï¼‰ */
  "video006": {
    title: "è…¦æ´å¤§é–‹ï¼šä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿éï¼ˆè…¸è…¦è»¸è‡ªè©•å•å·ï¼‰",
    html: `
       <fieldset data-role="q1" data-metric="ç†è§£å³°" data-cta="First Visit" data-imprint="ç†è§£">
    <legend>Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q1" value="ä½ çš„å¤§è…¦æ„è­˜èˆ‡å¤§è…¸å…¶å¯¦æœ‰é‡å­çš„é—œä¿‚">ã€Œä½ çš„å¤§è…¦çš„æ„è­˜è·Ÿå¤§è…¸å…¶å¯¦æœ‰é‡å­çš„é—œä¿‚ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æ»‘æ‰‹æ©Ÿæœƒè®“å¤§è…¦å’Œè…¸å­åˆ†é›¢">ã€Œæ»‘æ‰‹æ©Ÿçš„æ™‚å€™ï¼Œå¤§è…¦å’Œè…¸å­æ˜¯åˆ†é›¢çš„ï¼Œå„åšå„çš„ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="è§€å¯Ÿè…¸å­çš„å‹•ä½œæœƒè®“æ’ä¾¿æ›´é †">ã€Œç•¶ä½ è§€å¯Ÿè…¸å­çš„å‹•ä½œã€æ”¾æ…¢å‘¼å¸æ™‚ï¼Œæ’ä¾¿æœƒè®Šå¾—å¾ˆé †ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š">æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
  </fieldset>

  <fieldset data-role="q2" data-metric="è¡Œå‹•æ±ºç­–" data-cta="Immediate Conversion" data-imprint="è¡Œå‹•">
    <legend>Q2ï½œä»Šå¤©ä½ æœ€æƒ³å…ˆå˜—è©¦å“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q2" value="æ’ä¾¿æ™‚ä¸æ»‘æ‰‹æ©Ÿ">æ’ä¾¿æ™‚æš«åœæ»‘æ‰‹æ©Ÿï¼Œå°ˆå¿ƒè§€å¯Ÿå‘¼å¸èˆ‡è…¸é“å‹•ä½œã€‚</label><br>
    <label><input type="radio" name="q2" value="ç·´ç¿’é‡å­è§€å¯Ÿæ³•">æ¯å¤©æ—©ä¸Šç·´ç¿’ 3 åˆ†é˜ã€Œé‡å­è§€å¯Ÿã€èº«é«”ç‹€æ…‹ã€‚</label><br>
    <label><input type="radio" name="q2" value="å»ºç«‹æ’ä¾¿å„€å¼">å›ºå®šæ™‚é–“ã€å›ºå®šå§¿å‹¢åœ°å»ºç«‹æ’ä¾¿å„€å¼æ„Ÿã€‚</label><br>
    <label><input type="radio" name="q2" value="è¨˜éŒ„èº«é«”åæ‡‰">è¨˜éŒ„ä¸€é€±å…§æ’ä¾¿èˆ‡å¿ƒæƒ…è®ŠåŒ–çš„é—œè¯ã€‚</label>
  </fieldset>

  <fieldset data-role="q3" data-metric="ä»»å‹™åŒ–è¡Œå‹•" data-cta="Repeat Engagement" data-imprint="è¡Œå‹•">
    <legend>Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q3" value="è§€å¯Ÿæ’ä¾¿ç¯€å¥">è§€å¯Ÿä¸€æ¬¡å®Œæ•´çš„ã€Œæ”¾ä¸‹æ‰‹æ©Ÿâ†’è§€å¯Ÿâ†’é †åˆ©æ’å‡ºã€éç¨‹ã€‚</label><br>
    <label><input type="radio" name="q3" value="æ¯æ—¥ä¸‰åˆ†é˜è§€å¯Ÿ">æ¯å¤©ä¸‰åˆ†é˜éœåè§€å¯Ÿè…¹éƒ¨èµ·ä¼ã€‚</label><br>
    <label><input type="radio" name="q3" value="æ¸›å°‘å¹²æ“¾ç·´ç¿’">å˜—è©¦åœ¨å¦‚å»æ™‚æ¸›å°‘å¤–åœ¨å¹²æ“¾ï¼Œé«”é©—å·®ç•°ã€‚</label><br>
    <label><input type="radio" name="q3" value="åˆ†äº«é«”é©—">èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œèº«é«”æ„è­˜èˆ‡æ’ä¾¿é †æš¢ã€çš„é«”é©—ã€‚</label>
  </fieldset>

  <fieldset data-role="q4" data-metric="å…±å‰µé¡˜æ™¯" data-cta="Referral/Advocacy" data-imprint="ä¿¡ä»»">
    <legend>Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
    <label><input type="checkbox" name="q4[]" value="ç¤ºç¯„è§€å¯Ÿç·´ç¿’">ç¤ºç¯„ä¸€å€‹ã€Œè§€å¯Ÿè…¸é“èˆ‡å‘¼å¸ã€çš„å¯¦éš›ç·´ç¿’æµç¨‹ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="è§£æè…¸è…¦é€£ç·š">è¬›è§£ã€Œè…¸è…¦è»¸ç·šã€èˆ‡èº«å¿ƒå¥åº·çš„å…·é«”é—œè¯ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æä¾›è‡ªæˆ‘æª¢æ¸¬è¡¨">æä¾›ä¸€ä»½ã€Œè…¸è…¦åŒæ­¥ç‹€æ…‹ã€çš„è‡ªæˆ‘æª¢æ¸¬è¡¨ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æ¢è¨å°ˆæ³¨èˆ‡å¥åº·">è¨è«–ç¾ä»£äººå°ˆæ³¨åŠ›èˆ‡èº«é«”ä¿¡è™Ÿçš„é—œä¿‚ã€‚</label>
    <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
  </fieldset>
    `
  }
};

/** ===== å‚³é€ JSONï¼ˆsendBeacon å„ªå…ˆï¼‰ ===== */
function postJSON(url, data) {
  try {
    const ok = navigator.sendBeacon?.(url, new Blob([JSON.stringify(data)], {type:"application/json"}));
    if (ok) return Promise.resolve();
  } catch {}
  return fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data), keepalive:true })
    .then(()=>{}).catch(()=>{});
}

/** ===== UI æ§åˆ¶èˆ‡æ¸²æŸ“ ===== */
const $overlay = document.getElementById("surveyOverlay");
const $form = document.getElementById("dynamic-form");
const $close = document.getElementById("surveyClose");
const $cancel = document.getElementById("surveyCancel");
const $toast = document.getElementById("surveyToast");
const $qhost = document.getElementById("surveyQuestions");
const $title = document.getElementById("surveyTitle");
let _sessionId = (crypto?.randomUUID?.() || ("s_" + Math.random().toString(36).slice(2)));
let _openedMeta = null;

/** ä¾ videoId / youtubeId æ‰¾åˆ°å•å·å®šç¾© */
function resolveSurveyKey(meta) {
  if (SURVEY_DEFS[meta.videoId]) return meta.videoId;
  if (SURVEY_DEFS[meta.youtubeId]) return meta.youtubeId;
  return null;
}

function renderSurvey(meta) {
  const key = resolveSurveyKey(meta);
  const def = key ? SURVEY_DEFS[key] : null;

  // æ³¨å…¥éš±è—æ¬„ä½
  $form.elements["userId"].value = _getUserIdFallback();
  $form.elements["videoId"].value = meta.videoId || meta.youtubeId || "";
  $form.elements["youtubeId"].value = meta.youtubeId || "";
  $form.elements["title"].value = meta.title || document.title;
  $form.elements["openedAt"].value = new Date().toISOString();
  $form.elements["pageUrl"].value = location.href;
  $form.elements["sessionId"].value = _sessionId;
  $form.elements["surveyKey"].value = key || "default";
  logEvent("open_survey_"+key, EventType);
  // æ¸²æŸ“é¡Œç›®
  if (def) {
    $qhost.innerHTML = def.html;
    $title.textContent = `å•å·ï½œ${def.title}`;
  } else {
    // å¾Œå‚™ï¼šè‹¥æœªå®šç¾©ï¼Œé¡¯ç¤ºç°¡ç‰ˆå•å·
    $qhost.innerHTML = `
      <fieldset><legend>Q1ï½œé€™éƒ¨å½±ç‰‡å°ä½ æœ‰å¹«åŠ©å—ï¼Ÿ</legend>
        <label><input type="radio" name="u1" value="YES" required> æ˜¯</label>
        <label><input type="radio" name="u1" value="NO"> å¦</label>
      </fieldset>
      <fieldset><legend>Q2ï½œæƒ³å†çœ‹åˆ°å“ªäº›ä¸»é¡Œï¼Ÿï¼ˆé¸å¡«ï¼‰</legend>
        <input type="text" name="u2_note" placeholder="è¼¸å…¥ä¸»é¡Œâ€¦">
      </fieldset>
    `;
    $title.textContent = `å•å·ï½œ${meta.title || 'å½±ç‰‡å•å·'}`;
  }
}

function openSurvey(meta) {
  _openedMeta = meta;
  renderSurvey(meta);
  $overlay.style.display = "flex";
  $overlay.setAttribute("aria-hidden", "false");
}
function closeSurvey() {
  $overlay.style.display = "none";
  $overlay.setAttribute("aria-hidden", "true");
}

/** ç¶å®šæ‰€æœ‰ .cta æ‰“é–‹å°æ‡‰å•å· */
document.querySelectorAll('a.cta[href="#q"]:not(#goVip)').forEach(a => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const meta = getContextFromCTA(a);
    openSurvey(meta);
  });
});


/** é—œé–‰è¡Œç‚º */
$close.addEventListener("click", closeSurvey);
$cancel.addEventListener("click", closeSurvey);
$overlay.addEventListener("click", (e)=>{ if(e.target===$overlay) closeSurvey(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeSurvey(); });

async function SurveySubmit(videoId, youtubeId, answers) {
  const payload = {
    SafeKey: "qrt897hpmd",
    VIP: vipId,
    videoId: videoId,
    youtubeId:youtubeId,
    surveyKey: videoId,
    answers: answers
  };
  console.log("[SurveySubmit] payload =", JSON.stringify(payload, null, 2));

  // 1) å…ˆç”¨ sendBeaconï¼ˆä¸å¯è®€å›æ‡‰ï¼Œä½†èƒ½é€é”ï¼‰
  try {
    const ok = navigator.sendBeacon(
      SURVEY_POST_URL,
      new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" })
    );
    if (ok) {
      console.info("[SurveySubmit] delivered via sendBeacon");
      return { delivered: true, mode: "beacon" };
    }
  } catch (e) {
    console.warn("[SurveySubmit] sendBeacon failed, fallback to fetch no-cors", e);
  }

  // 2) å†ç”¨ fetch(no-cors)ï¼ˆopaqueï¼Œè¦–ç‚ºé€é”ï¼‰
  try {
    await fetch(SURVEY_POST_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=UTF-8" },
      body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
      keepalive: true,
    });
    console.info("[SurveySubmit] delivered via fetch(no-cors)");
    return { delivered: true, mode: "no-cors" };
  } catch (err) {
    console.error("[SurveySubmit] all methods failed:", err);
    return { delivered: false, mode: "no-cors" };
  }
}




/** é€å‡ºè¡¨å–® â†’ å‘¼å«å•å·ç´€éŒ„ APIï¼ˆç­”æ¡ˆï¼‹idï¼‰+ æ‰“é» survey_submit */
$form.addEventListener("submit", async (evt) => {
  evt.preventDefault();

  // åœç”¨æŒ‰éˆ•é¿å…é‡è¤‡é€å‡º
  const submitBtn = $form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  try {
    const fd = new FormData($form);

    // 1) å…ˆæŠŠæ‰€æœ‰æ¬„ä½å–å‡º
    const raw = Object.fromEntries(fd);

    // 2) å°‡è¤‡é¸ï¼ˆname ä»¥ [] çµå°¾ï¼‰æ­£è¦åŒ–æˆé™£åˆ—
    for (const [k] of fd.entries()) {
      if (k.endsWith("[]")) {
        raw[k.slice(0, -2)] = fd.getAll(k);
        delete raw[k];
      }
    }

    // 2.5) çµ±ä¸€ç¬¬4é¡Œæ ¼å¼ï¼šè‹¥æ˜¯å–®é¸çš„ q4ï¼ˆé q4[]ï¼‰ï¼ŒåŒ…æˆé™£åˆ—
    if (
         Object.prototype.hasOwnProperty.call(raw, "q4") &&
         !Array.isArray(raw.q4) &&
         raw.q4 !== undefined &&
         raw.q4 !== ""
        ) {
            // å–®é¸ q4 åŒ…æˆé™£åˆ—
           raw.q4 = [raw.q4];
          // è‹¥æ²’æœ‰ q4_otherï¼Œæˆ–åŸæœ¬å°±ä¸æ˜¯è¤‡é¸å•å· â†’ çµ¦ç©ºå­—ä¸²
           raw.q4_other = "";
        }


    // 3) æŠ½å‡º ID èˆ‡å•å· metaï¼ˆä½ è¦çš„ id éƒ½åœ¨é€™è£¡ï¼‰
    const payloadBase = {
      userId:   raw.userId,
      videoId:  raw.videoId,
      youtubeId: raw.youtubeId,
      surveyKey: raw.surveyKey
    };

    // 4) åªæŠŠã€Œç­”æ¡ˆé¡Œç›®ã€æ”¶é€² answersï¼Œæ’é™¤éš±è— meta æ¬„ä½
    const hiddenKeys = new Set([
      "userId", "videoId", "youtubeId",
      "title", "openedAt", "pageUrl",
      "sessionId", "surveyKey"
    ]);

    const answers = {};
    for (const [k, v] of Object.entries(raw)) {
      if (!hiddenKeys.has(k)) answers[k] = v;
    }

    // 5) çµ„ API è¦é€çš„ JSONï¼ˆç²¾ç°¡ä¹¾æ·¨ï¼‰
    //const surveyPayload = {
    //  ...payloadBase,
    //  answers, // åªåŒ…å«é¡Œç›®ç­”æ¡ˆ
    //};
   
   // console.log("surveyPayload="+JSON.stringify(surveyPayload, null, 2));
    
    // 6) å¯«å…¥ä½ çš„å•å·ç´€éŒ„ API
    // postJSON(SURVEY_POST_URL, surveyPayload);
    await SurveySubmit(raw.videoId, raw.youtubeId, answers);

    // 7)ï¼ˆå¯é¸ï¼‰å†æ‰“ä¸€ç­†è¿½è¹¤äº‹ä»¶ï¼ˆå‰å°è¡Œç‚ºæµç”¨ï¼‰
    logEvent("survey_submit_"+raw.videoId, EventType);
   

    // 8) UI æ”¶å°¾
    closeSurvey();
    $toast.style.display = "block";
    setTimeout(() => { $toast.style.display = "none"; }, 1800);
    $form.reset();

  } catch (err) {
    console.warn("Submit survey failed:", err);
    alert("é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
  } finally {
    submitBtn.disabled = false;
  }
});


/** ===== å·¥å…·ï¼šå– userIdï¼ˆæ²¿ç”¨æ—¢æœ‰ getUserIdï¼Œå¦å‰‡ fallbackï¼‰===== */
function _getUserIdFallback() {
  try { if (typeof getUserId === "function") return getUserId(); } catch {}
  if (window.USER_ID && String(window.USER_ID).trim()) return String(window.USER_ID).trim();
  const urlUid = new URLSearchParams(location.search).get("uid");
  if (urlUid) { localStorage.setItem("userId", urlUid); return urlUid; }
  const saved = localStorage.getItem("userId");
  if (saved) return saved;
  const gen = "guest_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("userId", gen);
  return gen;
}

/** ===== å¾ CTA å°±è¿‘æŠ“å½±ç‰‡è³‡è¨Š ===== */
function getContextFromCTA(btn) {
  const card = btn.closest(".card, .single-video, .hero") || document.body;
  const iframe = card.querySelector("iframe");
  const videoId   = iframe?.dataset.videoId || "";
  const youtubeId = iframe?.dataset.youtubeId || (iframe?.src?.match(/(embed\/|v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/)?.[2] || "");
  const titleEl = card.querySelector("h3, h4, h2");
  const title = (titleEl?.textContent || iframe?.title || document.title).trim();
  return { videoId, youtubeId, title, iframe };
}

// è®“ã€Œå‰å¾€VIPç››å®´ã€è‡ªå‹•å¸¶ä¸Š ?vip= åƒæ•¸
function wireVipLink(){
  const a = document.getElementById("goVip") || document.querySelector("#vip a.btn");
  if (!a) return;

  // ç›®æ¨™é é¢
  const target = "./vip1.html";
  // è‹¥ç›®æ¨™æœ¬èº«å·²æœ‰æŸ¥è©¢åƒæ•¸å°±ç”¨ & æ¥çºŒ
  const url = new URL(target, location.href);
  url.searchParams.set("vip", vipId);

  // å¦‚éœ€ä¸€ä½µå¸¶å…¶ä»–åƒæ•¸ï¼ˆä¾‹å¦‚ uidï¼‰ï¼Œå–æ¶ˆä¸‹è¡Œè¨»è§£ï¼š
  // const uid = new URLSearchParams(location.search).get("uid");
  // if (uid) url.searchParams.set("uid", uid);
  a.href = url.toString();
  // é»æ“Šæ™‚æ‰“ä¸€ç­†äº‹ä»¶
  a.addEventListener("click", () => {
    logEvent("goto_vip1", EventType);
  });
}





/** é–‹ç™¼æ™‚å¯ç”¨çš„å°å·¥å…· */
window.VideoTrack = {
  events()  { return JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]"); },
  watched() { return JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]"); },
  clear()   { localStorage.removeItem(STORAGE_EVENTS_KEY); localStorage.removeItem(STORAGE_WATCHED_KEY); }
};
</script>


</body>
</html>
