import{a as oe}from"./CCb-kr4I.js";import{u as ue}from"./t-MFjoUR.js";import{_ as we}from"./DNAPM-2u.js";import{_ as W}from"./DlAUqK2U.js";import{t as h,v as _,K as N,x as r,y as x,B as te,L as ae,r as I,o as de,z as ve,A as Ue,M as ie,a3 as ye,g as Ne,O as $e,Q as pe,R as Ie,J as ge,i as j,N as z}from"./D70xjexz.js";import{_ as He}from"./-OuEz4cf.js";import{_ as be}from"./B0rTVoH9.js";import{_ as Ve}from"./fh2N3Yhm.js";import{s as De}from"./Di88QSaI.js";const Me={props:{showCloseButton:{type:Boolean,default:!0}},setup(){const R=ue(),m=async(A,a)=>{try{return(await oe.post(A,a)).data}catch(p){throw console.error("API Request Error:",p),p}},b=localStorage.getItem("userData"),{MID:i,Token:u,MAID:c,Mobile:l}=b?JSON.parse(b):{},d=()=>{R.showHRVForUseAlert=!1},n=A=>{const[a,p,f]=A.split("/").map(Number);return new Date().getFullYear()-(1911+a)},g=async A=>{if(A==="abandon"){await $(),d(),location.reload();return}const a=JSON.parse(localStorage.getItem("userData"));if(!a){alert("尚未登入。"),d();return}const p=E=>Number.isInteger(parseInt(E,10));if(!p(a.Height)||parseInt(a.Height)<=0){alert("您的身高格式不正確，請修改會員資料"),window.location.href="/changeMember";return}if(!p(a.Weight)||parseInt(a.Weight)<=0){alert("您的體重格式不正確，請修改會員資料"),window.location.href="/changeMember";return}const f=a.Birthday.split("/");if(f.length!==3||parseInt(f[0])<=0||parseInt(f[1])<1||parseInt(f[1])>12||parseInt(f[2])<1||parseInt(f[2])>31||isNaN(n(a.Birthday))){alert("生日格式不正確或包含無效日期，請修改會員資料。"),window.location.href="/changeMember";return}let S=parseInt(a.Sex);if(S!==1&&S!==2&&S!==0){alert("性別格式不正確，請修改會員資料。"),window.location.href="/changeMember";return}if(S===2&&(S=0),!["normal","prehypertension","hypertension"].includes(a.DSPR)){R.showDSPRSelect=!0,d();return}const U={age:n(a.Birthday),bp_group:a.DSPR,bp_mode:"ternary",facing_mode:"user",height:parseInt(a.Height),sex:S,weight:parseInt(a.Weight),time:parseInt(a.HRVCalTime)||2};sessionStorage.setItem("data",JSON.stringify(U));const y=R.detectUID,V=R.detectFlag,M=R.detectForm;let T="/vital/scan.html";V&&(T+=`?UID=${y}&flag=${V}&form=${M}`),window.location.href=T},$=async()=>{if(!confirm("確定要放棄檢測嗎？"))return;let a="N",p="N";R.detectFlag==="1"?a="Y":R.detectFlag==="2"&&(p="Y");try{const f={MID:i,Token:u,MAID:c,Mobile:l,UID:R.detectUID,BeforeHRVAbandon:a,AfterHRVAbandon:p},S=await m("https://23700999.com:8081/HMA/API_Use_Set_Abandon.jsp",f);console.log("✅ 放棄成功",S)}catch(f){console.error("❌ 放棄失敗：",f)}};return{store:R,handleCloseHRVAlert:d,convertAndSaveUserData:g}}},Ee={key:0,class:"cover"},Pe={key:1,class:"HRVAlert"},ke={class:"HRVAlertForUseBtnGroup"};function Fe(R,m,b,i,u,c){return h(),_(ae,null,[i.store.showHRVForUseAlert?(h(),_("div",Ee)):N("",!0),i.store.showHRVForUseAlert?(h(),_("div",Pe,[R.showHRVForUseAlert?(h(),_("img",{key:0,class:"HRVAlertClose",onClick:m[0]||(m[0]=(...l)=>i.handleCloseHRVAlert&&i.handleCloseHRVAlert(...l)),src:we,alt:"close"})):N("",!0),r("h3",null,x(i.store.HRVAlertTitle),1),m[3]||(m[3]=r("ul",null,[r("li",null,[te(" 測量時間"),r("span",{class:"point"},"約1分鐘"),te("。測量時請保持安靜與穩定，避免晃動、交談、憋氣或深呼吸。 ")]),r("li",null,[te(" 建議在"),r("span",{class:"point"},"光線充足、安靜無干擾"),te("的獨立空間進行測量，並確保全程臉部位於畫面中。 ")]),r("li",null,"測量結束後，網頁會自動跳轉至 「檢測結果」頁面。"),r("li",null," 本工具提供的心跳、心率變異率、血壓、血氧、呼吸與壓力指數等資訊，僅供保健參考，不具醫療診斷用途。請勿依據本數據自行診斷或調整藥物，應遵循醫師指示。 "),r("li",null," 本工具不對因測量結果引發的健康或法律問題負責，請於做出任何健康決策前，諮詢醫療專業人員。 ")],-1)),r("div",ke,[r("button",{class:"HRVAlertBtn HRVAlertBtnAbandon",onClick:m[1]||(m[1]=l=>i.convertAndSaveUserData("abandon"))}," 放棄檢測 "),r("button",{class:"HRVAlertBtn",onClick:m[2]||(m[2]=l=>i.convertAndSaveUserData("confirm"))}," 前往檢測 ")])])):N("",!0)],64)}const Dt=W(Me,[["render",Fe],["__scopeId","data-v-0e205824"]]),Be=""+new URL("hrvBefore.fqQc3z7K.png",import.meta.url).href,Ce=""+new URL("hrvAfter.CyOPneNf.png",import.meta.url).href,xe={key:0},Oe={class:"chooseHRVUseMethod"},Ge={class:"hrvMethodGroup"},Ye={__name:"ChooseHRVUseMethod",emits:["selectHRVMethod"],setup(R,{emit:m}){const b=m,i=I(!0),u=()=>{const l=document.querySelectorAll(".chooseHRVUseMethod img");let d=0;l.forEach(n=>{n.complete?d++:(n.onload=()=>{d++,d===l.length&&setTimeout(()=>{i.value=!1},300)},n.onerror=()=>{console.warn(`圖片載入失敗: ${n.src}`),d++,d===l.length&&setTimeout(()=>{i.value=!1},300)})}),d===l.length&&setTimeout(()=>{i.value=!1},300)};de(()=>{u()});const c=l=>{b("selectHRVMethod",l)};return(l,d)=>(h(),_(ae,null,[d[5]||(d[5]=r("div",{class:"cover"},null,-1)),ve(ye,{name:"fade"},{default:Ue(()=>[i.value?N("",!0):(h(),_("div",xe,[i.value?(h(),ie(He,{key:0})):N("",!0),r("div",Oe,[d[4]||(d[4]=r("h6",null,"請選擇",-1)),r("div",Ge,[r("div",{class:"hrvMethod",onClick:d[0]||(d[0]=n=>c("before"))},d[2]||(d[2]=[r("img",{src:Be,alt:""},null,-1),r("h3",null,"穿衣前檢測",-1)])),r("div",{class:"hrvMethod",onClick:d[1]||(d[1]=n=>c("after"))},d[3]||(d[3]=[r("img",{src:Ce,alt:""},null,-1),r("h3",null,"穿衣後檢測",-1),r("small",null,"補測",-1)]))])])]))]),_:1})],64))}},je=W(Ye,[["__scopeId","data-v-624c7fa7"]]),Le={class:"timeHRVUseAlert"},Je={class:"HRVUseDateGroup"},Ke={key:0},qe={key:0,class:"timeHRVUseAlertSubHint"},ze={__name:"TimeHRVUseAlert",emits:["update:startTime","update:localDate","submit"],setup(R,{emit:m}){const b=m,i=I(""),u=I(""),c=I(""),l=()=>{b("update:localDate",i.value)},d=I(null),n=()=>{d.value&&d.value.showPicker()},g=()=>{if(!u.value){c.value="";return}const[A,a]=u.value.split(":").map(Number),p=new Date;p.setHours(A,a,0),p.setHours(p.getHours());const f=String(p.getHours()).padStart(2,"0"),S=String(p.getMinutes()).padStart(2,"0");c.value=`${f}:${S}`,b("update:startTime",u.value)},$=()=>{if(!i.value||!u.value){alert("請填寫完整日期與時間！");return}const A=new Date,[a,p]=u.value.split(":").map(Number),f=new Date(i.value);if(f.setHours(a,p,0),f>A){alert("開始時間不能超過當前時間，請重新選擇！");return}c.value=u.value,b("submit",{date:i.value,startTime:u.value,endTime:c.value})};return(A,a)=>{const p=Ne("VueDatePicker");return h(),_(ae,null,[a[6]||(a[6]=r("div",{class:"cover"},null,-1)),r("div",Le,[a[4]||(a[4]=r("h3",null,"請填寫開始穿衣的時間",-1)),a[5]||(a[5]=r("hr",null,null,-1)),r("div",Je,[a[2]||(a[2]=r("img",{class:"icon1",src:be,alt:"日期選擇"},null,-1)),ve(p,{modelValue:i.value,"onUpdate:modelValue":[a[0]||(a[0]=f=>i.value=f),l],"model-type":"format",format:"yyyy/MM/dd",locale:"zh-TW","enable-time-picker":!1,"cancel-text":"取消","select-text":"確定","max-date":new Date,placeholder:"年/月/日",teleport:"body","no-today":"","hide-input-icon":""},null,8,["modelValue","max-date"])]),r("div",{class:"HRVUseTimeGroup",onClick:n},[a[3]||(a[3]=r("img",{class:"icon1",src:Ve,alt:"時間選擇"},null,-1)),u.value?N("",!0):(h(),_("span",Ke,"請選擇開始穿衣的時間")),r("span",{class:$e({selected:u.value})},x(u.value?u.value:""),3),pe(r("input",{ref_key:"timeInput",ref:d,"onUpdate:modelValue":a[1]||(a[1]=f=>u.value=f),type:"time",onInput:g},null,544),[[Ie,u.value]])]),r("button",{onClick:$},"送出"),i.value&&c.value?(h(),_("h6",qe," ※ 您選擇的開始時間："+x(i.value)+" "+x(c.value),1)):N("",!0)])],64)}}},We=W(ze,[["__scopeId","data-v-77712c07"]]),Qe={class:"progress-container"},Xe={class:"content"},Ze={class:"timerButtonGroup"},et={key:0,class:"expired-options"},tt={key:0,class:"TimeRingForgetBox"},ot={__name:"TimeRing2",props:{productName:{type:String},hasDetectRecord:{type:Boolean},hasDetectTime:{type:String,default:"00:00:00"}},setup(R){const m=R,b=ge(),i=I(!1),u=I(!1),c=I(0),l=I(null),d=I(!1),n={BEFORE:"before",RUNNING:"running",AFTER:"after"},g=I(n.BEFORE),$=j(()=>{switch(g.value){case n.BEFORE:return"開始紀錄";case n.RUNNING:return"結束紀錄";case n.AFTER:return"HRV檢測(使用後)";default:return"未知狀態"}}),A=j(()=>{if(c.value<=0&&ee.value)return ee.value;const e=Math.floor(c.value/3600),o=Math.floor(c.value%3600/60),s=c.value%60;return`${String(e).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}`}),a=I(null),p=I(null),f=ue(),S=I(null),J=I(!1),U=I(null),y=I(!1),V=j(()=>{switch(g.value){case n.BEFORE:return{backgroundColor:"#74BC1F",color:"#fff"};case n.RUNNING:return{backgroundColor:"#1FBCB3",color:"#fff"};case n.AFTER:return{backgroundColor:"#74BC1F",color:"#fff"};default:return{backgroundColor:"#E0E0E0",color:"#000"}}}),M=localStorage.getItem("userData"),{MID:T,Token:E,MAID:P,Mobile:k}=M?JSON.parse(M):{};(!T||!E||!P||!k)&&b.push("/");const F=I(null),G=()=>{if(F.value){console.log("⏳ 計時器已經啟動，不重複啟動");return}if(!l.value){console.warn("⚠️ startTimestamp 為空，無法啟動計時器");return}console.log("🚀 計時開始，startTimestamp =",new Date(l.value).toLocaleString()),g.value!==n.RUNNING&&(console.log("🔄 修正 currentDetectionState 為 RUNNING"),g.value=n.RUNNING),F.value=De(()=>{const e=Date.now();c.value=Math.floor((e-l.value)/1e3),console.log("⏳ 計時中，已過時間：",c.value,"秒")},1e3)},K=async e=>{console.log("⏹ 停止計時器，準備檢查是否可以結束"),F.value&&(clearInterval(F.value),F.value=null),d.value=!1;const o=await v("1",a.value);if(console.log("🔎 使用前檢測完成狀態:",o),o==="N"){alert("尚未完成使用前檢測，無法結束！"),g.value=n.RUNNING,console.log("⚠️ 保持 `RUNNING` 狀態，計時數值不變:",c.value);return}console.log("✅ 使用前檢測已完成，更新狀態為 `AFTER`"),g.value=n.AFTER;try{await B(),console.log("✅ 計時已結束，API 調用成功"),e!=!1&&O(a.value)}catch(s){console.error("❌ 結束 API 調用失敗：",s)}},L=e=>{f.detectFlag="1",f.detectUID=e,f.detectForm=m.productName,f.showHRVForUseAlert=!0,f.HRVAlertTitle="(使用前)-HRV量測"},O=e=>{f.detectFlag="2",f.detectUID=e,f.detectForm=`*${m.productName}`,f.showHRVForUseAlert=!0,f.HRVAlertTitle="(使用後)-HRV量測",console.log("使用後檢測已啟動",{UIDVal:e,productName:m.productName})},ne=async()=>{if(!i.value){i.value=!0;try{switch(g.value){case n.BEFORE:if(a.value){console.log("已有 UID，從 API 時間開始 HRV 檢測");const e=await Z();if(e!=null&&e.StartTime)l.value=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime(),c.value=Math.floor((Date.now()-l.value)/1e3);else{l.value=Date.now(),console.warn("舊的 UID 可能已失效，創建新的 UID");const o=await w();if(o!=null&&o.UID)L(o.UID);else{console.error("創建 UID 失敗");return}}G()}else{const e=await w();e!=null&&e.UID?(y.value=!0,l.value=Date.now(),G()):console.error("創建 UID 失敗")}break;case n.RUNNING:console.log("結束 HRV 檢測"),await K();break;case n.AFTER:O(a.value);break;default:console.error("未知檢測狀態")}}finally{i.value=!1}}},se=async()=>{if(!U.value){alert("請選擇結束時間");return}const e=Q(U.value);console.log("選擇的結束時間:",e);try{await B(e),J.value=!1,S.value=!1,g.value=n.AFTER,console.log("檢測已手動結束")}catch(o){console.error("結束檢測時發生錯誤:",o)}},Q=e=>{const o=new Date(e),s=o.getFullYear(),D=String(o.getMonth()+1).padStart(2,"0"),H=String(o.getDate()).padStart(2,"0"),q=String(o.getHours()).padStart(2,"0"),le=String(o.getMinutes()).padStart(2,"0"),ce=String(o.getSeconds()).padStart(2,"0");return`${s}${D}${H}${q}${le}${ce}`},X=async()=>{console.log("正在處理結束邏輯..."),F.value&&(clearInterval(F.value),F.value=null),d.value=!1;const o=Q(new Date);try{await B(o),console.log("結束 API 調用成功"),g.value=n.AFTER,S.value=!1,O(a.value)}catch(s){console.error("結束 API 調用失敗:",s)}},C=async(e,o)=>{try{return(await oe.post(e,o)).data}catch(s){throw s}},Z=async()=>{try{const e=await C("https://23700999.com:8081/HMA/API_MID_ProductName_UIDInfo.jsp",{MID:T,Token:E,MAID:P,Mobile:k,ProductName:m.productName});if(console.log("📡 API_MID_ProductName_UIDInfo 回應:",e),(e==null?void 0:e.Result)!=="OK")return console.error("❌ 無法獲取有效的 UID 資訊：",e),null;if(e.BeforeHRVAbandon==="Y"&&console.warn("已放棄前測 (BeforeHRVAbandon=Y)。"),!e.UID)return console.warn("⚠️ UID 為 null，無法繼續後續操作"),null;if(e.StartTime){const s=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime();l.value=s;const D=Date.now();return c.value=Math.floor((D-s)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(l.value).toLocaleString()}`),console.log(`⏳ 經過時間計算結果: ${c.value} 秒`),e}else console.warn("⚠️ 無法解析 StartTime，可能後端沒有返回")}catch(e){console.error("❌ API 調用失敗：",e)}return null},t=async e=>{try{const o=await C("https://23700999.com:8081/HMA/API_UIDInfo.jsp",{MID:T,Token:E,MAID:P,Mobile:k,UID:e});if((o==null?void 0:o.Result)==="OK")return o}catch{}},v=async(e,o)=>{if(!o)return console.error("❌ UID 為 null，無法調用 API_HRV2_UID_Flag_Info"),null;try{const s=await C("https://23700999.com:8081/HMA/API_HRV2_UID_Flag_Info.jsp",{MID:T,Token:E,MAID:P,Mobile:k,UID:o,Flag:e});if((s==null?void 0:s.Result)==="OK"){console.log("✅ 成功獲取 HRV2 檢測資料狀態：",s);const D=s.IsExit,H=s.IsAbandon,q=await t(o);return e==="1"&&D==="N"&&q.BeforeHRVAbandon!=="Y"&&(y.value=!0,me()),{isExit:D,isAbandon:H}}else return console.error("❌ 無法獲取 HRV2 資料狀態：",s),null}catch(s){return console.error("❌ API 調用失敗：",s),null}},w=async()=>{try{const e=await C("https://23700999.com:8081/HMA/API_UseStart.jsp",{MID:T,Token:E,MAID:P,Mobile:k,ProductName:m.productName});return e!=null&&e.UID?(a.value=e.UID,console.log("成功創建新的 UID：",a.value)):console.error("創建新的 UID 失敗，請檢查 API 響應"),e}catch(e){return console.error("創建新的 UID API 調用失敗：",e),null}},B=async(e="")=>{if(!a.value){console.error("無法結束，因為 UID 不存在");return}const o={MID:T,Token:E,MAID:P,Mobile:k,UID:a.value,EndTime:e||""};try{const s=await C("https://23700999.com:8081/HMA/API_UseEnd.jsp",o);console.log("結束 API 調用成功",s)}catch(s){console.error("結束 API 調用失敗:",s)}},Y=I(!1),ee=I(null),re=e=>new Date(`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}T${e.slice(8,10)}:${e.slice(10,12)}:${e.slice(12)}`),he=e=>{const o=Math.floor(e/3600),s=Math.floor(e%3600/60),D=e%60;return`${String(o).padStart(2,"0")}:${String(s).padStart(2,"0")}:${String(D).padStart(2,"0")}`},Re=async()=>{try{const e=await C("https://23700999.com:8081/HMA/API_UIDInfo_Search12.jsp",{MID:T,Token:E,MAID:P,Mobile:k,ProductName:m.productName,BeforeHRVDetect:"N"});if(e&&e.Result!=="NOData"){if(e.AfterHRVAbandon==="Y")return;const o=e.CheckTime?re(e.CheckTime):null;if(o&&(new Date-o)/(1e3*60*60)>24){console.log("超過 24 小時，不進行後續判斷");return}if(a.value=e.UID,console.log("🔍 取得 UID:",a.value),e.StartTime&&e.EndTime){const s=re(e.StartTime),D=re(e.EndTime),H=Math.floor((D-s)/1e3);ee.value=he(H),O(a.value),console.log("上次測試持續時間:",ee.value)}Y.value=!0,console.log("✅ 已完成 HRV 使用後檢測，不再顯示『結束』按鈕")}else console.log("❌ 沒有找到對應的數據，可能未進行測試")}catch(e){console.log("❌ API_UIDInfo_Search12 調用失敗:",e)}},me=async e=>{if(e==="before")L(a.value);else if(e==="after"){if(!a.value){console.error("❌ UID 不存在，無法進行結束邏輯");return}await K(!1),y.value=!1,u.value=!0}},Te=async({date:e,startTime:o,endTime:s})=>{try{const D=new Date(`${e} ${o}`),H=D.getFullYear(),q=String(D.getMonth()+1).padStart(2,"0"),le=String(D.getDate()).padStart(2,"0"),ce=String(D.getHours()).padStart(2,"0"),Ae=String(D.getMinutes()).padStart(2,"0"),Se=String(D.getSeconds()).padStart(2,"0"),fe=`${H}${q}${le}${ce}${Ae}${Se}`;console.log("欲設定的開始時間:",fe),await _e(fe),u.value=!1,O(a.value)}catch(D){console.error("更新開始時間失敗：",D)}},_e=async e=>{const o={MID:T,Token:E,MAID:P,Mobile:k,UID:a.value,StartTime:e};try{const{data:s}=await oe.post("https://23700999.com:8081/HMA/API_UIDStartEndTime.jsp",o);if((s==null?void 0:s.Result)==="OK")console.log("開始時間更新成功：",s);else throw new Error(JSON.stringify(s))}catch(s){throw console.error("API_UIDStartEndTime 呼叫失敗",s),s}};return de(async()=>{p.value=null,console.log("🔍 onMounted 啟動，開始初始化 HRV 狀態...");try{const e=await Z();if(e){a.value=e.UID,e.BeforeHRVAbandon==="Y"?console.warn("已放棄前測 (BeforeHRVAbandon=Y)。"):e.AfterHRVAbandon==="Y"&&console.warn("已放棄後測 (AfterHRVAbandon=Y)。"),console.log("✅ 成功獲取有效的 UID：",a.value);const o=await v("1",a.value);if(console.log("🔎 HRV 前測紀錄:",o),o==="Y"?(console.log("✅ HRV 前測已完成，進入 RUNNING 狀態"),g.value=n.RUNNING,G()):(console.log("⚠️ HRV 前測未完成，回到 BEFORE 狀態"),g.value=n.BEFORE),e.StartTime){console.log("⏳ 獲取 StartTime，恢復計時..."),l.value=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime();const s=Date.now();c.value=Math.floor((s-l.value)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(l.value).toLocaleString()}`),console.log(`⏳ 計時器恢復，已過時間: ${c.value} 秒`),c.value>0&&(console.log("🔄 自動切換至 RUNNING 狀態"),g.value=n.RUNNING,G())}else console.warn("⚠️ StartTime 不存在，計時器將從 0 開始")}else{console.warn("❌ 無法獲取使用者資料，檢查 API_ UIDInfo_Search12()");const o=await Re();if(o&&o.StartTime){console.log("⏳ API_UIDInfo_Search12() 取得 StartTime，恢復計時..."),l.value=new Date(`${o.StartTime.slice(0,4)}-${o.StartTime.slice(4,6)}-${o.StartTime.slice(6,8)}T${o.StartTime.slice(8,10)}:${o.StartTime.slice(10,12)}:${o.StartTime.slice(12)}`).getTime();const s=Date.now();c.value=Math.floor((s-l.value)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(l.value).toLocaleString()}`),console.log(`⏳ 計時器恢復，已過時間: ${c.value} 秒`),c.value>0&&(console.log("🔄 自動切換至 RUNNING 狀態"),g.value=n.RUNNING,G())}else console.warn("❌ 無法取得有效的時間資訊，將不使用預設時間"),c.value=0}}catch(e){console.error("❌ 初始化失敗：",e)}}),(e,o)=>{const s=je,D=We;return h(),_(ae,null,[y.value?(h(),ie(s,{key:0,onSelectHRVMethod:me})):N("",!0),u.value?(h(),ie(D,{key:1,startTime:e.selectedTime,"onUpdate:startTime":o[0]||(o[0]=H=>e.selectedTime=H),localDate:e.selectedDate,"onUpdate:localDate":o[1]||(o[1]=H=>e.selectedDate=H),onSubmit:Te},null,8,["startTime","localDate"])):N("",!0),r("div",Qe,[r("div",{class:"progress-border",style:z({background:e.progressGradient})},[r("div",Xe,x(A.value),1)],4),r("div",Ze,[S.value?(h(),_("div",et,[r("button",{style:{"background-color":"#74bc1f"},onClick:o[2]||(o[2]=H=>O(a.value))}," HRV檢測(使用後) "),Y.value?N("",!0):(h(),_("button",{key:0,style:{"background-color":"#1fbcb3"},onClick:X}," 結束 "))])):(h(),_("button",{key:1,style:z(V.value),onClick:ne},x($.value),5))]),J.value?(h(),_("div",tt,[o[4]||(o[4]=r("label",null,"選擇結束時間:",-1)),pe(r("input",{type:"datetime-local","onUpdate:modelValue":o[3]||(o[3]=H=>U.value=H)},null,512),[[Ie,U.value]]),r("button",{onClick:se},"確認")])):N("",!0)])],64)}}},ht=W(ot,[["__scopeId","data-v-67a4c370"]]),at={class:"progress-container"},nt={class:"content"},st={key:0,class:"completion-message"},rt={key:1,class:"flex"},lt=["disabled"],ct={__name:"TimeRing",props:{totalTime:{type:Number,default:3600},productName:{type:String,default:""},hasTodayRecord:{type:String,default:3e3}},setup(R){const m=R,b=ge(),i=ue(),u={BEFORE:"before",RUNNING:"running",AFTER:"after"},c=I(u.BEFORE),l=I(m.totalTime*1e3),d=I(!1),n=I(""),g=I(!1);let $=null,A=0;const a=j(()=>{switch(c.value){case u.BEFORE:return"開始紀錄";case u.RUNNING:return"重新紀錄";case u.AFTER:return"結束紀錄";default:return"未知狀態"}}),p=j(()=>{switch(c.value){case u.BEFORE:case u.RUNNING:case u.AFTER:return{backgroundColor:"#74BC1F",color:"#fff"};default:return{backgroundColor:"#E0E0E0",color:"#000"}}}),f=j(()=>{const t=m.totalTime*1e3-l.value,v=Math.min(t/(m.totalTime*1e3)*100,100);return{background:`conic-gradient(#74BC1F 0% ${v}%, #ffffff ${v}% 100%)`,transition:"background 0.1s linear"}}),S=j(()=>{const t=Math.floor(l.value/1e3),v=Math.floor(t/3600),w=Math.floor(t%3600/60),B=t%60;return`${String(v).padStart(2,"0")}:${String(w).padStart(2,"0")}:${String(B).padStart(2,"0")}`}),J=JSON.parse(localStorage.getItem("userData")||"{}"),{MID:U="",Token:y="",MAID:V="",Mobile:M=""}=J;(!U||!y||!V||!M)&&(console.error("用戶資料不完整，跳回登入"),b.push("/"));async function T(t,v){try{const{data:w}=await oe.post(t,v);return w}catch(w){return console.error(`[API失敗] ${t}`,w),null}}async function E(){const t=await T("https://23700999.com:8081/HMA/API_UseStart.jsp",{MID:U,Token:y,MAID:V,Mobile:M,ProductName:m.productName});return!t||!t.UID?(console.warn("useStartAPI => 無法建立 UID"),null):t}async function P(){n.value&&await T("https://23700999.com:8081/HMA/API_UseEnd.jsp",{MID:U,Token:y,MAID:V,Mobile:M,UID:n.value})}async function k(){n.value&&await T("https://23700999.com:8081/HMA/API_DeleteStart.jsp",{MID:U,Token:y,MAID:V,Mobile:M,UID:n.value,ProductName:m.productName})}async function F(t,v){if(!v)return null;const w=await T("https://23700999.com:8081/HMA/API_HRV2_UID_Flag_Info.jsp",{MID:U,Token:y,MAID:V,Mobile:M,UID:v,Flag:t});if(w){const B=w.IsExit,Y=await O(v);B==="N"&&Y.BeforeHRVAbandon!=="Y"&&K(v)}return w==null?void 0:w.IsExit}async function G(){return T("https://23700999.com:8081/HMA/API_MID_ProductName_UIDInfo.jsp",{MID:U,Token:y,MAID:V,Mobile:M,ProductName:m.productName})}function K(t){i.detectFlag="1",i.detectUID=t,i.detectForm=m.productName,i.showHRVForUseAlert=!0,i.HRVAlertTitle="(使用前)-HRV量測",console.log("已呼叫 '使用前檢測' => UID:",t)}function L(t){i.detectFlag="2",i.detectUID=t,i.detectForm=`*${m.productName}`,i.showHRVForUseAlert=!0,i.HRVAlertTitle="(使用後)-HRV量測",console.log("已呼叫 '使用後檢測' => UID:",t)}const O=async t=>{try{const v=await T("https://23700999.com:8081/HMA/API_UIDInfo.jsp",{MID:U,Token:y,MAID:V,Mobile:M,UID:t});if((v==null?void 0:v.Result)==="OK")return v}catch{}};function ne(){console.log("開始倒數 => 剩餘秒數:",l.value/1e3),d.value=!0,A=Date.now(),$&&clearInterval($),$=De(async()=>{const t=Date.now(),v=t-A;A=t,l.value=Math.max(l.value-v,0),l.value<=0&&(clearInterval($),$=null,d.value=!1,await P(),L(n.value))},1e3)}const se=t=>new Date(`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}T${t.slice(8,10)}:${t.slice(10,12)}:${t.slice(12)}`),Q=async()=>{try{const t=await T("https://23700999.com:8081/HMA/API_UIDInfo_Search12.jsp",{MID:U,Token:y,MAID:V,Mobile:M,ProductName:m.productName,BeforeHRVDetect:"N"});if(t&&t.Result!=="NOData"){if(t.AfterHRVAbandon==="Y")return;const v=t.CheckTime?se(t.CheckTime):null;if(v&&(new Date-v)/(1e3*60*60)>24){console.log("超過 24 小時，不進行後續判斷");return}n.value=t.UID,console.log("🔍 取得 UID:",n.value),l.value=0,L(n.value)}else console.log("❌ 沒有找到對應的數據，可能未進行測試")}catch(t){console.log("❌ API_UIDInfo_Search12 調用失敗:",t)}};async function X(){if(!g.value){g.value=!0;try{switch(console.log("按鈕點擊 => 狀態:",c.value),c.value){case u.BEFORE:{if(!n.value){const t=await E();if(t!=null&&t.UID)n.value=t.UID;else{console.error("無法建立 UID，無法繼續");return}}K(n.value);break}case u.RUNNING:{confirm("確定要重新檢測嗎？這會清除本次倒數記錄。")&&(await k(),C());break}case u.AFTER:{L(n.value);break}default:console.warn("未知狀態:",c.value)}}finally{g.value=!1}}}function C(){$&&(clearInterval($),$=null),c.value=u.BEFORE,l.value=m.totalTime*1e3,d.value=!1,n.value="",console.log("已重置 => 回到 BEFORE 狀態")}de(async()=>{try{const t=await G();if(t!=null&&t.UID){n.value=t.UID;const v=await F("1",n.value);if(console.log("🔎 HRV 前測紀錄:",v),t.StartTime){const w=Z(t.StartTime),B=Date.now()-w.getTime(),Y=m.totalTime*1e3-B;Y>0?(l.value=Y,c.value=u.RUNNING,ne()):(await P(),C())}}else await Q()}catch(t){console.error("onMounted 初始化失敗:",t)}});function Z(t){return!t||t.length<14?new Date:new Date(`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}T${t.slice(8,10)}:${t.slice(10,12)}:${t.slice(12,14)}`)}return(t,v)=>(h(),_("div",at,[r("div",{class:"progress-border",style:z(f.value)},[r("div",nt,x(S.value),1)],4),R.hasTodayRecord?(h(),_("div",st,"感謝您的使用")):N("",!0),R.hasTodayRecord?N("",!0):(h(),_("div",rt,[c.value!==u.AFTER?(h(),_("button",{key:0,style:z(p.value),onClick:X,disabled:g.value},x(a.value),13,lt)):N("",!0),c.value===u.AFTER?(h(),_("button",{key:1,style:z(p.value),onClick:X},x(a.value),5)):N("",!0)]))]))}},Rt=W(ct,[["__scopeId","data-v-98a06ae2"]]);export{Rt as _,ht as a,Dt as b};
