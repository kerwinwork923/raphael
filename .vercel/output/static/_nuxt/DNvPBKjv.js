import{a as te}from"./xsH4HHeE.js";import{u as ue}from"./Bf7E4ooc.js";import{_ as ye}from"./DNAPM-2u.js";import{_ as W}from"./DlAUqK2U.js";import{v as w,x as h,H as U,y as r,z as O,C as ve,N as ae,r as p,o as de,A as pe,B as Ne,O as oe,W as $e,g as He,L as ie,I as Ie,T as ge,M as De,j as L,J as z}from"./HfdH-K36.js";import{_ as he}from"./W3k4iq7y.js";import{_ as be}from"./B0rTVoH9.js";import{_ as Ve}from"./fh2N3Yhm.js";import{s as Re}from"./x_rD_Ya3.js";const Me={props:{showCloseButton:{type:Boolean,default:!0}},setup(){const _=ue(),m=async($,s)=>{try{return(await te.post($,s)).data}catch(T){throw console.error("API Request Error:",T),T}},b=localStorage.getItem("userData"),{MID:u,Token:d,MAID:i,Mobile:c}=b?JSON.parse(b):{},f=()=>{_.showHRVForUseAlert=!1},a=$=>{const[s,T,l]=$.split("/").map(Number);return new Date().getFullYear()-(1911+s)},g=async $=>{if($==="abandon"){await N(),f(),location.reload();return}const s=JSON.parse(localStorage.getItem("userData"));if(!s){alert("尚未登入。"),f();return}const T=E=>Number.isInteger(parseInt(E,10));if(!T(s.Height)||parseInt(s.Height)<=0){alert("您的身高格式不正確，請修改會員資料"),window.location.href="/changeMember";return}if(!T(s.Weight)||parseInt(s.Weight)<=0){alert("您的體重格式不正確，請修改會員資料"),window.location.href="/changeMember";return}const l=s.Birthday.split("/");if(l.length!==3||parseInt(l[0])<=0||parseInt(l[1])<1||parseInt(l[1])>12||parseInt(l[2])<1||parseInt(l[2])>31||isNaN(a(s.Birthday))){alert("生日格式不正確或包含無效日期，請修改會員資料。"),window.location.href="/changeMember";return}let I=parseInt(s.Sex);if(I!==1&&I!==2&&I!==0){alert("性別格式不正確，請修改會員資料。"),window.location.href="/changeMember";return}if(I===2&&(I=0),!["normal","prehypertension","hypertension"].includes(s.DSPR)){_.showDSPRSelect=!0,f();return}const D={age:a(s.Birthday),bp_group:s.DSPR,bp_mode:"ternary",facing_mode:"user",height:parseInt(s.Height),sex:I,weight:parseInt(s.Weight),time:parseInt(s.HRVCalTime)||2};sessionStorage.setItem("data",JSON.stringify(D));const y=_.detectUID,V=_.detectFlag,M=_.detectForm;let A="/HRV";V&&(A+=`?UID=${y}&flag=${V}&form=${M}`),window.location.href=A},N=async()=>{if(!confirm("確定要放棄檢測嗎？"))return;let s="N",T="N";_.detectFlag==="1"?s="Y":_.detectFlag==="2"&&(T="Y");try{const l={MID:u,Token:d,MAID:i,Mobile:c,UID:_.detectUID,BeforeHRVAbandon:s,AfterHRVAbandon:T},I=await m("https://23700999.com:8081/HMA/API_Use_Set_Abandon.jsp",l);console.log("✅ 放棄成功",I)}catch(l){console.error("❌ 放棄失敗：",l)}};return{store:_,handleCloseHRVAlert:f,convertAndSaveUserData:g}}},Pe={key:0,class:"cover"},Ee={key:1,class:"HRVAlert"},ke={class:"HRVAlertForUseBtnGroup"};function Fe(_,m,b,u,d,i){return h(),w(ae,null,[u.store.showHRVForUseAlert?(h(),w("div",Pe)):U("",!0),u.store.showHRVForUseAlert?(h(),w("div",Ee,[_.showHRVForUseAlert?(h(),w("img",{key:0,class:"HRVAlertClose",onClick:m[0]||(m[0]=(...c)=>u.handleCloseHRVAlert&&u.handleCloseHRVAlert(...c)),src:ye,alt:"close"})):U("",!0),r("h3",null,O(u.store.HRVAlertTitle),1),m[3]||(m[3]=r("div",{class:"disclaimer"}," 數據僅供健康參考，無醫療診斷效力，請勿自行解讀或調藥，應諮詢醫師 ",-1)),m[4]||(m[4]=r("ul",null,[r("li",null," 智平衡AI穿戴紀錄系統透過非接觸式人臉HRV量測（rPPG），推估使用者自律神經、疲勞、血管壓力與心情緊繃狀態，並提供即時個人化健康建議。 "),r("li",null," 系統同步紀錄保健衣穿戴時間與頻率，協助醫師掌握身體變化，優化刺激點配置。所蒐集數據亦將用於AI模型持續優化，使系統更精準。 "),r("li",null,[ve(" 測量僅需"),r("span",{class:"point"},"20秒"),ve("，請保持穩定、安靜、全程臉部入鏡。 ")])],-1)),r("div",ke,[r("button",{class:"HRVAlertBtn HRVAlertBtnAbandon",onClick:m[1]||(m[1]=c=>u.convertAndSaveUserData("abandon"))}," 放棄檢測 "),r("button",{class:"HRVAlertBtn",onClick:m[2]||(m[2]=c=>u.convertAndSaveUserData("confirm"))}," 前往檢測 ")])])):U("",!0)],64)}const Dt=W(Me,[["render",Fe],["__scopeId","data-v-782ee044"]]),Be=""+new URL("hrvBefore.fqQc3z7K.png",import.meta.url).href,Ce=""+new URL("hrvAfter.CyOPneNf.png",import.meta.url).href,xe={key:0},Oe={class:"chooseHRVUseMethod"},Ge={class:"hrvMethodGroup"},Ye={__name:"ChooseHRVUseMethod",emits:["selectHRVMethod"],setup(_,{emit:m}){const b=m,u=p(!0),d=()=>{const c=document.querySelectorAll(".chooseHRVUseMethod img");let f=0;c.forEach(a=>{a.complete?f++:(a.onload=()=>{f++,f===c.length&&setTimeout(()=>{u.value=!1},300)},a.onerror=()=>{console.warn(`圖片載入失敗: ${a.src}`),f++,f===c.length&&setTimeout(()=>{u.value=!1},300)})}),f===c.length&&setTimeout(()=>{u.value=!1},300)};de(()=>{d()});const i=c=>{b("selectHRVMethod",c)};return(c,f)=>(h(),w(ae,null,[f[5]||(f[5]=r("div",{class:"cover"},null,-1)),pe($e,{name:"fade"},{default:Ne(()=>[u.value?U("",!0):(h(),w("div",xe,[u.value?(h(),oe(he,{key:0})):U("",!0),r("div",Oe,[f[4]||(f[4]=r("h6",null,"請選擇",-1)),r("div",Ge,[r("div",{class:"hrvMethod",onClick:f[0]||(f[0]=a=>i("before"))},f[2]||(f[2]=[r("img",{src:Be,alt:""},null,-1),r("h3",null,"穿衣前檢測",-1)])),r("div",{class:"hrvMethod",onClick:f[1]||(f[1]=a=>i("after"))},f[3]||(f[3]=[r("img",{src:Ce,alt:""},null,-1),r("h3",null,"穿衣後檢測",-1),r("small",null,"補測",-1)]))])])]))]),_:1})],64))}},je=W(Ye,[["__scopeId","data-v-624c7fa7"]]),Le={class:"timeHRVUseAlert"},Je={class:"HRVUseDateGroup"},qe={key:0},Ke={key:0,class:"timeHRVUseAlertSubHint"},ze={__name:"TimeHRVUseAlert",emits:["update:startTime","update:localDate","submit"],setup(_,{emit:m}){const b=m,u=p(""),d=p(""),i=p(""),c=p(!1),f=p(!1),a=()=>{b("update:localDate",u.value)},g=p(null),N=()=>{g.value&&g.value.showPicker()},$=()=>{if(!d.value){i.value="";return}const[T,l]=d.value.split(":").map(Number),I=new Date;I.setHours(T,l,0),I.setHours(I.getHours());const P=String(I.getHours()).padStart(2,"0"),D=String(I.getMinutes()).padStart(2,"0");i.value=`${P}:${D}`,b("update:startTime",d.value)},s=()=>{if(!u.value||!d.value){alert("請填寫完整日期與時間！");return}const T=new Date,[l,I]=d.value.split(":").map(Number),P=new Date(u.value);if(P.setHours(l,I,0),P>T){alert("開始時間不能超過當前時間，請重新選擇！");return}i.value=d.value,b("submit",{date:u.value,startTime:d.value,endTime:i.value})};return(T,l)=>{const I=he,P=He("VueDatePicker");return h(),w(ae,null,[T.loading?(h(),oe(I,{key:0})):U("",!0),l[6]||(l[6]=r("div",{class:"cover"},null,-1)),r("div",Le,[l[4]||(l[4]=r("h3",null,"請填寫開始穿衣的時間",-1)),l[5]||(l[5]=r("hr",null,null,-1)),r("div",Je,[r("div",{class:ie(["icon-wrapper",{"is-loading":!c.value}])},[r("img",{class:"icon1",src:be,alt:"日期選擇",onLoad:l[0]||(l[0]=D=>c.value=!0)},null,32)],2),pe(P,{modelValue:u.value,"onUpdate:modelValue":[l[1]||(l[1]=D=>u.value=D),a],"model-type":"format",format:"yyyy/MM/dd",locale:"zh-TW","enable-time-picker":!1,"cancel-text":"取消","select-text":"確定","max-date":new Date,placeholder:"年/月/日",teleport:"body","no-today":"","hide-input-icon":""},null,8,["modelValue","max-date"])]),r("div",{class:"HRVUseTimeGroup",onClick:N},[r("div",{class:ie(["icon-wrapper",{"is-loading":!f.value}])},[r("img",{class:"icon1",src:Ve,alt:"時間選擇",onLoad:l[2]||(l[2]=D=>f.value=!0)},null,32)],2),d.value?U("",!0):(h(),w("span",qe,"請選擇開始穿衣的時間")),r("span",{class:ie({selected:d.value})},O(d.value?d.value:""),3),Ie(r("input",{ref_key:"timeInput",ref:g,"onUpdate:modelValue":l[3]||(l[3]=D=>d.value=D),type:"time",onInput:$},null,544),[[ge,d.value]])]),r("button",{onClick:s},"送出"),u.value&&i.value?(h(),w("h6",Ke," ※ 您選擇的開始時間："+O(u.value)+" "+O(i.value),1)):U("",!0)])],64)}}},We=W(ze,[["__scopeId","data-v-f10eec0c"]]),Qe={class:"progress-container"},Xe={class:"content"},Ze={class:"timerButtonGroup"},et={key:0,class:"expired-options"},tt={key:0,class:"TimeRingForgetBox"},ot={__name:"TimeRing2",props:{productName:{type:String},hasDetectRecord:{type:Boolean},hasDetectTime:{type:String,default:"00:00:00"}},setup(_){const m=_,b=De(),u=p(!1),d=p(!1),i=p(0),c=p(null),f=p(!1),a={BEFORE:"before",RUNNING:"running",AFTER:"after"},g=p(a.BEFORE),N=L(()=>{switch(g.value){case a.BEFORE:return"開始紀錄";case a.RUNNING:return"結束紀錄";case a.AFTER:return"HRV檢測(使用後)";default:return"未知狀態"}}),$=L(()=>{if(i.value<=0&&ee.value)return ee.value;const e=Math.floor(i.value/3600),o=Math.floor(i.value%3600/60),n=i.value%60;return`${String(e).padStart(2,"0")}:${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}`}),s=p(null),T=p(null),l=ue(),I=p(null),P=p(!1),D=p(null),y=p(!1),V=L(()=>{switch(g.value){case a.BEFORE:return{backgroundColor:"#74BC1F",color:"#fff"};case a.RUNNING:return{backgroundColor:"#1FBCB3",color:"#fff"};case a.AFTER:return{backgroundColor:"#74BC1F",color:"#fff"};default:return{backgroundColor:"#E0E0E0",color:"#000"}}}),M=localStorage.getItem("userData"),{MID:A,Token:E,MAID:k,Mobile:F}=M?JSON.parse(M):{};(!A||!E||!k||!F)&&b.push("/");const B=p(null),Y=()=>{if(B.value){console.log("⏳ 計時器已經啟動，不重複啟動");return}if(!c.value){console.warn("⚠️ startTimestamp 為空，無法啟動計時器");return}console.log("🚀 計時開始，startTimestamp =",new Date(c.value).toLocaleString()),g.value!==a.RUNNING&&(console.log("🔄 修正 currentDetectionState 為 RUNNING"),g.value=a.RUNNING),B.value=Re(()=>{const e=Date.now();i.value=Math.floor((e-c.value)/1e3),console.log("⏳ 計時中，已過時間：",i.value,"秒")},1e3)},q=async e=>{console.log("⏹ 停止計時器，準備檢查是否可以結束"),B.value&&(clearInterval(B.value),B.value=null),f.value=!1;const o=await v("1",s.value);if(console.log("🔎 使用前檢測完成狀態:",o),o==="N"){alert("尚未完成使用前檢測，無法結束！"),g.value=a.RUNNING,console.log("⚠️ 保持 `RUNNING` 狀態，計時數值不變:",i.value);return}console.log("✅ 使用前檢測已完成，更新狀態為 `AFTER`"),g.value=a.AFTER;try{await C(),console.log("✅ 計時已結束，API 調用成功"),e!=!1&&G(s.value)}catch(n){console.error("❌ 結束 API 調用失敗：",n)}},J=e=>{l.detectFlag="1",l.detectUID=e,l.detectForm=m.productName,l.showHRVForUseAlert=!0,l.HRVAlertTitle="(使用前)-HRV量測"},G=e=>{l.detectFlag="2",l.detectUID=e,l.detectForm=`*${m.productName}`,l.showHRVForUseAlert=!0,l.HRVAlertTitle="(使用後)-HRV量測",console.log("使用後檢測已啟動",{UIDVal:e,productName:m.productName})},ne=async()=>{if(!u.value){u.value=!0;try{switch(g.value){case a.BEFORE:if(s.value){console.log("已有 UID，從 API 時間開始 HRV 檢測");const e=await Z();if(e!=null&&e.StartTime)c.value=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime(),i.value=Math.floor((Date.now()-c.value)/1e3);else{c.value=Date.now(),console.warn("舊的 UID 可能已失效，創建新的 UID");const o=await S();if(o!=null&&o.UID)J(o.UID);else{console.error("創建 UID 失敗");return}}Y()}else{const e=await S();e!=null&&e.UID?(y.value=!0,c.value=Date.now(),Y()):console.error("創建 UID 失敗")}break;case a.RUNNING:console.log("結束 HRV 檢測"),await q();break;case a.AFTER:G(s.value);break;default:console.error("未知檢測狀態")}}finally{u.value=!1}}},se=async()=>{if(!D.value){alert("請選擇結束時間");return}const e=Q(D.value);console.log("選擇的結束時間:",e);try{await C(e),P.value=!1,I.value=!1,g.value=a.AFTER,console.log("檢測已手動結束")}catch(o){console.error("結束檢測時發生錯誤:",o)}},Q=e=>{const o=new Date(e),n=o.getFullYear(),R=String(o.getMonth()+1).padStart(2,"0"),H=String(o.getDate()).padStart(2,"0"),K=String(o.getHours()).padStart(2,"0"),le=String(o.getMinutes()).padStart(2,"0"),ce=String(o.getSeconds()).padStart(2,"0");return`${n}${R}${H}${K}${le}${ce}`},X=async()=>{console.log("正在處理結束邏輯..."),B.value&&(clearInterval(B.value),B.value=null),f.value=!1;const o=Q(new Date);try{await C(o),console.log("結束 API 調用成功"),g.value=a.AFTER,I.value=!1,G(s.value)}catch(n){console.error("結束 API 調用失敗:",n)}},x=async(e,o)=>{try{return(await te.post(e,o)).data}catch(n){throw n}},Z=async()=>{try{const e=await x("https://23700999.com:8081/HMA/API_MID_ProductName_UIDInfo.jsp",{MID:A,Token:E,MAID:k,Mobile:F,ProductName:m.productName});if(console.log("📡 API_MID_ProductName_UIDInfo 回應:",e),(e==null?void 0:e.Result)!=="OK")return console.error("❌ 無法獲取有效的 UID 資訊：",e),null;if(e.BeforeHRVAbandon==="Y"&&console.warn("已放棄前測 (BeforeHRVAbandon=Y)。"),!e.UID)return console.warn("⚠️ UID 為 null，無法繼續後續操作"),null;if(e.StartTime){const n=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime();c.value=n;const R=Date.now();return i.value=Math.floor((R-n)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(c.value).toLocaleString()}`),console.log(`⏳ 經過時間計算結果: ${i.value} 秒`),e}else console.warn("⚠️ 無法解析 StartTime，可能後端沒有返回")}catch(e){console.error("❌ API 調用失敗：",e)}return null},t=async e=>{try{const o=await x("https://23700999.com:8081/HMA/API_UIDInfo.jsp",{MID:A,Token:E,MAID:k,Mobile:F,UID:e});if((o==null?void 0:o.Result)==="OK")return o}catch{}},v=async(e,o)=>{if(!o)return console.error("❌ UID 為 null，無法調用 API_HRV2_UID_Flag_Info"),null;try{const n=await x("https://23700999.com:8081/HMA/API_HRV2_UID_Flag_Info.jsp",{MID:A,Token:E,MAID:k,Mobile:F,UID:o,Flag:e});if((n==null?void 0:n.Result)==="OK"){console.log("✅ 成功獲取 HRV2 檢測資料狀態：",n);const R=n.IsExit,H=n.IsAbandon,K=await t(o);return e==="1"&&R==="N"&&K.BeforeHRVAbandon!=="Y"&&(y.value=!0,me()),{isExit:R,isAbandon:H}}else return console.error("❌ 無法獲取 HRV2 資料狀態：",n),null}catch(n){return console.error("❌ API 調用失敗：",n),null}},S=async()=>{try{const e=await x("https://23700999.com:8081/HMA/API_UseStart.jsp",{MID:A,Token:E,MAID:k,Mobile:F,ProductName:m.productName});return e!=null&&e.UID?(s.value=e.UID,console.log("成功創建新的 UID：",s.value)):console.error("創建新的 UID 失敗，請檢查 API 響應"),e}catch(e){return console.error("創建新的 UID API 調用失敗：",e),null}},C=async(e="")=>{if(!s.value){console.error("無法結束，因為 UID 不存在");return}const o={MID:A,Token:E,MAID:k,Mobile:F,UID:s.value,EndTime:e||""};try{const n=await x("https://23700999.com:8081/HMA/API_UseEnd.jsp",o);console.log("結束 API 調用成功",n)}catch(n){console.error("結束 API 調用失敗:",n)}},j=p(!1),ee=p(null),re=e=>new Date(`${e.slice(0,4)}-${e.slice(4,6)}-${e.slice(6,8)}T${e.slice(8,10)}:${e.slice(10,12)}:${e.slice(12)}`),Te=e=>{const o=Math.floor(e/3600),n=Math.floor(e%3600/60),R=e%60;return`${String(o).padStart(2,"0")}:${String(n).padStart(2,"0")}:${String(R).padStart(2,"0")}`},_e=async()=>{try{const e=await x("https://23700999.com:8081/HMA/API_UIDInfo_Search12.jsp",{MID:A,Token:E,MAID:k,Mobile:F,ProductName:m.productName,BeforeHRVDetect:"N"});if(e&&e.Result!=="NOData"){if(e.AfterHRVAbandon==="Y")return;const o=e.CheckTime?re(e.CheckTime):null;if(o&&(new Date-o)/(1e3*60*60)>24){console.log("超過 24 小時，不進行後續判斷");return}if(s.value=e.UID,console.log("🔍 取得 UID:",s.value),e.StartTime&&e.EndTime){const n=re(e.StartTime),R=re(e.EndTime),H=Math.floor((R-n)/1e3);ee.value=Te(H),G(s.value),console.log("上次測試持續時間:",ee.value)}j.value=!0,console.log("✅ 已完成 HRV 使用後檢測，不再顯示『結束』按鈕")}else console.log("❌ 沒有找到對應的數據，可能未進行測試")}catch(e){console.log("❌ API_UIDInfo_Search12 調用失敗:",e)}},me=async e=>{if(e==="before")J(s.value);else if(e==="after"){if(!s.value){console.error("❌ UID 不存在，無法進行結束邏輯");return}await q(!1),y.value=!1,d.value=!0}},Ae=async({date:e,startTime:o,endTime:n})=>{try{const R=new Date(`${e} ${o}`),H=R.getFullYear(),K=String(R.getMonth()+1).padStart(2,"0"),le=String(R.getDate()).padStart(2,"0"),ce=String(R.getHours()).padStart(2,"0"),Se=String(R.getMinutes()).padStart(2,"0"),Ue=String(R.getSeconds()).padStart(2,"0"),fe=`${H}${K}${le}${ce}${Se}${Ue}`;console.log("欲設定的開始時間:",fe),await we(fe),d.value=!1,G(s.value)}catch(R){console.error("更新開始時間失敗：",R)}},we=async e=>{const o={MID:A,Token:E,MAID:k,Mobile:F,UID:s.value,StartTime:e};try{const{data:n}=await te.post("https://23700999.com:8081/HMA/API_UIDStartEndTime.jsp",o);if((n==null?void 0:n.Result)==="OK")console.log("開始時間更新成功：",n);else throw new Error(JSON.stringify(n))}catch(n){throw console.error("API_UIDStartEndTime 呼叫失敗",n),n}};return de(async()=>{T.value=null,console.log("🔍 onMounted 啟動，開始初始化 HRV 狀態...");try{const e=await Z();if(e){s.value=e.UID,e.BeforeHRVAbandon==="Y"?console.warn("已放棄前測 (BeforeHRVAbandon=Y)。"):e.AfterHRVAbandon==="Y"&&console.warn("已放棄後測 (AfterHRVAbandon=Y)。"),console.log("✅ 成功獲取有效的 UID：",s.value);const o=await v("1",s.value);if(console.log("🔎 HRV 前測紀錄:",o),o==="Y"?(console.log("✅ HRV 前測已完成，進入 RUNNING 狀態"),g.value=a.RUNNING,Y()):(console.log("⚠️ HRV 前測未完成，回到 BEFORE 狀態"),g.value=a.BEFORE),e.StartTime){console.log("⏳ 獲取 StartTime，恢復計時..."),c.value=new Date(`${e.StartTime.slice(0,4)}-${e.StartTime.slice(4,6)}-${e.StartTime.slice(6,8)}T${e.StartTime.slice(8,10)}:${e.StartTime.slice(10,12)}:${e.StartTime.slice(12)}`).getTime();const n=Date.now();i.value=Math.floor((n-c.value)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(c.value).toLocaleString()}`),console.log(`⏳ 計時器恢復，已過時間: ${i.value} 秒`),i.value>0&&(console.log("🔄 自動切換至 RUNNING 狀態"),g.value=a.RUNNING,Y())}else console.warn("⚠️ StartTime 不存在，計時器將從 0 開始")}else{console.warn("❌ 無法獲取使用者資料，檢查 API_ UIDInfo_Search12()");const o=await _e();if(o&&o.StartTime){console.log("⏳ API_UIDInfo_Search12() 取得 StartTime，恢復計時..."),c.value=new Date(`${o.StartTime.slice(0,4)}-${o.StartTime.slice(4,6)}-${o.StartTime.slice(6,8)}T${o.StartTime.slice(8,10)}:${o.StartTime.slice(10,12)}:${o.StartTime.slice(12)}`).getTime();const n=Date.now();i.value=Math.floor((n-c.value)/1e3),console.log(`⏳ StartTime 設定為: ${new Date(c.value).toLocaleString()}`),console.log(`⏳ 計時器恢復，已過時間: ${i.value} 秒`),i.value>0&&(console.log("🔄 自動切換至 RUNNING 狀態"),g.value=a.RUNNING,Y())}else console.warn("❌ 無法取得有效的時間資訊，將不使用預設時間"),i.value=0}}catch(e){console.error("❌ 初始化失敗：",e)}}),(e,o)=>{const n=je,R=We;return h(),w(ae,null,[y.value?(h(),oe(n,{key:0,onSelectHRVMethod:me})):U("",!0),d.value?(h(),oe(R,{key:1,startTime:e.selectedTime,"onUpdate:startTime":o[0]||(o[0]=H=>e.selectedTime=H),localDate:e.selectedDate,"onUpdate:localDate":o[1]||(o[1]=H=>e.selectedDate=H),onSubmit:Ae},null,8,["startTime","localDate"])):U("",!0),r("div",Qe,[r("div",{class:"progress-border",style:z({background:e.progressGradient})},[r("div",Xe,O($.value),1)],4),r("div",Ze,[I.value?(h(),w("div",et,[r("button",{style:{"background-color":"#74bc1f"},onClick:o[2]||(o[2]=H=>G(s.value))}," HRV檢測(使用後) "),j.value?U("",!0):(h(),w("button",{key:0,style:{"background-color":"#1fbcb3"},onClick:X}," 結束 "))])):(h(),w("button",{key:1,style:z(V.value),onClick:ne},O(N.value),5))]),P.value?(h(),w("div",tt,[o[4]||(o[4]=r("label",null,"選擇結束時間:",-1)),Ie(r("input",{type:"datetime-local","onUpdate:modelValue":o[3]||(o[3]=H=>D.value=H)},null,512),[[ge,D.value]]),r("button",{onClick:se},"確認")])):U("",!0)])],64)}}},ht=W(ot,[["__scopeId","data-v-67a4c370"]]),at={class:"progress-container"},nt={class:"content"},st={key:0,class:"completion-message"},rt={key:1,class:"flex"},lt=["disabled"],ct={__name:"TimeRing",props:{totalTime:{type:Number,default:3600},productName:{type:String,default:""},hasTodayRecord:{type:String,default:3e3}},setup(_){const m=_,b=De(),u=ue(),d={BEFORE:"before",RUNNING:"running",AFTER:"after"},i=p(d.BEFORE),c=p(m.totalTime*1e3),f=p(!1),a=p(""),g=p(!1);let N=null,$=0;const s=L(()=>{switch(i.value){case d.BEFORE:return"開始紀錄";case d.RUNNING:return"重新紀錄";case d.AFTER:return"結束紀錄";default:return"未知狀態"}}),T=L(()=>{switch(i.value){case d.BEFORE:case d.RUNNING:case d.AFTER:return{backgroundColor:"#74BC1F",color:"#fff"};default:return{backgroundColor:"#E0E0E0",color:"#000"}}}),l=L(()=>{const t=m.totalTime*1e3-c.value,v=Math.min(t/(m.totalTime*1e3)*100,100);return{background:`conic-gradient(#74BC1F 0% ${v}%, #ffffff ${v}% 100%)`,transition:"background 0.1s linear"}}),I=L(()=>{const t=Math.floor(c.value/1e3),v=Math.floor(t/3600),S=Math.floor(t%3600/60),C=t%60;return`${String(v).padStart(2,"0")}:${String(S).padStart(2,"0")}:${String(C).padStart(2,"0")}`}),P=JSON.parse(localStorage.getItem("userData")||"{}"),{MID:D="",Token:y="",MAID:V="",Mobile:M=""}=P;(!D||!y||!V||!M)&&(console.error("用戶資料不完整，跳回登入"),b.push("/"));async function A(t,v){try{const{data:S}=await te.post(t,v);return S}catch(S){return console.error(`[API失敗] ${t}`,S),null}}async function E(){const t=await A("https://23700999.com:8081/HMA/API_UseStart.jsp",{MID:D,Token:y,MAID:V,Mobile:M,ProductName:m.productName});return!t||!t.UID?(console.warn("useStartAPI => 無法建立 UID"),null):t}async function k(){a.value&&await A("https://23700999.com:8081/HMA/API_UseEnd.jsp",{MID:D,Token:y,MAID:V,Mobile:M,UID:a.value})}async function F(){a.value&&await A("https://23700999.com:8081/HMA/API_DeleteStart.jsp",{MID:D,Token:y,MAID:V,Mobile:M,UID:a.value,ProductName:m.productName})}async function B(t,v){if(!v)return null;const S=await A("https://23700999.com:8081/HMA/API_HRV2_UID_Flag_Info.jsp",{MID:D,Token:y,MAID:V,Mobile:M,UID:v,Flag:t});if(S){const C=S.IsExit,j=await G(v);C==="N"&&j.BeforeHRVAbandon!=="Y"&&q(v)}return S==null?void 0:S.IsExit}async function Y(){return A("https://23700999.com:8081/HMA/API_MID_ProductName_UIDInfo.jsp",{MID:D,Token:y,MAID:V,Mobile:M,ProductName:m.productName})}function q(t){u.detectFlag="1",u.detectUID=t,u.detectForm=m.productName,u.showHRVForUseAlert=!0,u.HRVAlertTitle="(使用前)-HRV量測",console.log("已呼叫 '使用前檢測' => UID:",t)}function J(t){u.detectFlag="2",u.detectUID=t,u.detectForm=`*${m.productName}`,u.showHRVForUseAlert=!0,u.HRVAlertTitle="(使用後)-HRV量測",console.log("已呼叫 '使用後檢測' => UID:",t)}const G=async t=>{try{const v=await A("https://23700999.com:8081/HMA/API_UIDInfo.jsp",{MID:D,Token:y,MAID:V,Mobile:M,UID:t});if((v==null?void 0:v.Result)==="OK")return v}catch{}};function ne(){console.log("開始倒數 => 剩餘秒數:",c.value/1e3),f.value=!0,$=Date.now(),N&&clearInterval(N),N=Re(async()=>{const t=Date.now(),v=t-$;$=t,c.value=Math.max(c.value-v,0),c.value<=0&&(clearInterval(N),N=null,f.value=!1,await k(),J(a.value))},1e3)}const se=t=>new Date(`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}T${t.slice(8,10)}:${t.slice(10,12)}:${t.slice(12)}`),Q=async()=>{try{const t=await A("https://23700999.com:8081/HMA/API_UIDInfo_Search12.jsp",{MID:D,Token:y,MAID:V,Mobile:M,ProductName:m.productName,BeforeHRVDetect:"N"});if(t&&t.Result!=="NOData"){if(t.AfterHRVAbandon==="Y")return;const v=t.CheckTime?se(t.CheckTime):null;if(v&&(new Date-v)/(1e3*60*60)>24){console.log("超過 24 小時，不進行後續判斷");return}a.value=t.UID,console.log("🔍 取得 UID:",a.value),c.value=0,J(a.value)}else console.log("❌ 沒有找到對應的數據，可能未進行測試")}catch(t){console.log("❌ API_UIDInfo_Search12 調用失敗:",t)}};async function X(){if(!g.value){g.value=!0;try{switch(console.log("按鈕點擊 => 狀態:",i.value),i.value){case d.BEFORE:{if(!a.value){const t=await E();if(t!=null&&t.UID)a.value=t.UID;else{console.error("無法建立 UID，無法繼續");return}}q(a.value);break}case d.RUNNING:{confirm("確定要重新檢測嗎？這會清除本次倒數記錄。")&&(await F(),x());break}case d.AFTER:{J(a.value);break}default:console.warn("未知狀態:",i.value)}}finally{g.value=!1}}}function x(){N&&(clearInterval(N),N=null),i.value=d.BEFORE,c.value=m.totalTime*1e3,f.value=!1,a.value="",console.log("已重置 => 回到 BEFORE 狀態")}de(async()=>{try{const t=await Y();if(t!=null&&t.UID){a.value=t.UID;const v=await B("1",a.value);if(console.log("🔎 HRV 前測紀錄:",v),t.StartTime){const S=Z(t.StartTime),C=Date.now()-S.getTime(),j=m.totalTime*1e3-C;j>0?(c.value=j,i.value=d.RUNNING,ne()):(await k(),x())}}else await Q()}catch(t){console.error("onMounted 初始化失敗:",t)}});function Z(t){return!t||t.length<14?new Date:new Date(`${t.slice(0,4)}-${t.slice(4,6)}-${t.slice(6,8)}T${t.slice(8,10)}:${t.slice(10,12)}:${t.slice(12,14)}`)}return(t,v)=>(h(),w("div",at,[r("div",{class:"progress-border",style:z(l.value)},[r("div",nt,O(I.value),1)],4),_.hasTodayRecord?(h(),w("div",st,"感謝您的使用")):U("",!0),_.hasTodayRecord?U("",!0):(h(),w("div",rt,[i.value===d.BEFORE?(h(),w("button",{key:0,style:z(T.value),onClick:X,disabled:g.value},O(s.value),13,lt)):U("",!0),i.value===d.AFTER?(h(),w("button",{key:1,style:z(T.value),onClick:X},O(s.value),5)):U("",!0)]))]))}},Rt=W(ct,[["__scopeId","data-v-eece2aff"]]);export{Dt as _,ht as a,Rt as b};
