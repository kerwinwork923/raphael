async function sendToAPI(base64) {
  const payload = {
    uuid: userData.Mobile,
    height: userData.Height,
    weight: userData.Weight,
    content: base64,
  };
  try {
    const res = await fetch(
      "https://face.zconai.com/api/v1.0/measure/",
      {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      }
    );

    try {
      const gdata = await res.json();
      console.log("API åŸå§‹å›å‚³è³‡æ–™:", gdata); // Debug log
      const data = JSON.parse(gdata);
      console.log("API åŸå§‹å›å‚³è³‡æ–™after parse:", data); // Debug log
      // çµ±ä¸€å®‰å…¨è§£æ
      const hbr = num(data.hbr?.[0]);
      const hrv = data.hrv?.[0] || {};
      const sdnn = num(hrv.SDNN);
      const LF = num(hrv.LF);
      const HF = num(hrv.HF);
      let lf_hf = num(hrv["LF/HF"]);
      if (lf_hf === null && LF && HF) lf_hf = LF / HF;
      const sbp = num(data.ica?.[0]?.SBP);
      const dbp = num(data.ica?.[0]?.DBP);
      const spo2 = data.sp?.[0] || "--";
      const rr = num(data.rr?.[0]);
      const af = data.af?.[0] || "--";
      const fa = data.fa?.[0] || "--";

      console.log("è™•ç†å¾Œçš„æ•¸å€¼:", {
        hbr,
        sdnn,
        LF,
        HF,
        lf_hf,
        sbp,
        dbp,
        spo2,
        rr,
        af,
        fa,
      }); // Debug log

      // è‡ªå¾‹ç¥ç¶“å¹³è¡¡
      let balanceSymbol = "â“";
      if (lf_hf !== null && !isNaN(lf_hf)) {
        if (lf_hf > 2) balanceSymbol = "ğŸ§  ç„¦èºï¼ˆäº¤æ„Ÿæ¥µé«˜ï¼‰";
        else if (lf_hf > 1.5) balanceSymbol = "ğŸ˜± ç·Šç¹ƒ";
        else if (lf_hf >= 1) balanceSymbol = "ğŸ˜Œ ç©©å®š";
        else if (lf_hf >= 0.5) balanceSymbol = "ğŸ± å¾®æ”¾é¬†";
        else balanceSymbol = "ğŸˆ æ·±åº¦æ”¾é¬†";
      }

      // ç”Ÿç†ç–²å‹
      let fatigueSymbol = "â“";
      if (sdnn !== null && !isNaN(sdnn)) {
        if (sdnn < 20) fatigueSymbol = "ğŸ’€ éå¸¸ç–²æ†Š";
        else if (sdnn < 30) fatigueSymbol = "ğŸ˜ª ç–²å‹";
        else if (sdnn < 50) fatigueSymbol = "ğŸ˜ æ™®é€š";
        else if (sdnn < 70) fatigueSymbol = "ğŸ¥³ æœ‰ç²¾ç¥";
        else fatigueSymbol = "ğŸ’ª ç²¾åŠ›å……æ²›";
      }

      // å¿ƒæƒ…æŒ‡åŒ—é‡
      let moodSymbol = "ğŸš§";
      if (hbr && rr && LF && HF) {
        let moodScore = 0;
        if (hbr > 90) moodScore += 5;
        else if (hbr > 80) moodScore += 4;
        else if (hbr > 70) moodScore += 3;
        else if (hbr > 60) moodScore += 2;
        else moodScore += 1;

        if (rr > 18) moodScore += 5;
        else if (rr > 15) moodScore += 4;
        else if (rr > 12) moodScore += 3;
        else if (rr > 10) moodScore += 2;
        else moodScore += 1;

        const lf_hf_ratio = LF / HF;
        if (lf_hf_ratio > 2) moodScore += 5;
        else if (lf_hf_ratio > 1.5) moodScore += 4;
        else if (lf_hf_ratio > 1) moodScore += 3;
        else if (lf_hf_ratio > 0.5) moodScore += 2;
        else moodScore += 1;

        if (moodScore >= 14) moodSymbol = "ğŸ”¥ é«˜åº¦ç„¦èº";
        else if (moodScore >= 12) moodSymbol = "ğŸ˜  ç·Šç¹ƒ";
        else if (moodScore >= 9) moodSymbol = "ğŸ’ª å°ˆæ³¨";
        else if (moodScore >= 5) moodSymbol = "ğŸ˜Œ å¾®æ”¾é¬†";
        else moodSymbol = "ğŸ˜´ æ²‰éœ";
      }

      // è¡€å£“æ°£çƒ
      let pressureSymbol = "â“";
      if (sbp !== null && dbp !== null) {
        if (sbp > 145 || dbp > 95) pressureSymbol = "ğŸ’¥ é«˜å¼µæ°£çƒ";
        else if (sbp >= 130 || dbp >= 85)
          pressureSymbol = "ğŸ’¨ åé«˜æ°£çƒ";
        else if (sbp >= 110 && sbp <= 129 && dbp >= 70 && dbp <= 84)
          pressureSymbol = "ğŸˆ ç©©å®šæ°£çƒ";
        else if (sbp >= 95 && dbp >= 60)
          pressureSymbol = "ğŸ’§ å¾®ä½æ°£çƒ";
        else pressureSymbol = "ğŸ’¦ æ´©æ°£æ°£çƒ";
      }

      // é¡¯ç¤ºèªæ„æ‘˜è¦
      const semanticBlock = `<hr><strong>å€‹äººåŒ–èº«å¿ƒå›é¥‹æ‘˜è¦ï¼š</strong><br>
         ğŸ± è‡ªå¾‹ç¥ç¶“å¹³è¡¡ç‹€æ…‹ï¼š${balanceSymbol}<br>
         ğŸ§‘ğŸ» ç”Ÿç†ç–²å‹ç¨‹åº¦ï¼š${fatigueSymbol}<br>
         ğŸ§  å¿ƒæƒ…æŒ‡åŒ—é‡ï¼š${moodSymbol}<br>
         ğŸˆ è¡€å£“æ°£çƒç‹€æ…‹ï¼š${pressureSymbol}<br>`;

      // æª¢æ¸¬å ±å‘Šæ ¼å¼åŒ–
      const reportBlock = `<hr><strong>æª¢æ¸¬å ±å‘Šï¼š</strong><br>
        å¿ƒç‡: ${hbr !== null && !isNaN(hbr) ? hbr + " bpm" : "--"}<br>
        RMSSD: ${
          hrv.RMSSD !== undefined && hrv.RMSSD !== null
            ? hrv.RMSSD + " ms"
            : "--"
        }<br>
        SDNN: ${
          sdnn !== null && !isNaN(sdnn) ? sdnn + " ms" : "--"
        }<br>
        LF: ${LF !== null && !isNaN(LF) ? LF : "--"}<br>
        HF: ${HF !== null && !isNaN(HF) ? HF : "--"}<br>
        LF/HF: ${
          lf_hf !== null && !isNaN(lf_hf) ? lf_hf.toFixed(2) : "--"
        }<br>
        è¡€å£“: ${
          sbp !== null && dbp !== null
            ? sbp + "/" + dbp + " mmHg"
            : "--"
        }<br>
        è¡€æ°§: ${
          spo2 !== undefined && spo2 !== null && spo2 !== "--"
            ? spo2 + "%"
            : "--"
        }<br>
        å‘¼å¸é »ç‡: ${
          rr !== null && !isNaN(rr) ? rr + " æ¬¡/åˆ†é˜" : "--"
        }<br>
        å¿ƒæˆ¿é¡«å‹• (AF): ${
          af !== undefined && af !== null && af !== "--" ? af : "--"
        }<br>
        è¡¨æƒ…åˆ†æ (FA): ${
          fa !== undefined && fa !== null && fa !== "--" ? fa : "--"
        }<br>`;

      // é¡¯ç¤ºåˆ° logs
      // document.getElementById("logs").innerText =
      //   semanticBlock + reportBlock;
      aiAnalysing.value = false; // åˆ†æå®Œç•¢è‡ªå‹•éš±è—

      // å–å¾— userData
      const userData = JSON.parse(
        localStorage.getItem("userData") || "{}"
      );

      // çµ„åˆ HRV3Save åƒæ•¸
      const hrv3Payload = {
        MID: userData.MID || "",
        MAID: userData.MAID || "",
        Token: userData.Token || "",
        Mobile: userData.Mobile || "",
        UID: userData.UID || "", // è‹¥æ²’æœ‰ UID å°±å‚³ ""
        HRVCalTime: userData.HRVCalTime || "",
        Flag: "", // ä¾éœ€æ±‚å¡« "1"ã€"2"ã€"3" æˆ– ""
        hbr: hbr?.toString() || "",
        rmssd: hrv.RMSSD?.toString() || "",
        sdnn: sdnn?.toString() || "",
        lf: LF?.toString() || "",
        hf: HF?.toString() || "",
        lf_hf: lf_hf?.toString() || "",
        sbp: sbp?.toString() || "",
        dbp: dbp?.toString() || "",
        spo2: spo2?.toString() || "",
        af: af?.toString() || "",
        rr: rr?.toString() || "",
        fa: fa?.toString() || "",
      };

      // å‘¼å« HRV3Save API
      const saveResult = await saveHRV3ToServer(hrv3Payload);
      if (saveResult && saveResult.AID) {
        window.location.href = `/vital/finish.html?AID=${encodeURIComponent(saveResult.AID)}`;
      } else {
        window.location.href = "/vital/finish.html";
      }

    } catch (e) {
      aiAnalysing.value = false;
      console.error("è§£æéŒ¯èª¤:", e);
    }
  } catch (err) {
    aiAnalysing.value = false;
    console.error("API éŒ¯èª¤:", err);
    alert(err.message);
  }
} 