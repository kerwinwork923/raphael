<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>智平衡健康複利系統發表會</title>
  <style>
    :root{
      --deep:#0f3b3b;
      --gold:#c9a14a;
      --muted:#6b7280;
      --ink:#1f2a37;
      --bg:#ffffff;
      --card:#ffffff;
      --line:rgba(201,161,74,.35);
  
      --radius:18px;
      --radius-sm:14px;
      --shadow:0 12px 36px rgba(17,24,39,.08);
      --shadow-strong:0 20px 60px rgba(0,0,0,.25);
      --focus:0 0 0 4px rgba(201,161,74,.14);
    }
  
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"PingFang TC","Microsoft JhengHei",system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.8;
    }
    a{color:inherit}
    img,iframe{max-width:100%;display:block}
  
    /* ===== Layout ===== */
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 70px;}
    .container{max-width:1100px;margin:0 auto;}
    .section{padding:50px 20px;}
    @media (max-width:640px){
      .section{padding:34px 16px;}
    }
  
    /* ===== Header ===== */
    header{
      text-align:center;
      padding:88px 16px 34px;
    }
    header .brand{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
    header h1{
      font-size:clamp(44px,6.2vw,74px);
      font-weight:900;
      letter-spacing:2px;
      line-height:1.18;
      color:var(--deep);
    }
    header .divider{
      width:190px;
      height:4px;
      background:var(--gold);
      border-radius:999px;
      margin-top:6px;
    }
    header .subtitle{
      max-width:920px;
      color:var(--muted);
      font-size:18px;
      line-height:1.65;
      margin-top:6px;
    }
  
    /* ===== Cards ===== */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card-pad{padding:22px 22px 24px;}
    .card-media{overflow:hidden;}          /* 影片卡：需要裁切圓角 */
    .card-media .card-pad{padding:22px 22px 24px;}
  
    .kicker{
      color:var(--deep);
      font-weight:900;
      font-size:18px;
      margin-bottom:8px;
    }
    .sub{color:var(--muted);font-size:15px;}
  
    /* ===== Title ===== */
    .title{
      font-size:clamp(22px,3vw,28px);
      text-align:center;
      color:var(--deep);
      margin-bottom:18px;
      position:relative;
    }
    .title::after{
      content:"";
      display:block;
      width:120px;
      height:3px;
      background:linear-gradient(90deg,transparent,var(--gold),transparent);
      margin:10px auto 0;
      border-radius:2px;
    }
    #form h3{
      max-width:920px;
      margin:8px auto 0;
      color:var(--muted);
      font-weight:700;
      line-height:1.7;
      font-size:16px;
      text-align:left;
    }
    @media (max-width:640px){
      #form h3{font-size:15px;}
    }
  
    /* ===== Pills / Tags ===== */
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--deep);
      font-weight:800;
      font-size:14px;
      background:rgba(201,161,74,.08);
      margin-top:10px;
    }
  
    /* ===== Video ===== */
    .video-wrap{border-top:1px solid rgba(0,0,0,.05);}
    .video{
      width:100%;
      aspect-ratio:16/9;
      border:0;
      background:#000;
    }
  
    /* ===== CTA button ===== */
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      font-weight:900;
      border-radius:999px;
      transition:.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{
      background:var(--gold);
      color:#fff;
      border:2px solid var(--gold);
      padding:12px 18px;
    }
    .btn-primary:hover{filter:brightness(.98)}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent;
      color:var(--gold);
      border:2px solid var(--gold);
      padding:10px 16px;
    }
  
    .cta-btn{ /* 兼容你原本 class */
      background:var(--gold);
      color:#fff;
      border:2px solid var(--gold);
      padding:11px 18px;
      border-radius:999px;
      font-weight:900;
      display:inline-block;
      text-decoration:none;
      transition:.2s;
      margin-top:14px;
    }
    .cta-btn:hover{background:transparent;color:var(--gold);}
  
    /* ===== Bullets ===== */
    .bullets{
      margin-top:14px;
      list-style:none;
      padding:0;
    }
    .bullets li{
      padding:10px 0 10px 22px;
      border-bottom:1px dashed var(--line);
      position:relative;
      font-size:15px;
    }
    .bullets li:last-child{border-bottom:none}
    .bullets li::before{
      content:"◆";
      position:absolute;
      left:0;
      top:10px;
      color:var(--gold);
    }
  
    /* ===== Form ===== */
    form{margin-top:12px;}
    .form-card{
      max-width:920px;
      margin:18px auto 0;
      padding:26px;
    }
    @media (max-width:640px){
      .form-card{padding:18px;}
    }
  
    .form-field{margin:0 0 16px;}
    .form-field:last-of-type{margin-bottom:10px;}
  
    .req{color:#c0392b;font-weight:900;}
  
    .form-field label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:0 0 8px;
      font-weight:900;
      letter-spacing:.5px;
    }
  
    .form-card input,
    .form-card textarea{
      width:100%;
      padding:14px 14px;
      border-radius:var(--radius-sm);
      border:1px solid rgba(17,24,39,.14);
      font-size:16px;
      outline:none;
      background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    .form-card textarea{
      resize:vertical;
      min-height:140px;
      line-height:1.6;
    }
    .form-card input:focus,
    .form-card textarea:focus{
      border-color:rgba(201,161,74,.95);
      box-shadow:var(--focus);
    }
  
    .form-actions{
      margin-top:14px;
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .note{color:var(--muted);font-size:13px;}
  
    .btn-submit{
      background:var(--gold);
      color:#fff;
      font-weight:900;
      padding:14px 22px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      transition:.2s;
      min-height:50px;
      width:100%; /* 表單主按鈕滿版 */
    }
    .btn-submit:hover{filter:brightness(.98)}
    .btn-submit:active{transform:translateY(1px)}
    .btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .pad{ padding:22px 22px 24px; }
    
  
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  
    /* ===== Footer ===== */
    footer{
      margin-top:60px;
      text-align:center;
      padding:40px 10px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:14px;
      background:linear-gradient(135deg,rgba(201,161,74,.07),rgba(255,255,255,0));
    }
  </style>
  
</head>
<body>

  <header>
    <div class="brand">
      <h1>智平衡健康複利系統發表會</h1>
      <div class="divider"></div>
      <div class="subtitle">
        健康為什麼不該只靠意志力，而是一套能被監測、被理解、被調整，並能長期累積的系統。
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- 精華版 -->
    <section class="section card">
      <div class="pad">
        <div class="kicker">50 秒抓到關鍵：AI 系統 × 穿戴監測 × 專業團隊遠端調整 × 健康複利。</div>
      </div>
      <div class="video-wrap">
        <!-- TODO: 換成你的精華版 YouTube 影片 ID -->
          <iframe class="video"
          src="https://www.youtube.com/watch?v=EMfVVEGOml0" data-video-id="video011"  
          title="智平衡健康複利系統發表會｜精華版" allowfullscreen></iframe>
      </div>
      <div>
        <button class="gift cta-btn" type="button">
         前往觀看完整版 
        </button>
      </div>
    </section>

    <footer>© 2026 智平衡健康集團 — 感謝您一直以來的信任。</footer>
  </main>

<script>
/** === 設定 === */
const SURVEY_POST_URL = "https://23700999.com:8081/HMA/000TTEMemberChannelSurvey.jsp"; // ← 換成你的問卷紀錄 API";
const REGISTER_POST_URL = "https://23700999.com:8081/HMA/000TTEonlineRegister.jsp"; // ← 換成你的問卷紀錄 API";
const API_LOG_EVENT = "https://23700999.com:8081/HMA/000TTELOG_EVENT.jsp";
const STORAGE_EVENTS_KEY  = "videoEvents";   // 事件流水帳（可選）
const STORAGE_WATCHED_KEY = "watchedVideos"; // 完成清單（可選）
const EventType="viponlineshow";
let vipId = new URLSearchParams(location.search).get("vip") || "unknown";
let EventCode="";
console.log("vipId="+vipId);
logEvent("leadingpage", EventType);

async function logEvent(Event, EventType) {
    const payload = {SafeKey:"qrt897hpmd", VIP: vipId, Event, EventType} ;
    console.log("payload1="+JSON.stringify(payload, null, 1));
       // 1) 先嘗試 sendBeacon（POST，Content-Type: text/plain; charset=UTF-8）
    try {
           const ok = navigator.sendBeacon(API_LOG_EVENT, new Blob(
           [JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }
          ));
          if (ok) {console.info("[logEvent] sendBeacon sent");return;}     
    } catch (e) {
         console.warn("[logEvent] sendBeacon failed, fallback to fetch no-cors", e);
    }
      // 2) fallback: simple request（no-cors + text/plain → 不會 preflight）
    try {
             await fetch(API_LOG_EVENT, {
               method: "POST",
               mode: "no-cors",
               headers: { "Content-Type": "text/plain;charset=UTF-8" }, // 注意：不要 application/json
               body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
               keepalive: true,
               });
              console.info("[logEvent] fetch(no-cors) sent (opaque response)");
        } catch (err) {
             console.error("[logEvent] still failed:", err);
          }
}

const giftBtn = document.querySelector("button.gift");
    if (giftBtn) {
        giftBtn.addEventListener("click", () => {
        // 記錄按鈕點擊事件（可選）
        logEvent("complete_video", EventType);
         // 帶參數跳轉
        //const targetUrl = `https://neuroplus.com.tw/viponline.html?vip=${encodeURIComponent(vipId)}`;
        const targetUrl = `./viponline.html?vip=${encodeURIComponent(vipId)}`;
        window.location.href = targetUrl;
      });
     }


    document.querySelectorAll('a[href="#form"]').forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.preventDefault(); // 阻止預設跳轉行為
        logEvent("click_register", EventType);
    // 2️⃣ 平滑滾動至表單
      const formSection = document.querySelector("#form");
      if (formSection) formSection.scrollIntoView({ behavior: "smooth", block: "start" });

      // ⚠️ 這裡改為 Name（原本是 name）
      const firstInput = document.querySelector('#form input[name="Name"]');
      if (firstInput) setTimeout(() => firstInput.focus({ preventScroll: true }), 400);
  
  });
});

 
/** === 取得使用者ID（優先序：window.USER_ID → URL ?uid → localStorage → VIP碼） === */
function getUserId() {
  if (window.USER_ID && String(window.USER_ID).trim()) return String(window.USER_ID).trim();
  const urlUid = new URLSearchParams(location.search).get("uid");
  if (urlUid) { localStorage.setItem("userId", urlUid); return urlUid; }
  const saved = localStorage.getItem("userId");
  if (saved) return saved;
  // 先回傳暫時ID，若 VIP 之後輸入成功會覆蓋
  const gen = "guest_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("userId", gen);
  return gen;
}
/** ====== 基礎工具：本地事件流水帳（可選） ====== */
function appendLocalEvent(evt) {
  try {
    const arr = JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]");
    arr.push(evt);
    localStorage.setItem(STORAGE_EVENTS_KEY, JSON.stringify(arr));
  } catch {}
}

/** ====== 解析 YouTube URL → 統一轉成可追蹤 embed ====== */
function normalizeYouTubeSrc(src) {
  if (!src) return null;
  const be    = src.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
  const watch = src.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  const embed = src.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
  const ytId = be?.[1] || watch?.[1] || embed?.[1];
  if (!ytId) return null;

  const url = new URL("https://www.youtube-nocookie.com/embed/" + ytId);
  url.searchParams.set("enablejsapi", "1");
  url.searchParams.set("rel", "0");
  url.searchParams.set("modestbranding", "1");
  url.searchParams.set("playsinline", "1");
  url.searchParams.set("origin", location.origin); // ✅ 重要：避免 stateChange 不完整

  return { id: ytId, url: url.toString() };
}

/** ====== 掃描 iframes → 正規化 → 補資料屬性 ====== */
function prepareIframes() {
  const iframes = Array.from(document.querySelectorAll("iframe"));
  let idx = 0;

  for (const el of iframes) {
    const norm = normalizeYouTubeSrc(el.getAttribute("src"));
    if (!norm) continue;

    // 轉成 embed（可追蹤）
    el.src = norm.url;

    // 給 id（YT.Player 需要）
    if (!el.id) el.id = `ytp-${++idx}`;

    // 標題
    let title = el.getAttribute("title") || `video-${idx}`;

    el.dataset.track = "yt";
    el.dataset.title = title;
    el.dataset.youtubeId = norm.id;
    el.dataset.videoId = el.dataset.videoId || norm.id; // 你的商務 id，沒填就用 ytId
  }
}

/** ====== 播放器與旗標 ====== */
const players = {};
const flags = {}; // { [iframeId]: { clicked, sent50, sent100, halfTimer, endTimer } }

/** ====== 100% 完成清單（可選） ====== */
function markWatched(record) {
  try {
    const list = JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]");
    if (!list.find(x => x.videoId === record.videoId)) {
      list.push(record);
      localStorage.setItem(STORAGE_WATCHED_KEY, JSON.stringify(list));
    }
  } catch {}
}

/** ====== 送事件（目前你還是只 console + 本地流水帳；DB 由 logEvent 打） ====== */
function sendProgress({ iframeId, status, player, meta }) {
  const duration = Math.round(player?.getDuration?.() || 0);
  const watched  = Math.round(player?.getCurrentTime?.() || 0);

  const payload = {
    vipId,
    status,                    // click | 50 | 100
    videoId:   meta.videoId,   // 你的商務ID
    youtubeId: meta.youtubeId, // 真正 YT ID
    title:     meta.title,
    watchedSec: watched,
    duration,
    ts: new Date().toISOString(),
  };

  console.log("[sendProgress]", payload);
  appendLocalEvent(payload);

  if (status === "100") markWatched(payload);
}

/** ====== 建立播放器並追蹤 click / 50% / 100% ====== */
function createPlayers() {
  if (!window.YT || !YT.Player) {
    console.warn("[YT] not ready yet");
    return;
  }

  const iframes = Array.from(document.querySelectorAll('iframe[data-track="yt"]'));
  console.log("[YT] found iframes:", iframes.length);

  iframes.forEach((el) => {
    const iframeId = el.id;

    const meta = {
      videoId: el.dataset.videoId,
      youtubeId: el.dataset.youtubeId,
      title: el.dataset.title || el.title || el.dataset.videoId || el.dataset.youtubeId,
    };

    flags[iframeId] = { clicked: false, sent50: false, sent100: false, halfTimer: null, endTimer: null };

    players[iframeId] = new YT.Player(iframeId, {
      events: {
        onReady: () => console.log("[YT ready]", iframeId, meta),
        onError: (err) => console.log("[YT error]", iframeId, err),

        onStateChange: (e) => {
          const state = e.data;
          const player = players[iframeId];

          // ✅ Debug：你會看到 1/2/0
          console.log("[YT state]", iframeId, "state=", state);

          // click（首次播放）
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].clicked) {
            flags[iframeId].clicked = true;
            sendProgress({ iframeId, status: "click", player, meta });
            logEvent("videoPlay_" + meta.videoId, EventType);
          }

          // 50% timer
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].sent50 && !flags[iframeId].halfTimer) {
            flags[iframeId].halfTimer = setInterval(() => {
              try {
                const d = player.getDuration?.() || 0;
                const c = player.getCurrentTime?.() || 0;
                if (d > 0 && c / d >= 0.5 && !flags[iframeId].sent50) {
                  flags[iframeId].sent50 = true;
                  sendProgress({ iframeId, status: "50", player, meta });
                  logEvent("videoPlay50_" + meta.videoId, EventType);

                  clearInterval(flags[iframeId].halfTimer);
                  flags[iframeId].halfTimer = null;
                }
              } catch {}
            }, 1000);
          }

          // ✅ 補強：99% 當作 100%（避免 ENDED 不觸發）
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].sent100 && !flags[iframeId].endTimer) {
            flags[iframeId].endTimer = setInterval(() => {
              try {
                const d = player.getDuration?.() || 0;
                const c = player.getCurrentTime?.() || 0;
                if (d > 0 && c / d >= 0.99 && !flags[iframeId].sent100) {
                  flags[iframeId].sent100 = true;
                  sendProgress({ iframeId, status: "100", player, meta });
                  logEvent("videoPlay100_" + meta.videoId, EventType);

                  clearInterval(flags[iframeId].endTimer);
                  flags[iframeId].endTimer = null;

                  if (flags[iframeId].halfTimer) {
                    clearInterval(flags[iframeId].halfTimer);
                    flags[iframeId].halfTimer = null;
                  }
                }
              } catch {}
            }, 1000);
          }

          // 100%（ENDED）
          if (state === YT.PlayerState.ENDED && !flags[iframeId].sent100) {
            flags[iframeId].sent100 = true;

            if (flags[iframeId].halfTimer) {
              clearInterval(flags[iframeId].halfTimer);
              flags[iframeId].halfTimer = null;
            }
            if (flags[iframeId].endTimer) {
              clearInterval(flags[iframeId].endTimer);
              flags[iframeId].endTimer = null;
            }

            sendProgress({ iframeId, status: "100", player, meta });
            logEvent("videoPlay100_" + meta.videoId, EventType);
          }

          // 暫停時清 endTimer（避免停在中間也被誤判 99%）
          if (state === YT.PlayerState.PAUSED && flags[iframeId].endTimer) {
            clearInterval(flags[iframeId].endTimer);
            flags[iframeId].endTimer = null;
          }
        }
      }
    });
  });
}

/** ====== 啟動 ====== */
document.addEventListener("DOMContentLoaded", () => {
  prepareIframes();

  // ✅ 這頁沒有 wireVipLink()，不要呼叫，不然會直接噴錯把追蹤卡死
  // wireVipLink();

  // 動態載入 YouTube Iframe API
  const s = document.createElement("script");
  s.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
});

window.onYouTubeIframeAPIReady = createPlayers;

/** ====== 開發時工具 ====== */
window.VideoTrack = {
  events()  { return JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]"); },
  watched() { return JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]"); },
  clear()   { localStorage.removeItem(STORAGE_EVENTS_KEY); localStorage.removeItem(STORAGE_WATCHED_KEY); }
};
</script>

</body>
</html>
