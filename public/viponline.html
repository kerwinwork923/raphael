<!DOCTYPE html> 
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>æ™ºå¹³è¡¡å¥åº·è¤‡åˆ©ç³»çµ±ç™¼è¡¨æœƒ</title>
  <style>
    :root{
      --deep:#0f3b3b;
      --gold:#c9a14a;
      --muted:#6b7280;
      --ink:#1f2a37;
      --bg:#ffffff;
      --card:#ffffff;
      --line:rgba(201,161,74,.35);
  
      --radius:18px;
      --radius-sm:14px;
      --shadow:0 12px 36px rgba(17,24,39,.08);
      --shadow-strong:0 20px 60px rgba(0,0,0,.25);
      --focus:0 0 0 4px rgba(201,161,74,.14);
    }
  
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"PingFang TC","Microsoft JhengHei",system-ui,Segoe UI,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.8;
    }
    a{color:inherit}
    img,iframe{max-width:100%;display:block}
  
    /* ===== Layout ===== */
    .wrap{max-width:1100px;margin:0 auto;padding:0 16px 70px;}
    .container{max-width:1100px;margin:0 auto;}
    .section{padding:50px 20px;}
    @media (max-width:640px){
      .section{padding:34px 16px;}
    }
  
    /* ===== Header ===== */
    header{
      text-align:center;
      padding:88px 16px 34px;
    }
    header .brand{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:16px;
    }
    header h1{
      font-size:clamp(44px,6.2vw,74px);
      font-weight:900;
      letter-spacing:2px;
      line-height:1.18;
      color:var(--deep);
    }
    header .divider{
      width:190px;
      height:4px;
      background:var(--gold);
      border-radius:999px;
      margin-top:6px;
    }
    header .subtitle{
      max-width:920px;
      color:var(--muted);
      font-size:18px;
      line-height:1.65;
      margin-top:6px;
    }
  
    /* ===== Cards ===== */
    .card{
      background:var(--card);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
    }
    .card-pad{padding:22px 22px 24px;}
    .card-media{overflow:hidden;}          /* å½±ç‰‡å¡ï¼šéœ€è¦è£åˆ‡åœ“è§’ */
    .card-media .card-pad{padding:22px 22px 24px;}
  
    .kicker{
      color:var(--deep);
      font-weight:900;
      font-size:18px;
      margin-bottom:8px;
    }
    .sub{color:var(--muted);font-size:15px;}
  
    /* ===== Title ===== */
    .title{
      font-size:clamp(22px,3vw,28px);
      text-align:center;
      color:var(--deep);
      margin-bottom:18px;
      position:relative;
    }
    .title::after{
      content:"";
      display:block;
      width:120px;
      height:3px;
      background:linear-gradient(90deg,transparent,var(--gold),transparent);
      margin:10px auto 0;
      border-radius:2px;
    }
    #form h3{
      max-width:920px;
      margin:8px auto 0;
      color:var(--muted);
      font-weight:700;
      line-height:1.7;
      font-size:16px;
      text-align:left;
    }
    @media (max-width:640px){
      #form h3{font-size:15px;}
    }
  
    /* ===== Pills / Tags ===== */
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 14px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--deep);
      font-weight:800;
      font-size:14px;
      background:rgba(201,161,74,.08);
      margin-top:10px;
    }
  
    /* ===== Video ===== */
    .video-wrap{border-top:1px solid rgba(0,0,0,.05);}
    .video{
      width:100%;
      aspect-ratio:16/9;
      border:0;
      background:#000;
    }
  
    /* ===== CTA button ===== */
    .btn{
      appearance:none;
      border:0;
      cursor:pointer;
      font-weight:900;
      border-radius:999px;
      transition:.2s;
      text-decoration:none;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }
    .btn-primary{
      background:var(--gold);
      color:#fff;
      border:2px solid var(--gold);
      padding:12px 18px;
    }
    .btn-primary:hover{filter:brightness(.98)}
    .btn-primary:active{transform:translateY(1px)}
    .btn-ghost{
      background:transparent;
      color:var(--gold);
      border:2px solid var(--gold);
      padding:10px 16px;
    }
  
    .cta-btn{ /* å…¼å®¹ä½ åŸæœ¬ class */
      background:var(--gold);
      color:#fff;
      border:2px solid var(--gold);
      padding:11px 18px;
      border-radius:999px;
      font-weight:900;
      display:inline-block;
      text-decoration:none;
      transition:.2s;
      margin-top:14px;
    }
    .cta-btn:hover{background:transparent;color:var(--gold);}
  
    /* ===== Bullets ===== */
    .bullets{
      margin-top:14px;
      list-style:none;
      padding:0;
    }
    .bullets li{
      padding:10px 0 10px 22px;
      border-bottom:1px dashed var(--line);
      position:relative;
      font-size:15px;
    }
    .bullets li:last-child{border-bottom:none}
    .bullets li::before{
      content:"â—†";
      position:absolute;
      left:0;
      top:10px;
      color:var(--gold);
    }
  
    /* ===== Form ===== */
    form{margin-top:12px;}
    .form-card{
      max-width:920px;
      margin:18px auto 0;
      padding:26px;
    }
    @media (max-width:640px){
      .form-card{padding:18px;}
    }
  
    .form-field{margin:0 0 16px;}
    .form-field:last-of-type{margin-bottom:10px;}
  
    .req{color:#c0392b;font-weight:900;}
  
    .form-field label{
      display:block;
      font-size:13px;
      color:var(--muted);
      margin:0 0 8px;
      font-weight:900;
      letter-spacing:.5px;
    }
  
    .form-card input,
    .form-card textarea{
      width:100%;
      padding:14px 14px;
      border-radius:var(--radius-sm);
      border:1px solid rgba(17,24,39,.14);
      font-size:16px;
      outline:none;
      background:#fff;
      transition:border-color .15s, box-shadow .15s;
    }
    .form-card textarea{
      resize:vertical;
      min-height:140px;
      line-height:1.6;
    }
    .form-card input:focus,
    .form-card textarea:focus{
      border-color:rgba(201,161,74,.95);
      box-shadow:var(--focus);
    }
  
    .form-actions{
      margin-top:14px;
      display:flex;
      align-items:center;
      gap:14px;
      flex-wrap:wrap;
    }
    .note{color:var(--muted);font-size:13px;}
  
    .btn-submit{
      background:var(--gold);
      color:#fff;
      font-weight:900;
      padding:14px 22px;
      border-radius:999px;
      border:0;
      cursor:pointer;
      transition:.2s;
      min-height:50px;
      width:100%; /* è¡¨å–®ä¸»æŒ‰éˆ•æ»¿ç‰ˆ */
    }
    .btn-submit:hover{filter:brightness(.98)}
    .btn-submit:active{transform:translateY(1px)}
    .btn-submit:disabled{opacity:.6;cursor:not-allowed;transform:none;}
    .pad{ padding:22px 22px 24px; }
    
    /* ===== Popup ===== */
    .popup-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.5);
      display:flex;
      align-items:center;
      justify-content:center;
      z-index:1000;
      animation:fadeIn .35s ease forwards;
    }
    .popup{
      background:#fff;
      border:2px solid var(--gold);
      border-radius:var(--radius);
      box-shadow:0 0 40px rgba(201,161,74,.3);
      padding:30px 26px;
      text-align:center;
      max-width:360px;
      width:90%;
      animation:popIn .35s ease forwards;
    }
    .popup h2{
      font-size:20px;
      color:var(--deep);
      margin-bottom:14px;
      font-weight:900;
    }
    .popup p{color:var(--muted);margin-bottom:16px;}
    .popup input{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid rgba(17,24,39,.14);
      font-size:15px;
      text-align:center;
      outline:none;
    }
    .popup input:focus{
      border-color:rgba(201,161,74,.95);
      box-shadow:var(--focus);
    }
    .popup button{
      margin-top:12px;
      width:100%;
      background:var(--gold);
      border:0;
      color:#fff;
      font-weight:900;
      padding:12px 18px;
      border-radius:999px;
      cursor:pointer;
      transition:.2s;
    }
    .popup button:hover{filter:brightness(.98)}
    #errorMsg{
      color:#b94a48;
      font-size:14px;
      display:none;
      margin-top:10px;
      font-weight:800;
    }
  
    @keyframes fadeIn{from{opacity:0}to{opacity:1}}
    @keyframes popIn{from{transform:scale(.9);opacity:0}to{transform:scale(1);opacity:1}}
  
    /* ===== Survey modal ===== */
    .survey-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.5);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:1200;
    }
    .survey-wrap{
      background:#fff;
      border:2px solid var(--gold);
      border-radius:var(--radius);
      box-shadow:var(--shadow-strong);
      width:min(780px,94vw);
      max-height:90vh;
      overflow:auto;
      padding:20px;
    }
    .survey-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      margin-bottom:10px;
    }
    .survey-head h3{margin:0;font-size:18px;color:var(--deep);font-weight:900}
    .survey-close{
      appearance:none;
      border:0;
      background:#eee;
      border-radius:10px;
      padding:6px 10px;
      cursor:pointer;
    }
    .survey-close:hover{background:#e4e4e4}
  
    .survey-wrap fieldset{
      margin:12px 0;
      padding:12px;
      border:1px solid #eee;
      border-radius:12px;
    }
    .survey-wrap legend{padding:0 6px;color:#444;font-weight:900}
  
    .survey-actions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .survey-actions .btn{border:2px solid var(--gold);padding:10px 16px;}
    .survey-actions .btn-primary{background:var(--gold);color:#fff;}
    .survey-actions .btn-ghost{background:transparent;color:var(--gold);}
  
    .survey-toast{
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%);
      background:#111;
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-size:14px;
      display:none;
      z-index:1300;
    }
  
    /* ===== Footer ===== */
    footer{
      margin-top:60px;
      text-align:center;
      padding:40px 10px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:14px;
      background:linear-gradient(135deg,rgba(201,161,74,.07),rgba(255,255,255,0));
    }
  </style>
  
</head>
<body>
  <!-- POP å½ˆçª— -->
  <div class="popup-overlay" id="vipPopup">
    <div class="popup">
      <h2>ğŸ’› æ™ºå¹³è¡¡ VIP å°ˆå±¬é‚€è«‹ ğŸ’›</h2>
      <p>è«‹è¼¸å…¥æ‚¨çš„å°ˆå±¬é‚€è«‹ç¢¼ä»¥é–‹å§‹é«”é©—</p>
      <input type="text" id="vipCode" placeholder="è«‹è¼¸å…¥é‚€è«‹ç¢¼" />
      <button id="confirmBtn">ç¢ºèª</button>
      <p id="errorMsg">é‚€è«‹ç¢¼éŒ¯èª¤ï¼Œè«‹å†è©¦ä¸€æ¬¡</p>
    </div>
  </div>

  <header>
    <div class="brand">
      <h1>æ™ºå¹³è¡¡å¥åº·è¤‡åˆ©ç³»çµ±ç™¼è¡¨æœƒ</h1>
      <div class="divider"></div>
      <div class="subtitle">
        å¥åº·ç‚ºä»€éº¼ä¸è©²åªé æ„å¿—åŠ›ï¼Œè€Œæ˜¯ä¸€å¥—èƒ½è¢«ç›£æ¸¬ã€è¢«ç†è§£ã€è¢«èª¿æ•´ï¼Œä¸¦èƒ½é•·æœŸç´¯ç©çš„ç³»çµ±ã€‚
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- å®Œæ•´ç‰ˆ -->
    <section id="full" class="section card">
      <div class="pad">
        <div class="kicker">æ™ºå¹³è¡¡å¥åº·è¤‡åˆ©ç³»çµ±ç™¼è¡¨æœƒï½œå®Œæ•´ç‰ˆ</div>
        <div class="sub">å®Œæ•´èªªæ¸…æ¥šï¼šç‚ºä»€éº¼ã€Œä¿®å¾©ã€å¯ä»¥è¢«ç³»çµ±åŒ–ï¼Œå¦‚ä½•ç”¨æ•¸æ“šæŠŠå¥åº·è®Šæˆå¯ç´¯ç©ã€å¯å„ªåŒ–çš„è·¯å¾‘ã€‚</div>
        <ul class="bullets">
          <li>AI ç³»çµ±æŒçºŒç†è§£ä½ çš„èº«é«”ç‹€æ…‹</li>
          <li>ç©¿æˆ´å¼è£ç½®æ”¶é›†é—œéµæ•¸æ“šï¼Œè®“å¥åº·ä¸å†åªé æ„Ÿè¦º</li>
          <li>ç”±å°ˆæ¥­åœ˜éšŠé ç«¯èª¿æ•´ï¼Œè®“æ¯ä¸€æ¬¡éƒ½èƒ½ç´¯ç©æˆè¤‡åˆ©</li>
        </ul>
      </div>
      <div class="video-wrap">
        <!-- TODO: æ›æˆä½ çš„å®Œæ•´ç‰ˆ YouTube å½±ç‰‡ ID -->
          <iframe class="video"
          src="https://www.youtube.com/watch?v=tRTzqzDw1Jw" data-video-id="video012"  
          title="æ™ºå¹³è¡¡å¥åº·è¤‡åˆ©ç³»çµ±ç™¼è¡¨æœƒï½œå®Œæ•´ç‰ˆ" allowfullscreen></iframe>
      </div>
    </section>

    <section id="form" class="section container">
      <h2 class="title">æœƒå“¡å°ˆå±¬å„ªæƒ ï½œå„ªæƒ åªåˆ° 2026/01/15</h2>
      <h3>ç«‹å³ç•™ä¸‹å§“åèˆ‡é›»è©±ï¼Œæˆ‘å€‘å°‡ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼Œå”åŠ©æ‚¨äº†è§£æœå‹™èˆ‡åˆé©çš„è·¯å¾‘ã€‚</h3>
      <form class="card form-card" onsubmit="submitForm(event)">
        <div class="form-field">
          <label>å§“å <span class="req">*</span></label>
          <input type="text" name="Name" required placeholder="è«‹è¼¸å…¥æ‚¨çš„å§“å" />
        </div>
      
        <div class="form-field">
          <label>æ‰‹æ©Ÿ</label>
          <input type="tel" name="Phone" placeholder="0912345678" />
        </div>
      
        <div class="form-field">
          <label>å…¶ä»–éœ€æ±‚æˆ–å‚™è¨»</label>
          <textarea name="Note" rows="5" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œè«‹å‘Šè¨´æˆ‘å€‘..."></textarea>
        </div>
      
        <div class="form-actions">
          <button type="submit" class="btn-submit">ç¢ºèªé€å‡º</button>
          <div class="note">é€å‡ºå¾Œå°‡ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼ˆä¸æœƒå…¬é–‹æ‚¨çš„è³‡æ–™ï¼‰</div>
        </div>
      
        <div id="ok" style="display:none;margin-top:12px;color:#2b9348;font-weight:700;text-align:center;">âœ“ å ±åæˆåŠŸï¼å·²å¯„å‡ºç¢ºèªä¿¡ã€‚</div>
      </form>
      
    </section>


    <!-- æœƒå“¡å°ˆå±¬å„ªæƒ  + ç•™è³‡æ–™ -->
    <!-- <section class="section card">
      <div class="pad">
        <div class="kicker">æœƒå“¡å°ˆå±¬å„ªæƒ ï½œå„ªæƒ åªåˆ° 2026/01/15</div>
        <div class="sub">ç«‹å³ç•™ä¸‹å§“åèˆ‡é›»è©±ï¼Œæˆ‘å€‘å°‡ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼Œå”åŠ©æ‚¨äº†è§£æœå‹™èˆ‡åˆé©çš„è·¯å¾‘ã€‚</div>

        <form id="leadForm" autocomplete="on">
          <div class="row">
            <div>
              <label for="leadName">å§“å</label>
              <input id="leadName" name="name" type="text" placeholder="è«‹è¼¸å…¥å§“å" required />
            </div>
            <div>
              <label for="leadPhone">é›»è©±</label>
              <input id="leadPhone" name="phone" type="tel" placeholder="è«‹è¼¸å…¥é›»è©±" required />
            </div>
            <div class="form-field">
              <label for="leadName">å…¶ä»–éœ€æ±‚æˆ–å‚™è¨»</label>
              <textarea name="Note" rows="4" placeholder="å¦‚æœ‰ç‰¹æ®Šéœ€æ±‚ï¼Œè«‹å‘Šè¨´æˆ‘å€‘...">
              </textarea>
            </div>
          </div>
          <div class="submit">
            <button type="submit">ç«‹å³ç•™ä¸‹è¯ç¹«æ–¹å¼</button>
            <span class="note">é€å‡ºå¾Œå°‡ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ï¼ˆä¸æœƒå…¬é–‹æ‚¨çš„è³‡æ–™ï¼‰</span>
          </div>

          <div class="toast" id="toast">å·²æ”¶åˆ°ï¼æˆ‘å€‘å°‡ç›¡å¿«ç”±å°ˆäººèˆ‡æ‚¨è¯ç¹«ã€‚</div>
        </form>
      </div>
    </section>-->


    <div class="survey-overlay" id="surveyOverlay" aria-hidden="true">
      <div class="survey-wrap" role="dialog" aria-modal="true" aria-labelledby="surveyTitle">
        <div class="survey-head">
          <h3 id="surveyTitle">å¡«å¯«å•å·</h3>
          <button class="survey-close" type="button" aria-label="é—œé–‰" id="surveyClose">é—œé–‰</button>
        </div>
    
        <form id="dynamic-form">
          <!-- éš±è—æ¬„ä½ï¼šè‡ªå‹•æ³¨å…¥ -->
          <input type="hidden" name="userId">
          <input type="hidden" name="videoId">
          <input type="hidden" name="youtubeId">
          <input type="hidden" name="title">
          <input type="hidden" name="openedAt">
          <input type="hidden" name="pageUrl" value="">
          <input type="hidden" name="sessionId" value="">
          <input type="hidden" name="surveyKey" value="">
          <!-- å•å·ä¸»é«”æœƒæ’å…¥åˆ°é€™è£¡ -->
          <div id="surveyQuestions" aria-live="polite"></div>
    
          <div class="survey-actions">
            <button type="button" class="btn btn-ghost" id="surveyCancel">å–æ¶ˆ</button>
            <button type="submit" class="btn btn-primary" aria-label="é€å‡ºå•å·">é€å‡ºå•å·</button>
          </div>
        </form>
      </div>
    </div>
    <div class="survey-toast" id="surveyToast" role="status" aria-live="polite">å·²é€å‡ºï¼Œæ„Ÿè¬ä½ çš„å›è¦†ï¼</div>
    <footer>Â© 2025 æ™ºå¹³è¡¡å¥åº·é›†åœ˜ â€” æ„Ÿè¬æ‚¨ä¸€ç›´ä»¥ä¾†çš„ä¿¡ä»»ã€‚</footer>
  </main>

<script>
/** === è¨­å®š === */
const SURVEY_POST_URL = "https://23700999.com:8081/HMA/000TTEMemberChannelSurvey.jsp"; // â† æ›æˆä½ çš„å•å·ç´€éŒ„ API";
const REGISTER_POST_URL = "https://23700999.com:8081/HMA/000TTEonlineRegister.jsp"; // â† æ›æˆä½ çš„å•å·ç´€éŒ„ API";
const API_LOG_EVENT = "https://23700999.com:8081/HMA/000TTELOG_EVENT.jsp";
const STORAGE_EVENTS_KEY  = "videoEvents";   // äº‹ä»¶æµæ°´å¸³ï¼ˆå¯é¸ï¼‰
const STORAGE_WATCHED_KEY = "watchedVideos"; // å®Œæˆæ¸…å–®ï¼ˆå¯é¸ï¼‰
const EventType="viponline";
let vipId = new URLSearchParams(location.search).get("vip") || "unknown";
let EventCode="";
console.log("vipId="+vipId);
logEvent("leadingpage", EventType);

/** VIP è§£é– â†’ æŠŠ code ç•¶ä½œ userId å„²å­˜ï¼ˆè‹¥ä½ è¦ï¼‰ */
function bindVipUnlock() {
  const popup = document.getElementById("vipPopup");
  const btn = document.getElementById("confirmBtn");
  const input = document.getElementById("vipCode");
  const error = document.getElementById("errorMsg");
  if (!btn || !input || !popup) return;
  btn.addEventListener("click", () => {
    const code = input.value.trim();
    EventCode = code;
    if (code === "1128") {
      popup.style.display = "none";
      logEvent("1128login_success", EventType);
    } else if (code === "1204") {
      popup.style.display = "none";
      logEvent("1204login_success", EventType);
    } else if (code === "1211") {
      popup.style.display = "none";
      logEvent("1211login_success", EventType);
    } else if (code === "1218") {
      popup.style.display = "none";
      logEvent("1218login_success", EventType);
    } else if (code === "0110") {
      popup.style.display = "none";
      logEvent("0110login_success", EventType);
    } else {
      error.style.display = "block";
      input.value = "";
      logEvent("unlock_failed", EventType);
    }
  });
}

async function logEvent(Event, EventType) {
    const payload = {SafeKey:"qrt897hpmd", VIP: vipId, Event, EventType} ;
    console.log("payload1="+JSON.stringify(payload, null, 1));
       // 1) å…ˆå˜—è©¦ sendBeaconï¼ˆPOSTï¼ŒContent-Type: text/plain; charset=UTF-8ï¼‰
    try {
           const ok = navigator.sendBeacon(API_LOG_EVENT, new Blob(
           [JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }
          ));
          if (ok) {console.info("[logEvent] sendBeacon sent");return;}     
    } catch (e) {
         console.warn("[logEvent] sendBeacon failed, fallback to fetch no-cors", e);
    }
      // 2) fallback: simple requestï¼ˆno-cors + text/plain â†’ ä¸æœƒ preflightï¼‰
    try {
             await fetch(API_LOG_EVENT, {
               method: "POST",
               mode: "no-cors",
               headers: { "Content-Type": "text/plain;charset=UTF-8" }, // æ³¨æ„ï¼šä¸è¦ application/json
               body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
               keepalive: true,
               });
              console.info("[logEvent] fetch(no-cors) sent (opaque response)");
        } catch (err) {
             console.error("[logEvent] still failed:", err);
          }
}

async function registerSignup({ Name, Phone, Note}) {
   const payload = {
     SafeKey: "qrt897hpmd",
     VIP: vipId,
     EventCode:EventCode,
     EventType,
     Name, 
     Phone, 
     Note,
   };
   console.log("[registerSignup] payload =", JSON.stringify(payload, null, 2));

  // 1) å…ˆç”¨ sendBeaconï¼ˆä¸å¯è®€å›æ‡‰ï¼Œä½†èƒ½é€é”ï¼‰
  try {
    const ok = navigator.sendBeacon(
      REGISTER_POST_URL,
      new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" })
    );
    if (ok) {
      console.info("[registerSignup] delivered via sendBeacon");
      return { delivered: true, mode: "beacon" };
    }
  } catch (e) {
    console.warn("[registerSignup] sendBeacon failed, fallback to fetch no-cors", e);
  }

  // 2) å†ç”¨ fetch(no-cors)ï¼ˆopaqueï¼Œè¦–ç‚ºé€é”ï¼‰
  try {
    await fetch(REGISTER_POST_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=UTF-8" },
      body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
      keepalive: true,
    });
    console.info("[registerSignup] delivered via fetch(no-cors)");
    return { delivered: true, mode: "no-cors" };
  } catch (err) {
    console.error("[registerSignup] all methods failed:", err);
    return { delivered: false, mode: "no-cors" };
  }
}

    document.querySelectorAll('a[href="#form"]').forEach(btn => {
    btn.addEventListener("click", (e) => {
        e.preventDefault(); // é˜»æ­¢é è¨­è·³è½‰è¡Œç‚º
        logEvent("click_register", EventType);
    // 2ï¸âƒ£ å¹³æ»‘æ»¾å‹•è‡³è¡¨å–®
      const formSection = document.querySelector("#form");
      if (formSection) formSection.scrollIntoView({ behavior: "smooth", block: "start" });

      // âš ï¸ é€™è£¡æ”¹ç‚º Nameï¼ˆåŸæœ¬æ˜¯ nameï¼‰
      const firstInput = document.querySelector('#form input[name="Name"]');
      if (firstInput) setTimeout(() => firstInput.focus({ preventScroll: true }), 400);
  
  });
});

 // ç°¡å–®å½ˆçª—ï¼ˆä¸æƒ³è‡ªè¨‚ UI ä¹Ÿå¯ç”¨ alertï¼‰
 function showSuccess() {
    alert("å ±åæˆåŠŸï¼æœŸå¾…æ‚¨çš„ä¸€èµ·è¨‚è£½å¥åº·å…±å‰µæœªä¾†!");
  }

  function showError(msg = "å ±åå¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚") {
    alert(msg);
  }



async function submitForm(event) {
    event.preventDefault();
    const f = event.target;
    const data = Object.fromEntries(new FormData(f).entries());
    const { Name = "", Phone = "",  Note = "" } = data;
    const btn = f.querySelector('button[type="submit"]');
    const old = btn.textContent;
    btn.disabled = true;
    btn.textContent = "é€å‡ºä¸­â€¦";

    try {
      // äº‹ä»¶ä¸Šå ±ï¼ˆä¸å½±éŸ¿æµç¨‹ï¼‰
      const logP = logEvent("submit_form", EventType);

      // å ±åï¼šå…è¨± CORS / beacon / no-cors ä¸‰ç¨®è·¯å¾‘
      const result = await registerSignup({ Name, Phone, Note });
      await Promise.allSettled([logP]);

      const delivered = !!(result && result.delivered); // â† é˜²æ­¢ undefined
    if (delivered) {
      localStorage.setItem("vip_form", JSON.stringify({ ts: Date.now(), vip: vipId, ...data }));
      showSuccess();
      // f.reset(); // éœ€è¦å°±é–‹
    } else {
      showError();
    }
  } catch (err) {
    console.error("[submitForm] unexpected error:", err);
    showError("ç³»çµ±å¿™ç¢Œä¸­ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
  } finally {
    btn.disabled = false;
    btn.textContent = old;
   }
  }


/** === å–å¾—ä½¿ç”¨è€…IDï¼ˆå„ªå…ˆåºï¼šwindow.USER_ID â†’ URL ?uid â†’ localStorage â†’ VIPç¢¼ï¼‰ === */
function getUserId() {
  if (window.USER_ID && String(window.USER_ID).trim()) return String(window.USER_ID).trim();
  const urlUid = new URLSearchParams(location.search).get("uid");
  if (urlUid) { localStorage.setItem("userId", urlUid); return urlUid; }
  const saved = localStorage.getItem("userId");
  if (saved) return saved;
  // å…ˆå›å‚³æš«æ™‚IDï¼Œè‹¥ VIP ä¹‹å¾Œè¼¸å…¥æˆåŠŸæœƒè¦†è“‹
  const gen = "guest_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("userId", gen);
  return gen;
}

/** === åŸºç¤å·¥å…· === */
function appendLocalEvent(evt) {
  try {
    const arr = JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]");
    arr.push(evt);
    localStorage.setItem(STORAGE_EVENTS_KEY, JSON.stringify(arr));
  } catch {}
}

/** è§£æ YouTube ä¾†æºç‚º { id(ytId), url(å¯è¿½è¹¤embed) } */
function normalizeYouTubeSrc(src) {
  if (!src) return null;
  const be = src.match(/youtu\.be\/([A-Za-z0-9_-]{6,})/);
  const watch = src.match(/[?&]v=([A-Za-z0-9_-]{6,})/);
  const embed = src.match(/\/embed\/([A-Za-z0-9_-]{6,})/);
  const ytId = be?.[1] || watch?.[1] || embed?.[1];
  if (!ytId) return null;
  const url = new URL("https://www.youtube-nocookie.com/embed/" + ytId);
  url.searchParams.set("enablejsapi", "1");
  url.searchParams.set("rel", "0");
  url.searchParams.set("modestbranding", "1");
  url.searchParams.set("playsinline", "1");
  return { id: ytId, url: url.toString() };
}

/** æƒæ iframes â†’ æ­£è¦åŒ– â†’ è£œè³‡æ–™å±¬æ€§ */
function prepareIframes() {
  const iframes = Array.from(document.querySelectorAll("iframe"));
  let idx = 0;
  for (const el of iframes) {
    const norm = normalizeYouTubeSrc(el.getAttribute("src"));
    if (!norm) continue;

    el.src = norm.url;
    if (!el.id) el.id = `ytp-${++idx}`;

    let title = el.getAttribute("title") || `video-${idx}`;
    const card = el.closest(".card, .single-video, .hero");
    const h = card?.querySelector("h3, h4, h2");
    if (h?.textContent) title = h.textContent.trim();

    el.dataset.track    = "yt";
    el.dataset.title    = title;
    el.dataset.youtubeId= norm.id;                 // çœŸæ­£ YouTube ID
    el.dataset.videoId  = el.dataset.videoId || norm.id; // ä½ çš„å•†å‹™IDï¼ˆæœªå¡«å°±ç”¨ ytIdï¼‰
  }
}

/** æ’­æ”¾å™¨&ç‹€æ…‹æ——æ¨™ */
const players = {};
const flags = {}; // { [iframeId]: { clicked, sent50, sent100 } }

/** æ¨™è¨˜ 100% å®Œæˆæ¸…å–®ï¼ˆå¯é¸ï¼‰ */
function markWatched(record) {
  try {
    const list = JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]");
    if (!list.find(x => x.videoId === record.videoId)) {
      list.push(record);
      localStorage.setItem(STORAGE_WATCHED_KEY, JSON.stringify(list));
    }
  } catch {}
}

/** é€äº‹ä»¶çš„çµ±ä¸€å‡½å¼ */
function sendProgress({ iframeId, status, player, meta }) {
  const duration = Math.round(player?.getDuration?.() || 0);
  const watched  = Math.round(player?.getCurrentTime?.() || 0);
  const payload = {
    vipId,
    status,                    // "click" | "50" | "100"
    videoId:   meta.videoId,   // ä½ çš„å•†å‹™ID
    youtubeId: meta.youtubeId, // çœŸæ­£ YT ID
    title:     meta.title,
    watchedSec: watched,
    duration,
    ts: new Date().toISOString()
  };
  console.log("payload1="+JSON.stringify(payload, null, 1));
  //postEvent(payload);
  if (status === "100") {
    markWatched(payload);
  }
}

/** å»ºç«‹æ’­æ”¾å™¨ä¸¦è¿½è¹¤ click / 50% / 100% */
function createPlayers() {
  const iframes = Array.from(document.querySelectorAll('iframe[data-track="yt"]'));
  iframes.forEach((el) => {
    const iframeId = el.id;
    const meta = {
      videoId:   el.dataset.videoId,
      youtubeId: el.dataset.youtubeId,
      title:     el.dataset.title || el.title || el.dataset.videoId || el.dataset.youtubeId
    };
    flags[iframeId] = { clicked: false, sent50: false, sent100: false };

    players[iframeId] = new YT.Player(iframeId, {
      events: {
        onStateChange: (e) => {
          const state  = e.data;
          const player = players[iframeId];

          // clickï¼ˆé¦–æ¬¡æ’­æ”¾ï¼‰
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].clicked) {
            flags[iframeId].clicked = true;
            sendProgress({ iframeId, status: "click", player, meta });
            logEvent("videoPlay_"+el.dataset.videoId, EventType);
          }

          // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡æ˜¯å¦è·¨é 50%
          if (state === YT.PlayerState.PLAYING && !flags[iframeId].sent50) {
            if (!flags[iframeId].halfTimer) {
              flags[iframeId].halfTimer = setInterval(() => {
                try {
                  const d = player.getDuration?.() || 0;
                  const c = player.getCurrentTime?.() || 0;
                  if (d > 0 && c / d >= 0.5 && !flags[iframeId].sent50) {
                    flags[iframeId].sent50 = true;
                    sendProgress({ iframeId, status: "50", player, meta });
                    logEvent("videoPlay50_"+el.dataset.videoId, EventType);
                    clearInterval(flags[iframeId].halfTimer);
                    flags[iframeId].halfTimer = null;
                  }
                } catch {}
              }, 1000);
            }
          }

          // 100%ï¼ˆæ’­æ”¾çµæŸï¼‰
          if (state === YT.PlayerState.ENDED && !flags[iframeId].sent100) {
            flags[iframeId].sent100 = true;
            if (flags[iframeId].halfTimer) {
              clearInterval(flags[iframeId].halfTimer);
              flags[iframeId].halfTimer = null;
            }
            sendProgress({ iframeId, status: "100", player, meta });
            logEvent("videoPlay100_"+el.dataset.videoId, EventType);
          }
        }
      }
    });
  });
}

/** å•Ÿå‹• */
document.addEventListener("DOMContentLoaded", () => {
  prepareIframes();
  bindVipUnlock();
   // è®“ VIP é€£çµå¸¶ä¸Š ?vip=
  wireVipLink();
  const s = document.createElement("script");
  s.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
});
window.onYouTubeIframeAPIReady = createPlayers;



/** ===== å››æ”¯å½±ç‰‡çš„å•å·å®šç¾©ï¼ˆä¾ä½ çš„ data-video-id å°æ‡‰ï¼‰===== */
/** å»ºè­°å°æ‡‰ä¸‹åˆ— 4 æ”¯ï¼š
 *  video003ï¼šé†«å¸«çœŸå¿ƒè©±-1
 *  video004ï¼šé†«å¸«çœŸå¿ƒè©±-2
 *  video005ï¼šæ­£å¿µÃ—èŠ³é¦™Ã—ä¿®å¾©
 *  video006ï¼šä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿é
 * è‹¥ä½ æƒ³ç”¨ youtubeId å°æ‡‰ï¼Œä¹Ÿå¯åœ¨ SURVEY_DEFS ç”¨ key: 'o0yUTESrNkg' é€™ç¨®å¯«æ³•ã€‚
 */
const SURVEY_DEFS = {
  /* é†«å¸«çœŸå¿ƒè©±-1ï¼ˆæ²¿ç”¨ä½ æä¾›çš„Bé¡å•å·ï¼‰ */
  "video003": {
    title: "é†«å¸«çœŸå¿ƒè©±-1ï½œä¸æ˜¯æ§åˆ¶ç—‡ç‹€ï¼Œè€Œæ˜¯æ‰¾å›æºé ­ï¼ˆB é¡å•å·ï¼‰",
    html: `
      <fieldset aria-labelledby="q1" data-role="q1" data-metric="ç†è§£å³°" data-imprint="æ´è¦‹" data-cta="First Visit">
        <legend id="q1">Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q1" value="æˆ‘å€‘ä¸è¦ä¸€ç›´åªé‡å°ç—‡ç‹€ï¼Œæ‡‰è©²æ˜¯å»æ‰¾åŸå› ï¼ŒæŠŠå•é¡Œè§£æ±ºæ‰" required> æˆ‘å€‘ä¸è¦ä¸€ç›´åªé‡å°ç—‡ç‹€ï¼Œæ‡‰è©²æ˜¯å»æ‰¾åŸå› ï¼ŒæŠŠå•é¡Œè§£æ±ºæ‰ã€‚</label><br>
        <label><input type="radio" name="q1" value="è—¥ç‰©åªæ˜¯æŒ–æ±ç‰†è£œè¥¿ç‰†"> è—¥ç‰©åªæ˜¯æŒ–æ±ç‰†è£œè¥¿ç‰†ï¼Œè¶Šè£œè¶Šäº‚ã€‚</label><br>
        <label><input type="radio" name="q1" value="äººé«”æœ¬èº«æœ‰éå¸¸ç²¾å¯†çš„é‹ä½œï¼Œä¸éœ€è¦è¢«éåº¦æ§åˆ¶"> äººé«”æœ¬èº«æœ‰éå¸¸ç²¾å¯†çš„é‹ä½œï¼Œä¸éœ€è¦è¢«éåº¦æ§åˆ¶ã€‚</label><br>
        <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š"> æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q2" data-role="q2" data-metric="æ±ºç­–" data-imprint="è¡Œå‹•æ„åœ–" data-cta="Immediate Conversion">
        <legend id="q2">Q2ï½œä»Šå¤©ä½ æœ€æƒ³å…ˆå®Œæˆå“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q2" value="æ‰¾å‡ºè‡ªå·±é•·æœŸä¸èˆ’æœçš„ã€ŒçœŸæ­£åŸå› ã€" required> æ‰¾å‡ºè‡ªå·±é•·æœŸä¸èˆ’æœçš„ã€ŒçœŸæ­£åŸå› ã€ã€‚</label><br>
        <label><input type="radio" name="q2" value="å˜—è©¦æ¸›å°‘ä¸€ç¨®é•·æœŸæœç”¨çš„è—¥ç‰©ï¼Œä¸¦è§€å¯Ÿè®ŠåŒ–"> å˜—è©¦æ¸›å°‘ä¸€ç¨®é•·æœŸæœç”¨çš„è—¥ç‰©ï¼Œä¸¦è§€å¯Ÿè®ŠåŒ–ã€‚</label><br>
        <label><input type="radio" name="q2" value="å­¸æœƒè¨˜éŒ„ç—‡ç‹€èˆ‡ç”Ÿæ´»ä½œæ¯ä¹‹é–“çš„é—œè¯"> å­¸æœƒè¨˜éŒ„ç—‡ç‹€èˆ‡ç”Ÿæ´»ä½œæ¯ä¹‹é–“çš„é—œè¯ã€‚</label><br>
        <label><input type="radio" name="q2" value="è«®è©¢å°ˆæ¥­é†«å¸«ï¼Œäº†è§£åŠŸèƒ½æ€§å•é¡Œçš„æ ¹æº"> è«®è©¢å°ˆæ¥­é†«å¸«ï¼Œäº†è§£åŠŸèƒ½æ€§å•é¡Œçš„æ ¹æºã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q3" data-role="q3" data-metric="å¯¦è¸" data-imprint="è¡Œå‹•å°è¨˜" data-cta="Repeat Engagement">
        <legend id="q3">Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
        <label><input type="radio" name="q3" value="å¯¦ä½œä¸€æ¬¡ã€Œæ‰¾åŸå› è€Œéæ­¢ç—‡ç‹€ã€çš„å¥åº·æª¢è¦–" required> å¯¦ä½œä¸€æ¬¡ã€Œæ‰¾åŸå› è€Œéæ­¢ç—‡ç‹€ã€çš„å¥åº·æª¢è¦–ã€‚</label><br>
        <label><input type="radio" name="q3" value="é‡æ–°æ•´ç†è‡ªå·±çš„ç”¨è—¥èˆ‡èº«é«”è®ŠåŒ–ç´€éŒ„"> é‡æ–°æ•´ç†è‡ªå·±çš„ç”¨è—¥èˆ‡èº«é«”è®ŠåŒ–ç´€éŒ„ã€‚</label><br>
        <label><input type="radio" name="q3" value="ç·´ç¿’ä¸€å¤©ä¸ä¾è³´æ­¢ç—›è—¥ã€è§€å¯Ÿèº«é«”åæ‡‰"> ç·´ç¿’ä¸€å¤©ä¸ä¾è³´æ­¢ç—›è—¥ã€è§€å¯Ÿèº«é«”åæ‡‰ã€‚</label><br>
        <label><input type="radio" name="q3" value="èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œå¾æºé ­çœ‹ç—…ã€çš„æ–°è§€é»"> èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œå¾æºé ­çœ‹ç—…ã€çš„æ–°è§€é»ã€‚</label>
      </fieldset>
      <fieldset aria-labelledby="q4" data-role="q4" data-metric="å…±å‰µ" data-imprint="ä¿¡ä»»å°è¨˜" data-cta="Referral/Advocacy">
        <legend id="q4">Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
        <label><input type="checkbox" name="q4[]" value="å­¸æœƒå¦‚ä½•æ‰¾å‡ºåŠŸèƒ½æ€§å•é¡Œçš„çœŸæ­£æºé ­"> å­¸æœƒå¦‚ä½•æ‰¾å‡ºåŠŸèƒ½æ€§å•é¡Œçš„çœŸæ­£æºé ­ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="äº†è§£ã€Œèº«é«”è¨Šè™Ÿã€èˆ‡ã€Œè‡ªå¾‹ç¥ç¶“ã€ä¹‹é–“çš„é€£å‹•"> äº†è§£ã€Œèº«é«”è¨Šè™Ÿã€èˆ‡ã€Œè‡ªå¾‹ç¥ç¶“ã€ä¹‹é–“çš„é€£å‹•ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="çœ‹å¯¦ä¾‹"> çœ‹å¯¦ä¾‹ï¼šä¸ç”¨è—¥ä¹Ÿèƒ½æ”¹å–„çš„è‡¨åºŠæ¡ˆä¾‹ã€‚</label><br>
        <label><input type="checkbox" name="q4[]" value="å­¸æœƒå»ºç«‹å±¬æ–¼è‡ªå·±çš„å¥åº·èª¿ç¯€è¨ˆç•«"> å­¸æœƒå»ºç«‹å±¬æ–¼è‡ªå·±çš„å¥åº·èª¿ç¯€è¨ˆç•«ã€‚</label><br>
        <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
      </fieldset>
    `
  },

  /* ä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿éï¼ˆè…¸è…¦è»¸ï¼‰ */
  "video006": {
    title: "è…¦æ´å¤§é–‹ï¼šä½ å¯èƒ½å¾æ²’é€™æ¨£å¤§ä¾¿éï¼ˆè…¸è…¦è»¸è‡ªè©•å•å·ï¼‰",
    html: `
       <fieldset data-role="q1" data-metric="ç†è§£å³°" data-cta="First Visit" data-imprint="ç†è§£">
    <legend>Q1ï½œå“ªä¸€å¥è©±æœ€è®“ä½ æœ‰æ„Ÿï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q1" value="ä½ çš„å¤§è…¦æ„è­˜èˆ‡å¤§è…¸å…¶å¯¦æœ‰é‡å­çš„é—œä¿‚">ã€Œä½ çš„å¤§è…¦çš„æ„è­˜è·Ÿå¤§è…¸å…¶å¯¦æœ‰é‡å­çš„é—œä¿‚ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æ»‘æ‰‹æ©Ÿæœƒè®“å¤§è…¦å’Œè…¸å­åˆ†é›¢">ã€Œæ»‘æ‰‹æ©Ÿçš„æ™‚å€™ï¼Œå¤§è…¦å’Œè…¸å­æ˜¯åˆ†é›¢çš„ï¼Œå„åšå„çš„ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="è§€å¯Ÿè…¸å­çš„å‹•ä½œæœƒè®“æ’ä¾¿æ›´é †">ã€Œç•¶ä½ è§€å¯Ÿè…¸å­çš„å‹•ä½œã€æ”¾æ…¢å‘¼å¸æ™‚ï¼Œæ’ä¾¿æœƒè®Šå¾—å¾ˆé †ã€‚ã€</label><br>
    <label><input type="radio" name="q1" value="æˆ‘é‚„ä¸ç¢ºå®š">æˆ‘é‚„ä¸ç¢ºå®šï¼Œéœ€è¦å†æƒ³æƒ³ã€‚</label>
  </fieldset>

  <fieldset data-role="q2" data-metric="è¡Œå‹•æ±ºç­–" data-cta="Immediate Conversion" data-imprint="è¡Œå‹•">
    <legend>Q2ï½œä»Šå¤©ä½ æœ€æƒ³å…ˆå˜—è©¦å“ªä»¶äº‹ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q2" value="æ’ä¾¿æ™‚ä¸æ»‘æ‰‹æ©Ÿ">æ’ä¾¿æ™‚æš«åœæ»‘æ‰‹æ©Ÿï¼Œå°ˆå¿ƒè§€å¯Ÿå‘¼å¸èˆ‡è…¸é“å‹•ä½œã€‚</label><br>
    <label><input type="radio" name="q2" value="ç·´ç¿’é‡å­è§€å¯Ÿæ³•">æ¯å¤©æ—©ä¸Šç·´ç¿’ 3 åˆ†é˜ã€Œé‡å­è§€å¯Ÿã€èº«é«”ç‹€æ…‹ã€‚</label><br>
    <label><input type="radio" name="q2" value="å»ºç«‹æ’ä¾¿å„€å¼">å›ºå®šæ™‚é–“ã€å›ºå®šå§¿å‹¢åœ°å»ºç«‹æ’ä¾¿å„€å¼æ„Ÿã€‚</label><br>
    <label><input type="radio" name="q2" value="è¨˜éŒ„èº«é«”åæ‡‰">è¨˜éŒ„ä¸€é€±å…§æ’ä¾¿èˆ‡å¿ƒæƒ…è®ŠåŒ–çš„é—œè¯ã€‚</label>
  </fieldset>

  <fieldset data-role="q3" data-metric="ä»»å‹™åŒ–è¡Œå‹•" data-cta="Repeat Engagement" data-imprint="è¡Œå‹•">
    <legend>Q3ï½œé€™é€±ä½ æƒ³æŒ‘æˆ°å“ªå€‹ä»»å‹™ï¼Ÿï¼ˆå–®é¸ï¼‰</legend>
    <label><input type="radio" name="q3" value="è§€å¯Ÿæ’ä¾¿ç¯€å¥">è§€å¯Ÿä¸€æ¬¡å®Œæ•´çš„ã€Œæ”¾ä¸‹æ‰‹æ©Ÿâ†’è§€å¯Ÿâ†’é †åˆ©æ’å‡ºã€éç¨‹ã€‚</label><br>
    <label><input type="radio" name="q3" value="æ¯æ—¥ä¸‰åˆ†é˜è§€å¯Ÿ">æ¯å¤©ä¸‰åˆ†é˜éœåè§€å¯Ÿè…¹éƒ¨èµ·ä¼ã€‚</label><br>
    <label><input type="radio" name="q3" value="æ¸›å°‘å¹²æ“¾ç·´ç¿’">å˜—è©¦åœ¨å¦‚å»æ™‚æ¸›å°‘å¤–åœ¨å¹²æ“¾ï¼Œé«”é©—å·®ç•°ã€‚</label><br>
    <label><input type="radio" name="q3" value="åˆ†äº«é«”é©—">èˆ‡å®¶äººæˆ–æœ‹å‹åˆ†äº«ã€Œèº«é«”æ„è­˜èˆ‡æ’ä¾¿é †æš¢ã€çš„é«”é©—ã€‚</label>
  </fieldset>

  <fieldset data-role="q4" data-metric="å…±å‰µé¡˜æ™¯" data-cta="Referral/Advocacy" data-imprint="ä¿¡ä»»">
    <legend>Q4ï½œä¸‹ä¸€æ”¯å½±ç‰‡ä½ å¸Œæœ›ã€Œå®Œæˆã€å“ªä»¶äº‹ï¼Ÿï¼ˆå¯è¤‡é¸ï¼‰</legend>
    <label><input type="checkbox" name="q4[]" value="ç¤ºç¯„è§€å¯Ÿç·´ç¿’">ç¤ºç¯„ä¸€å€‹ã€Œè§€å¯Ÿè…¸é“èˆ‡å‘¼å¸ã€çš„å¯¦éš›ç·´ç¿’æµç¨‹ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="è§£æè…¸è…¦é€£ç·š">è¬›è§£ã€Œè…¸è…¦è»¸ç·šã€èˆ‡èº«å¿ƒå¥åº·çš„å…·é«”é—œè¯ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æä¾›è‡ªæˆ‘æª¢æ¸¬è¡¨">æä¾›ä¸€ä»½ã€Œè…¸è…¦åŒæ­¥ç‹€æ…‹ã€çš„è‡ªæˆ‘æª¢æ¸¬è¡¨ã€‚</label><br>
    <label><input type="checkbox" name="q4[]" value="æ¢è¨å°ˆæ³¨èˆ‡å¥åº·">è¨è«–ç¾ä»£äººå°ˆæ³¨åŠ›èˆ‡èº«é«”ä¿¡è™Ÿçš„é—œä¿‚ã€‚</label>
    <label>å…¶ä»–ï¼ˆè«‹è£œå……ï¼‰ï¼š<input type="text" name="q4_other" placeholder="è«‹è¼¸å…¥"></label>
  </fieldset>
    `
  }
};

/** ===== å‚³é€ JSONï¼ˆsendBeacon å„ªå…ˆï¼‰ ===== */
function postJSON(url, data) {
  try {
    const ok = navigator.sendBeacon?.(url, new Blob([JSON.stringify(data)], {type:"application/json"}));
    if (ok) return Promise.resolve();
  } catch {}
  return fetch(url, { method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify(data), keepalive:true })
    .then(()=>{}).catch(()=>{});
}

/** ===== UI æ§åˆ¶èˆ‡æ¸²æŸ“ ===== */
const $overlay = document.getElementById("surveyOverlay");
const $form = document.getElementById("dynamic-form");
const $close = document.getElementById("surveyClose");
const $cancel = document.getElementById("surveyCancel");
const $toast = document.getElementById("surveyToast");
const $qhost = document.getElementById("surveyQuestions");
const $title = document.getElementById("surveyTitle");
let _sessionId = (crypto?.randomUUID?.() || ("s_" + Math.random().toString(36).slice(2)));
let _openedMeta = null;

/** ä¾ videoId / youtubeId æ‰¾åˆ°å•å·å®šç¾© */
function resolveSurveyKey(meta) {
  if (SURVEY_DEFS[meta.videoId]) return meta.videoId;
  if (SURVEY_DEFS[meta.youtubeId]) return meta.youtubeId;
  return null;
}

function renderSurvey(meta) {
  const key = resolveSurveyKey(meta);
  const def = key ? SURVEY_DEFS[key] : null;

  // æ³¨å…¥éš±è—æ¬„ä½
  $form.elements["userId"].value = _getUserIdFallback();
  $form.elements["videoId"].value = meta.videoId || meta.youtubeId || "";
  $form.elements["youtubeId"].value = meta.youtubeId || "";
  $form.elements["title"].value = meta.title || document.title;
  $form.elements["openedAt"].value = new Date().toISOString();
  $form.elements["pageUrl"].value = location.href;
  $form.elements["sessionId"].value = _sessionId;
  $form.elements["surveyKey"].value = key || "default";
  logEvent("open_survey_"+key, EventType);
  // æ¸²æŸ“é¡Œç›®
  if (def) {
    $qhost.innerHTML = def.html;
    $title.textContent = `å•å·ï½œ${def.title}`;
  } else {
    // å¾Œå‚™ï¼šè‹¥æœªå®šç¾©ï¼Œé¡¯ç¤ºç°¡ç‰ˆå•å·
    $qhost.innerHTML = `
      <fieldset><legend>Q1ï½œé€™éƒ¨å½±ç‰‡å°ä½ æœ‰å¹«åŠ©å—ï¼Ÿ</legend>
        <label><input type="radio" name="u1" value="YES" required> æ˜¯</label>
        <label><input type="radio" name="u1" value="NO"> å¦</label>
      </fieldset>
      <fieldset><legend>Q2ï½œæƒ³å†çœ‹åˆ°å“ªäº›ä¸»é¡Œï¼Ÿï¼ˆé¸å¡«ï¼‰</legend>
        <input type="text" name="u2_note" placeholder="è¼¸å…¥ä¸»é¡Œâ€¦">
      </fieldset>
    `;
    $title.textContent = `å•å·ï½œ${meta.title || 'å½±ç‰‡å•å·'}`;
  }
}

function openSurvey(meta) {
  _openedMeta = meta;
  renderSurvey(meta);
  $overlay.style.display = "flex";
  $overlay.setAttribute("aria-hidden", "false");
}
function closeSurvey() {
  $overlay.style.display = "none";
  $overlay.setAttribute("aria-hidden", "true");
}

/** ç¶å®šæ‰€æœ‰ .cta æ‰“é–‹å°æ‡‰å•å· */
document.querySelectorAll('a.cta[href="#q"]:not(#goVip)').forEach(a => {
  a.addEventListener("click", (e) => {
    e.preventDefault();
    const meta = getContextFromCTA(a);
    openSurvey(meta);
  });
});


/** é—œé–‰è¡Œç‚º */
$close.addEventListener("click", closeSurvey);
$cancel.addEventListener("click", closeSurvey);
$overlay.addEventListener("click", (e)=>{ if(e.target===$overlay) closeSurvey(); });
document.addEventListener("keydown", (e)=>{ if(e.key==="Escape") closeSurvey(); });

async function SurveySubmit(videoId, youtubeId, answers) {
  const payload = {
    SafeKey: "qrt897hpmd",
    VIP: vipId,
    videoId: videoId,
    youtubeId:youtubeId,
    surveyKey: videoId,
    answers: answers
  };
  console.log("[SurveySubmit] payload =", JSON.stringify(payload, null, 2));

  // 1) å…ˆç”¨ sendBeaconï¼ˆä¸å¯è®€å›æ‡‰ï¼Œä½†èƒ½é€é”ï¼‰
  try {
    const ok = navigator.sendBeacon(
      SURVEY_POST_URL,
      new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" })
    );
    if (ok) {
      console.info("[SurveySubmit] delivered via sendBeacon");
      return { delivered: true, mode: "beacon" };
    }
  } catch (e) {
    console.warn("[SurveySubmit] sendBeacon failed, fallback to fetch no-cors", e);
  }

  // 2) å†ç”¨ fetch(no-cors)ï¼ˆopaqueï¼Œè¦–ç‚ºé€é”ï¼‰
  try {
    await fetch(SURVEY_POST_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=UTF-8" },
      body: new Blob([JSON.stringify(payload)], { type: "text/plain;charset=UTF-8" }),
      keepalive: true,
    });
    console.info("[SurveySubmit] delivered via fetch(no-cors)");
    return { delivered: true, mode: "no-cors" };
  } catch (err) {
    console.error("[SurveySubmit] all methods failed:", err);
    return { delivered: false, mode: "no-cors" };
  }
}




/** é€å‡ºè¡¨å–® â†’ å‘¼å«å•å·ç´€éŒ„ APIï¼ˆç­”æ¡ˆï¼‹idï¼‰+ æ‰“é» survey_submit */
$form.addEventListener("submit", async (evt) => {
  evt.preventDefault();

  // åœç”¨æŒ‰éˆ•é¿å…é‡è¤‡é€å‡º
  const submitBtn = $form.querySelector('button[type="submit"]');
  submitBtn.disabled = true;
  try {
    const fd = new FormData($form);

    // 1) å…ˆæŠŠæ‰€æœ‰æ¬„ä½å–å‡º
    const raw = Object.fromEntries(fd);

    // 2) å°‡è¤‡é¸ï¼ˆname ä»¥ [] çµå°¾ï¼‰æ­£è¦åŒ–æˆé™£åˆ—
    for (const [k] of fd.entries()) {
      if (k.endsWith("[]")) {
        raw[k.slice(0, -2)] = fd.getAll(k);
        delete raw[k];
      }
    }

    // 2.5) çµ±ä¸€ç¬¬4é¡Œæ ¼å¼ï¼šè‹¥æ˜¯å–®é¸çš„ q4ï¼ˆé q4[]ï¼‰ï¼ŒåŒ…æˆé™£åˆ—
    if (
         Object.prototype.hasOwnProperty.call(raw, "q4") &&
         !Array.isArray(raw.q4) &&
         raw.q4 !== undefined &&
         raw.q4 !== ""
        ) {
            // å–®é¸ q4 åŒ…æˆé™£åˆ—
           raw.q4 = [raw.q4];
          // è‹¥æ²’æœ‰ q4_otherï¼Œæˆ–åŸæœ¬å°±ä¸æ˜¯è¤‡é¸å•å· â†’ çµ¦ç©ºå­—ä¸²
           raw.q4_other = "";
        }


    // 3) æŠ½å‡º ID èˆ‡å•å· metaï¼ˆä½ è¦çš„ id éƒ½åœ¨é€™è£¡ï¼‰
    const payloadBase = {
      userId:   raw.userId,
      videoId:  raw.videoId,
      youtubeId: raw.youtubeId,
      surveyKey: raw.surveyKey
    };

    // 4) åªæŠŠã€Œç­”æ¡ˆé¡Œç›®ã€æ”¶é€² answersï¼Œæ’é™¤éš±è— meta æ¬„ä½
    const hiddenKeys = new Set([
      "userId", "videoId", "youtubeId",
      "title", "openedAt", "pageUrl",
      "sessionId", "surveyKey"
    ]);

    const answers = {};
    for (const [k, v] of Object.entries(raw)) {
      if (!hiddenKeys.has(k)) answers[k] = v;
    }

    // 5) çµ„ API è¦é€çš„ JSONï¼ˆç²¾ç°¡ä¹¾æ·¨ï¼‰
    //const surveyPayload = {
    //  ...payloadBase,
    //  answers, // åªåŒ…å«é¡Œç›®ç­”æ¡ˆ
    //};
   
   // console.log("surveyPayload="+JSON.stringify(surveyPayload, null, 2));
    
    // 6) å¯«å…¥ä½ çš„å•å·ç´€éŒ„ API
    // postJSON(SURVEY_POST_URL, surveyPayload);
    await SurveySubmit(raw.videoId, raw.youtubeId, answers);

    // 7)ï¼ˆå¯é¸ï¼‰å†æ‰“ä¸€ç­†è¿½è¹¤äº‹ä»¶ï¼ˆå‰å°è¡Œç‚ºæµç”¨ï¼‰
    logEvent("survey_submit_"+raw.videoId, EventType);
   

    // 8) UI æ”¶å°¾
    closeSurvey();
    $toast.style.display = "block";
    setTimeout(() => { $toast.style.display = "none"; }, 1800);
    $form.reset();

  } catch (err) {
    console.warn("Submit survey failed:", err);
    alert("é€å‡ºå¤±æ•—ï¼Œè«‹å†è©¦ä¸€æ¬¡ã€‚");
  } finally {
    submitBtn.disabled = false;
  }
});


/** ===== å·¥å…·ï¼šå– userIdï¼ˆæ²¿ç”¨æ—¢æœ‰ getUserIdï¼Œå¦å‰‡ fallbackï¼‰===== */
function _getUserIdFallback() {
  try { if (typeof getUserId === "function") return getUserId(); } catch {}
  if (window.USER_ID && String(window.USER_ID).trim()) return String(window.USER_ID).trim();
  const urlUid = new URLSearchParams(location.search).get("uid");
  if (urlUid) { localStorage.setItem("userId", urlUid); return urlUid; }
  const saved = localStorage.getItem("userId");
  if (saved) return saved;
  const gen = "guest_" + Math.random().toString(36).slice(2,10);
  localStorage.setItem("userId", gen);
  return gen;
}

/** ===== å¾ CTA å°±è¿‘æŠ“å½±ç‰‡è³‡è¨Š ===== */
function getContextFromCTA(btn) {
  const card = btn.closest(".card, .single-video, .hero") || document.body;
  const iframe = card.querySelector("iframe");
  const videoId   = iframe?.dataset.videoId || "";
  const youtubeId = iframe?.dataset.youtubeId || (iframe?.src?.match(/(embed\/|v=|youtu\.be\/)([A-Za-z0-9_-]{6,})/)?.[2] || "");
  const titleEl = card.querySelector("h3, h4, h2");
  const title = (titleEl?.textContent || iframe?.title || document.title).trim();
  return { videoId, youtubeId, title, iframe };
}

// è®“ã€Œå‰å¾€VIPç››å®´ã€è‡ªå‹•å¸¶ä¸Š ?vip= åƒæ•¸
function wireVipLink(){
  const a = document.getElementById("goVip") || document.querySelector("#vip a.btn");
  if (!a) return;

  // ç›®æ¨™é é¢
  const target = "./vip1.html";
  // è‹¥ç›®æ¨™æœ¬èº«å·²æœ‰æŸ¥è©¢åƒæ•¸å°±ç”¨ & æ¥çºŒ
  const url = new URL(target, location.href);
  url.searchParams.set("vip", vipId);

  // å¦‚éœ€ä¸€ä½µå¸¶å…¶ä»–åƒæ•¸ï¼ˆä¾‹å¦‚ uidï¼‰ï¼Œå–æ¶ˆä¸‹è¡Œè¨»è§£ï¼š
  // const uid = new URLSearchParams(location.search).get("uid");
  // if (uid) url.searchParams.set("uid", uid);
  a.href = url.toString();
  // é»æ“Šæ™‚æ‰“ä¸€ç­†äº‹ä»¶
  a.addEventListener("click", () => {
    logEvent("goto_vip1", EventType);
  });
}





/** é–‹ç™¼æ™‚å¯ç”¨çš„å°å·¥å…· */
window.VideoTrack = {
  events()  { return JSON.parse(localStorage.getItem(STORAGE_EVENTS_KEY) || "[]"); },
  watched() { return JSON.parse(localStorage.getItem(STORAGE_WATCHED_KEY) || "[]"); },
  clear()   { localStorage.removeItem(STORAGE_EVENTS_KEY); localStorage.removeItem(STORAGE_WATCHED_KEY); }
};
</script>


</body>
</html>
