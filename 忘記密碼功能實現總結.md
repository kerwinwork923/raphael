# 忘記密碼功能實現總結

## 功能概述

當用戶在註冊/登入頁面輸入密碼不正確時，系統會自動顯示忘記密碼選項，並提供完整的密碼重置流程。

## 實現的檔案

### `public/survey/index.html`
- **主要修改**: 添加忘記密碼 modal 和相關功能
- **功能**: 完整的忘記密碼流程實現

## 功能流程

### 1. 觸發條件
當 `API_AA1.jsp` 回傳「密碼不正確」時，系統會：
- 自動顯示忘記密碼 modal
- 預填手機號碼
- 提供密碼重置選項

### 2. 忘記密碼流程（3步驟）

#### 步驟1：輸入手機號碼
- 用戶輸入手機號碼
- 點擊「發送驗證碼」
- 調用 `API_ForgetPassword.jsp`

#### 步驟2：輸入驗證碼
- 用戶輸入5位數驗證碼
- 點擊「驗證」
- 調用 `API_doExamAuthPassword.jsp`

#### 步驟3：重新設定密碼
- 用戶輸入新密碼和確認密碼
- 點擊「確認修改」
- 調用 `API_ChangePassword.jsp`
- 自動登入並跳轉

## API 端點

### 1. 發送忘記密碼驗證碼
- **端點**: `https://23700999.com:8081/HMA/API_ForgetPassword.jsp`
- **方法**: POST
- **參數**:
  ```json
  {
    "Mobile": "0968324056"
  }
  ```
- **回應**:
  ```json
  {
    "MID": "1",
    "Result": "OK"
  }
  ```

### 2. 驗證忘記密碼驗證碼
- **端點**: `https://23700999.com:8081/HMA/API_doExamAuthPassword.jsp`
- **方法**: POST
- **參數**:
  ```json
  {
    "Mobile": "0968324056",
    "D1": "1",
    "D2": "2",
    "D3": "3",
    "D4": "4",
    "D5": "5"
  }
  ```
- **回應**:
  ```json
  {
    "Result": "OK",
    "PASS": "OK"
  }
  ```

### 3. 修改密碼
- **端點**: `https://23700999.com:8081/HMA/API_ChangePassword.jsp`
- **方法**: POST
- **參數**:
  ```json
  {
    "Mobile": "0968324056",
    "Password": "AA7024"
  }
  ```
- **回應**:
  ```json
  {
    "Result": "OK"
  }
  ```

## 實現的功能

### 1. 自動檢測密碼錯誤
```javascript
if (data.Result && data.Result.includes("密碼不正確")) {
  // 顯示忘記密碼選項
  const forgotPasswordModal = document.getElementById("forgot-password-modal");
  if (forgotPasswordModal) {
    forgotPasswordModal.classList.remove("hidden");
    // 預填手機號碼
    const forgotPhoneInput = document.getElementById("forgot-phone");
    if (forgotPhoneInput) {
      forgotPhoneInput.value = mobile;
    }
  }
}
```

### 2. 三步驟流程
- **步驟1**: 輸入手機號碼並發送驗證碼
- **步驟2**: 輸入驗證碼並驗證
- **步驟3**: 重新設定密碼

### 3. 自動登入
密碼修改成功後，系統會：
- 自動調用 `API_AA1.jsp` 進行登入
- 儲存 `surveyUserData` 到 localStorage
- 跳轉到 `csurvey.html`

### 4. 完整的錯誤處理
- 手機號碼格式驗證
- 驗證碼格式驗證
- 密碼長度驗證
- 密碼一致性驗證
- API 錯誤處理

## 用戶體驗

### 1. 無縫觸發
- 當檢測到密碼錯誤時，自動顯示忘記密碼選項
- 預填手機號碼，減少用戶輸入

### 2. 清晰的步驟指引
- 三個步驟的 modal 設計
- 每個步驟都有明確的標題和說明

### 3. 完整的驗證
- 前端表單驗證
- 後端 API 驗證
- 詳細的錯誤訊息

### 4. 自動化流程
- 密碼修改成功後自動登入
- 自動跳轉到目標頁面

## 技術實現

### 1. Modal 設計
- 使用 Tailwind CSS 設計響應式 modal
- 三個步驟的切換邏輯
- 關閉按鈕和重置功能

### 2. API 整合
- 四個 API 端點的完整整合
- 統一的錯誤處理機制
- 詳細的除錯日誌

### 3. 狀態管理
- 全域變數管理 DOM 元素
- 表單狀態重置功能
- 按鈕狀態管理

### 4. 安全性
- 密碼長度驗證（至少8位）
- 密碼一致性驗證
- 驗證碼格式驗證

## 測試建議

### 1. 正常流程測試
- 輸入正確的手機號碼和錯誤密碼
- 完成完整的忘記密碼流程
- 驗證自動登入功能

### 2. 錯誤情況測試
- 輸入錯誤的手機號碼格式
- 輸入錯誤的驗證碼
- 輸入不符合要求的密碼
- 測試 API 錯誤情況

### 3. 邊界情況測試
- 快速重複點擊按鈕
- 在流程中關閉 modal
- 網路中斷情況

這個實現提供了完整的忘記密碼功能，確保用戶在遇到密碼問題時能夠順利重置密碼並繼續使用系統。 