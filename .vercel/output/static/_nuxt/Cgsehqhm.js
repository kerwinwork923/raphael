import{_ as E}from"./Drq3M-sN.js";import{M as J,E as K,r,F as x,j as L,o as W,v as m,x as I,A as G,y as t,N as q,V as X,z as s,S as A,C as h}from"./HfdH-K36.js";import{C as Y}from"./zbPE8Z49.js";import{_ as Z}from"./pZyeaVw3.js";import{u as ee}from"./O0ivr2ua.js";import{u as H}from"./BdfeuyLY.js";import{_ as te}from"./DlAUqK2U.js";import"./DNAPM-2u.js";const oe=""+new URL("cash.ClSbQo-C.svg",import.meta.url).href,le={class:"payWrap"},se={class:"payContentWrap"},ne={class:"payContent"},ae={class:"seleteItemGroup1"},re=["src","alt"],ue={class:"seleteItemGroup1Text"},ie={class:"seleteItemGroup2"},ce={class:"sendMethod"},de={key:0,class:"sendContnet"},ve={class:"sendContnetTitle"},pe={class:"totalPriceGroup"},me={class:"payContent"},Ie={class:"totalPayGroup"},ye={class:"payContent"},ge={class:"payContentTitleGroup"},he={key:0},Ce={class:"payContent payContentCheckout"},De={class:"allPrice"},fe={class:"privacyGroup"},Se={__name:"pay",setup(Ae){const d=J(),Q=K(),n=ee(),u=JSON.parse(localStorage.getItem("userData"));u||d.push("/user");const y=r([]),C=r(0),D=r([]),f=r([]),M=r([]),v=r([]),p=r([]),a=r(null),i=r(null),F=r(null),O=()=>{if(n.selectedCartItems.length===0){console.log("沒有選中的商品，跳轉回購物車"),d.push("/cart/cartList");return}y.value=n.selectedCartItems,C.value=n.selectedTotalAmount,console.log("從 Pinia 載入選中商品:",y.value),console.log("總金額:",C.value),console.log("商品詳細資訊:"),y.value.forEach(o=>{console.log(`商品: ${o.ProductName}, 單價: ${o.Price}, 數量: ${o.Qty}, 小計: ${o.Amount}`)})},P=()=>{if(console.log("更新選擇項目，Pinia 地址ID:",n.selectedAddressId),console.log("更新選擇項目，Pinia 發票ID:",n.selectedInvoiceId),n.selectedAddressId&&v.value.length>0)a.value=v.value.find(o=>String(o.AID)===String(n.selectedAddressId)),console.log("找到選擇的地址:",a.value);else if(v.value.length>0){const o=v.value.sort((e,l)=>new Date(l.CheckTime)-new Date(e.CheckTime));a.value=o[0],console.log("使用預設地址:",a.value)}D.value.length>0&&(F.value=D.value[0]),n.selectedInvoiceId&&p.value.length>0?(i.value=p.value.find(o=>String(o.AID)===String(n.selectedInvoiceId)),console.log("找到選擇的發票:",i.value)):p.value.length>0&&(i.value=p.value[0],console.log("使用預設發票:",i.value))},B=async()=>{var o;try{const{data:e}=await H("https://23700999.com:8081/HMA/api/fr/maGetRelated",{method:"POST",body:{MID:u.MID,Token:u.Token,MAID:u.MAID,Mobile:u.Mobile,Lang:"zhtw"}},"$djEA9-QXcy");if(((o=e.value)==null?void 0:o.Result)==="OK"){const l=e.value;D.value=l.PayList||[],f.value=l.DeliverList||[],M.value=l.ReturnPolicyList||[],v.value=l.CRNameList||[],p.value=l.MInvoiceList||[],console.log("相關資料獲取完成，地址列表:",v.value),console.log("相關資料獲取完成，發票列表:",p.value),P()}}catch(e){console.error("獲取相關資料失敗：",e)}},_=async()=>{O(),await B()};x(()=>[n.selectedAddressId,n.selectedInvoiceId],()=>{console.log("Pinia store 變化 detected"),(v.value.length>0||p.value.length>0)&&P()},{immediate:!0}),x(()=>Q.path,o=>{o==="/cart/pay"&&(console.log("返回結帳頁面，重新載入資料"),_())});const V=L(()=>y.value.reduce((o,e)=>o+parseInt(e.Qty,10),0)),b=L(()=>parseInt(C.value,10).toLocaleString()),z=L(()=>{const o=parseInt(C.value,10)||0,e=o;return console.log(`計算最終總額: 商品總額 ${o}  = ${e}`),e.toLocaleString()}),U=async()=>{var o,e,l,R,N;try{if(!a.value){alert("請選擇寄送地址");return}if(!i.value){alert("請選擇發票類型");return}const k=y.value.map(g=>({ProductID:g.ProductID,Qty:g.Qty})),j=localStorage.getItem("CSAID")||"",$={MID:u.MID,Token:u.Token,MAID:u.MAID,Mobile:u.Mobile,CSAID:j,Lang:"zhtw",Cart:k,freight:"0",DeliverType:((o=f.value[0])==null?void 0:o.Type)||"1",PayType:((e=D.value[0])==null?void 0:e.Type)||"1",ReturnPolicyType:((l=M.value[0])==null?void 0:l.Type)||"1",InvoiceID:i.value.InvoiceID,RName:a.value.RName,RMobile:a.value.RMobile,Address:a.value.Address};console.log("結帳資料:",$);const{data:c}=await H("https://23700999.com:8081/HMA/api/fr/maCheckoutCart",{method:"POST",body:$},"$nnhJC38tDM");if(((R=c.value)==null?void 0:R.Result)==="OK")if(console.log("結帳成功:",c.value),localStorage.removeItem("CSAID"),c.value.SALEID&&(localStorage.setItem("checkoutSALEID",c.value.SALEID),console.log("已儲存 SALEID:",c.value.SALEID)),n.clearCheckoutData(),c.value.htmlForm){const g=decodeURIComponent(c.value.htmlForm);console.log("解碼後的 HTML 表單:",g);const S=document.createElement("div");S.innerHTML=g,S.style.display="none",document.body.appendChild(S);const w=S.querySelector("form");w?(console.log("找到付款表單，準備提交"),localStorage.removeItem("CSAID"),w.submit()):(console.error("未找到付款表單"),alert("付款表單載入失敗"))}else alert("結帳成功！"),localStorage.removeItem("checkoutSALEID"),localStorage.removeItem("CSAID"),d.push("/cart/checkoutSuccess");else console.error("結帳失敗:",c.value),alert(`結帳失敗: ${((N=c.value)==null?void 0:N.Message)||"未知錯誤"}`)}catch(k){console.error("結帳時發生錯誤：",k),alert("結帳時發生錯誤，請稍後再試")}};W(()=>{console.log("結帳頁面 mounted"),_()});const T=r(!1);return(o,e)=>(I(),m("div",le,[G(Z,{visible:T.value,"onUpdate:visible":e[0]||(e[0]=l=>T.value=l)},null,8,["visible"]),G(Y,{title:"結帳",backPath:"/cart/cartList",showCart:!1}),t("div",se,[t("div",ne,[(I(!0),m(q,null,X(y.value,l=>(I(),m("div",{class:"seleteItem",key:l.ProductID},[t("div",ae,[t("img",{src:l.Picture,alt:l.ProductName},null,8,re),t("div",ue,[t("h3",null,s(l.ProductName),1),t("h6",null,"NT$"+s(l.Price),1)])]),t("div",ie,"x"+s(l.Qty),1)]))),128)),e[10]||(e[10]=t("div",{class:"payContentHR"},null,-1)),t("div",ce,[e[7]||(e[7]=t("h5",null,"寄送方式",-1)),t("h6",{onClick:e[1]||(e[1]=l=>A(d).push("/cart/payMethod"))},e[6]||(e[6]=[h("查看更多 "),t("img",{src:E,alt:""},null,-1)]))]),a.value&&f.value.length>0?(I(),m("div",de,[t("div",ve,[t("h5",null,s(f.value[0].Name),1)]),e[8]||(e[8]=t("p",null,"預計 3~5 個工作天",-1)),t("p",null,s(a.value.Address),1),t("p",null,s(a.value.RName)+"．"+s(a.value.RMobile),1)])):(I(),m("div",{key:1,class:"sendContnet",onClick:e[2]||(e[2]=l=>A(d).push("/cart/payMethod"))},e[9]||(e[9]=[t("div",{class:"sendContnetTitle"},[t("h5",null,"宅配")],-1),t("p",null,"請新增寄送地址",-1)]))),e[11]||(e[11]=t("div",{class:"payContentHR"},null,-1)),t("div",pe,[t("h4",null,s(V.value)+"個商品",1),t("h5",null,"NT$"+s(b.value),1)])]),e[18]||(e[18]=t("div",{class:"payContent"},[t("h3",null,"付款方式"),t("h5",null,[t("img",{src:oe,alt:""}),h(" 線上付款 ")])],-1)),t("div",me,[e[13]||(e[13]=t("h3",null,"付款詳情",-1)),t("div",Ie,[e[12]||(e[12]=t("h5",null,"訂單總金額",-1)),t("h6",null,"NT$"+s(b.value),1)])]),e[19]||(e[19]=t("div",{class:"payContent"},[t("h3",null,"退換貨政策"),t("ul",null,[t("li",null,"本商品適用7天鑑賞期"),t("li",null,"商品需保持全新狀態（未經使用、無污損、包裝完整含所有配件）")])],-1)),t("div",ye,[t("div",ge,[e[15]||(e[15]=t("h3",null,"發票類型",-1)),t("h6",{onClick:e[3]||(e[3]=l=>A(d).push("/cart/invoiceType"))},e[14]||(e[14]=[h("查看更多 "),t("img",{src:E,alt:""},null,-1)]))]),i.value?(I(),m("h5",he,s(i.value.Desc22)+" "+s(i.value.Content),1)):(I(),m("h5",{key:1,onClick:e[4]||(e[4]=l=>A(d).push("/cart/invoiceType")),style:{cursor:"pointer"}},"請選擇發票類型"))]),t("div",Ce,[t("div",De,"總付款金額 NT$"+s(z.value),1),t("button",{onClick:U},"結帳")]),t("div",fe,[e[16]||(e[16]=h(" 結帳完成視為已同意 ")),t("span",{onClick:e[5]||(e[5]=l=>T.value=!0),style:{cursor:"pointer",color:"#1fbcb3","text-decoration":"underline"}},"條款與規則"),e[17]||(e[17]=h("。 "))])])]))}},Ne=te(Se,[["__scopeId","data-v-504524c0"]]);export{Ne as default};
